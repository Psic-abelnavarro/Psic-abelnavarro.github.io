import{a as V,b as v,c as P,d as q,g as O,h as D,i as G,o as j,p as z,q as Y}from"./chunk-7VH5JHQP.js";import{Ea as T,G as u,H as g,Ha as N,Ia as L,Ka as I,L as p,La as F,M as r,Ma as $,N as n,O as s,S,U as h,W as l,aa as E,ca as a,da as U,ea as C,g as k,j as y,k as _,l as f,la as R,ma as x,o as d,t as o,w as M,za as A}from"./chunk-IWV4FJLC.js";import"./chunk-X5YLR3NI.js";import{i as b}from"./chunk-ODN5LVDJ.js";var w=class i{supabase;_registering=d(!1);_error=d(null);_success=d(!1);registering=this._registering.asReadonly();error=this._error.asReadonly();success=this._success.asReadonly();constructor(){this.supabase=$(F.supabase.url,F.supabase.anonKey)}registerUser(t){return b(this,null,function*(){try{this._registering.set(!0),this._error.set(null),this._success.set(!1);let{data:e}=yield this.supabase.from("allowed_users").select("id").eq("email",t.email.toLowerCase().trim()).single();if(e)throw new Error("Ya existe un usuario registrado con este email");if(t.username){let{data:H}=yield this.supabase.from("allowed_users").select("id").eq("username",t.username.toLowerCase().trim()).single();if(H)throw new Error("Ya existe un usuario con este nombre de usuario")}let c={email:t.email.toLowerCase().trim(),username:t.username?.toLowerCase().trim(),display_name:t.display_name,role:"guest",permissions:["certificate"],active:!1,notes:t.notes||"Usuario registrado autom\xE1ticamente",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{error:m}=yield this.supabase.from("allowed_users").insert([c]);if(m)throw new Error(`Error en el registro: ${m.message}`);return this._success.set(!0),!0}catch(e){let c=e?.message||"Error durante el registro";return this._error.set(c),!1}finally{this._registering.set(!1)}})}checkEmailAvailability(t){return b(this,null,function*(){try{let{data:e}=yield this.supabase.from("allowed_users").select("id").eq("email",t.toLowerCase().trim()).single();return!e}catch{return!0}})}checkUsernameAvailability(t){return b(this,null,function*(){try{let{data:e}=yield this.supabase.from("allowed_users").select("id").eq("username",t.toLowerCase().trim()).single();return!e}catch{return!0}})}clearError(){this._error.set(null)}clearSuccess(){this._success.set(!1)}static \u0275fac=function(e){return new(e||i)};static \u0275prov=k({token:i,factory:i.\u0275fac,providedIn:"root"})};var Q=()=>["/login"],K=(i,t)=>({"text-success":i,"text-danger":t}),Z=(i,t)=>({"bi-check-circle":i,"bi-x-circle":t});function W(i,t){if(i&1){let e=S();r(0,"div",13),s(1,"i",14),r(2,"div")(3,"strong"),a(4,"\xA1Registro exitoso!"),n(),s(5,"br"),r(6,"small"),a(7,"Tu solicitud ha sido enviada. Un administrador revisar\xE1 y activar\xE1 tu cuenta."),n()()(),r(8,"div",15)(9,"button",16),h("click",function(){_(e);let m=l();return f(m.goToLogin())}),s(10,"i",17),a(11," Ir al Login "),n()()}}function X(i,t){if(i&1&&(r(0,"div",24),a(1),n()),i&2){let e=l(2);o(),C(" ",e.getFieldError("email")," ")}}function ee(i,t){if(i&1&&(r(0,"div",25),s(1,"i",38),a(2),n()),i&2){let e=l(2);p("ngClass",x(3,K,e.emailAvailable(),!e.emailAvailable()&&e.emailCheckMessage())),o(),p("ngClass",x(6,Z,e.emailAvailable(),!e.emailAvailable()&&e.emailCheckMessage())),o(),C(" ",e.emailCheckMessage()," ")}}function te(i,t){if(i&1&&(r(0,"div",24),a(1),n()),i&2){let e=l(2);o(),C(" ",e.getFieldError("username")," ")}}function ie(i,t){if(i&1&&(r(0,"div",25),s(1,"i",38),a(2),n()),i&2){let e=l(2);p("ngClass",x(3,K,e.usernameAvailable(),!e.usernameAvailable()&&e.usernameCheckMessage())),o(),p("ngClass",x(6,Z,e.usernameAvailable(),!e.usernameAvailable()&&e.usernameCheckMessage())),o(),C(" ",e.usernameCheckMessage()," ")}}function re(i,t){if(i&1&&(r(0,"div",24),a(1),n()),i&2){let e=l(2);o(),C(" ",e.getFieldError("display_name")," ")}}function ne(i,t){if(i&1&&(r(0,"div",33),s(1,"i",39),r(2,"div"),a(3),n()()),i&2){let e=l(2);o(3),U(e.error())}}function ae(i,t){i&1&&(s(0,"span",40),a(1," Enviando solicitud... "))}function oe(i,t){i&1&&(s(0,"i",41),a(1," Enviar Solicitud "))}function se(i,t){if(i&1){let e=S();r(0,"form",18),h("ngSubmit",function(){_(e);let m=l();return f(m.onSubmit())}),r(1,"div",19)(2,"div",20)(3,"label",21),a(4," Email "),r(5,"span",22),a(6,"*"),n()(),r(7,"input",23),h("blur",function(){_(e);let m=l();return f(m.checkEmailAvailability())}),n(),u(8,X,2,1,"div",24),u(9,ee,3,9,"div",25),n(),r(10,"div",20)(11,"label",26),a(12," Nombre de Usuario "),r(13,"span",22),a(14,"*"),n()(),r(15,"input",27),h("blur",function(){_(e);let m=l();return f(m.checkUsernameAvailability())}),n(),u(16,te,2,1,"div",24),u(17,ie,3,9,"div",25),n(),r(18,"div",20)(19,"label",28),a(20," Nombre Completo "),r(21,"span",22),a(22,"*"),n()(),s(23,"input",29),u(24,re,2,1,"div",24),n(),r(25,"div",20)(26,"label",30),a(27,"Motivo de la solicitud"),n(),s(28,"textarea",31),r(29,"div",32)(30,"small"),a(31,"Opcional: Ayuda a los administradores a procesar tu solicitud m\xE1s r\xE1pido"),n()()()(),u(32,ne,4,1,"div",33),r(33,"div",34)(34,"button",35),u(35,ae,2,0)(36,oe,2,0),n(),r(37,"button",36),h("click",function(){_(e);let m=l();return f(m.goToLogin())}),s(38,"i",37),a(39," Volver al Login "),n()()()}if(i&2){let e=l();p("formGroup",e.registrationForm),o(7),E("is-invalid",e.hasFieldError("email")),o(),g(e.hasFieldError("email")?8:-1),o(),g(e.emailCheckMessage()?9:-1),o(6),E("is-invalid",e.hasFieldError("username")),o(),g(e.hasFieldError("username")?16:-1),o(),g(e.usernameCheckMessage()?17:-1),o(6),E("is-invalid",e.hasFieldError("display_name")),o(),g(e.hasFieldError("display_name")?24:-1),o(8),g(e.error()?32:-1),o(2),p("disabled",e.registrationForm.invalid||e.registering()||!e.emailAvailable()||!e.usernameAvailable()),o(),g(e.registering()?35:36),o(2),p("disabled",e.registering())}}var B=class i{registrationService=y(w);fb=y(j);router=y(N);registering=this.registrationService.registering;error=this.registrationService.error;success=this.registrationService.success;emailAvailable=d(!0);usernameAvailable=d(!0);emailCheckMessage=d("");usernameCheckMessage=d("");registrationForm;ngOnInit(){this.initializeForm()}initializeForm(){this.registrationForm=this.fb.group({email:["",[v.required,v.email]],username:["",[v.required,v.minLength(3),v.pattern(/^[a-zA-Z0-9_]+$/)]],display_name:["",[v.required,v.minLength(2)]],notes:[""]})}onSubmit(){return b(this,null,function*(){if(this.registrationForm.invalid||!this.emailAvailable()||!this.usernameAvailable()){this.markFormGroupTouched();return}let t=this.registrationForm.value;yield this.registrationService.registerUser(t)})}checkEmailAvailability(){return b(this,null,function*(){let t=this.registrationForm.get("email")?.value;if(!t||this.registrationForm.get("email")?.invalid){this.emailCheckMessage.set("");return}let e=yield this.registrationService.checkEmailAvailability(t);this.emailAvailable.set(e),e?this.emailCheckMessage.set("Email disponible"):this.emailCheckMessage.set("Este email ya est\xE1 registrado")})}checkUsernameAvailability(){return b(this,null,function*(){let t=this.registrationForm.get("username")?.value;if(!t||this.registrationForm.get("username")?.invalid){this.usernameCheckMessage.set("");return}let e=yield this.registrationService.checkUsernameAvailability(t);this.usernameAvailable.set(e),e?this.usernameCheckMessage.set("Nombre de usuario disponible"):this.usernameCheckMessage.set("Este nombre de usuario ya est\xE1 en uso")})}goToLogin(){this.router.navigate(["/login"])}hasFieldError(t){let e=this.registrationForm.get(t);return!!(e?.invalid&&e?.touched)}getFieldError(t){let e=this.registrationForm.get(t);if(e?.invalid&&e?.touched){if(e.errors?.required)return"Este campo es requerido";if(e.errors?.email)return"Email inv\xE1lido";if(e.errors?.minlength)return`M\xEDnimo ${e.errors?.minlength.requiredLength} caracteres`;if(e.errors?.pattern&&t==="username")return"Solo se permiten letras, n\xFAmeros y guiones bajos"}return""}markFormGroupTouched(){Object.keys(this.registrationForm.controls).forEach(t=>{this.registrationForm.get(t)?.markAsTouched()})}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=M({type:i,selectors:[["app-user-registration"]],decls:18,vars:3,consts:[[1,"container-fluid","py-4"],[1,"row","justify-content-center"],[1,"col-sm-10","col-md-8","col-lg-6","col-xl-5"],[1,"card","border-0","shadow-lg"],[1,"card-header","bg-primary","text-white","text-center","py-3"],[1,"mb-0","fw-bold"],[1,"bi","bi-person-plus-fill","me-2"],[1,"mb-0","small","opacity-75"],[1,"card-body","p-4"],[3,"formGroup"],[1,"text-center","mt-3"],[1,"text-muted"],[1,"text-decoration-none",3,"routerLink"],["role","alert",1,"alert","alert-success","d-flex","align-items-center"],[1,"bi","bi-check-circle-fill","me-2"],[1,"text-center"],["type","button",1,"btn","btn-primary",3,"click"],[1,"bi","bi-box-arrow-in-right","me-1"],[3,"ngSubmit","formGroup"],[1,"row","g-3"],[1,"col-12"],["for","email",1,"form-label","fw-semibold"],[1,"text-danger"],["type","email","id","email","formControlName","email","placeholder","tu-email@ejemplo.com",1,"form-control",3,"blur"],[1,"invalid-feedback"],[1,"form-text",3,"ngClass"],["for","username",1,"form-label","fw-semibold"],["type","text","id","username","formControlName","username","placeholder","nombre_usuario",1,"form-control",3,"blur"],["for","display_name",1,"form-label","fw-semibold"],["type","text","id","display_name","formControlName","display_name","placeholder","Tu nombre completo",1,"form-control"],["for","notes",1,"form-label","fw-semibold"],["id","notes","formControlName","notes","rows","3","placeholder","Explica brevemente por qu\xE9 necesitas acceso al sistema...",1,"form-control"],[1,"form-text"],["role","alert",1,"alert","alert-danger","mt-3","d-flex","align-items-center"],[1,"d-grid","gap-2","mt-4"],["type","submit",1,"btn","btn-primary","btn-lg",3,"disabled"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],[1,"bi","bi-arrow-left","me-2"],[1,"bi",3,"ngClass"],[1,"bi","bi-exclamation-triangle-fill","me-2"],["role","status",1,"spinner-border","spinner-border-sm","me-2"],[1,"bi","bi-send","me-2"]],template:function(e,c){e&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div",4)(5,"h4",5),s(6,"i",6),a(7," Registro de Usuario "),n(),r(8,"p",7),a(9,"Solicitar acceso al sistema"),n()(),r(10,"div",8),u(11,W,12,0)(12,se,40,16,"form",9),n()(),r(13,"div",10)(14,"small",11),a(15," \xBFYa tienes cuenta? "),r(16,"a",12),a(17,"Iniciar sesi\xF3n"),n()()()()()()),e&2&&(o(11),g(c.success()?11:12),o(5),p("routerLink",R(2,Q)))},dependencies:[T,A,z,O,V,P,q,Y,D,G,I,L],styles:[".card[_ngcontent-%COMP%]{border-radius:12px;overflow:hidden}.card-header[_ngcontent-%COMP%]{border:none}.form-control[_ngcontent-%COMP%]:focus{border-color:var(--bs-primary);box-shadow:0 0 0 .2rem rgba(var(--bs-primary-rgb),.25)}.btn[_ngcontent-%COMP%]{border-radius:8px}.alert[_ngcontent-%COMP%]{border-radius:8px;border:none}"]})};export{B as UserRegistrationComponent};
