import{a as E}from"./chunk-MPC7SZEK.js";import{m as L}from"./chunk-EDRQHDMA.js";import{A as c,B as C,C as D,D as O,H as m,Q as R,S as h,V as T,Y as I,Z as f,g as l,j as S,k as u,q as o,r as y}from"./chunk-DCXCOY7M.js";var U=new I("EVENT_REPOSITORY"),P=class b{constructor(e,t){this.authService=e;this.eventRepository=t;this.initializeSearch()}eventsSubject=new l([]);featuredEventsSubject=new l([]);loadingSubject=new l(!1);searchSubject=new l("");filtersSubject=new l({});eventCache=new Map;cacheTimestamp=new Map;CACHE_TTL=5*60*1e3;get events$(){return this.eventsSubject.asObservable()}get featuredEvents$(){return this.featuredEventsSubject.asObservable()}get loading$(){return this.loadingSubject.asObservable()}get searchQuery$(){return this.searchSubject.asObservable()}get filters$(){return this.filtersSubject.asObservable()}getEventById(e,t=!1){return!t&&this.isEventCached(e)?u(this.eventCache.get(e)):(this.setLoading(!0),this.eventRepository.findById(e).pipe(o(r=>{if(!r.success||!r.data)throw new Error(r.error||"Evento no encontrado");return this.updateEventCache(e,r.data),r.data}),c(r=>{throw new Error(r.message||"Error obteniendo evento")}),h(()=>this.setLoading(!1))))}getEventBySlug(e){return this.setLoading(!0),this.eventRepository.findBySlug(e).pipe(o(t=>{if(!t.success||!t.data)throw new Error("Evento no encontrado");return this.updateEventCache(t.data.id,t.data),t.data}),c(t=>{throw new Error(t.message||"Error obteniendo evento")}),h(()=>this.setLoading(!1)))}getEvents(e=1,t=20,r,a={field:"start_date",direction:"asc"}){this.setLoading(!0);let n=this.convertToRepositoryFilters(r,a,e,t);return this.eventRepository.findAll(n).pipe(o(i=>({items:i.items.map(p=>(this.updateEventCache(p.id,p),E.event.toCard(p))),pagination:{currentPage:i.page,totalPages:i.totalPages,totalItems:i.total,itemsPerPage:i.pageSize,hasNextPage:i.hasNextPage,hasPrevPage:i.hasPreviousPage,nextPage:i.hasNextPage?i.page+1:void 0,prevPage:i.hasPreviousPage?i.page-1:void 0}})),c(i=>{throw new Error(i.message||"Error obteniendo eventos")}),h(i=>{this.eventsSubject.next(i.items),this.setLoading(!1)}))}createEvent(e){let t=this.authService.currentUser;if(!t)throw new Error("Usuario no autenticado");if(t.role==="participant")throw new Error("No tienes permisos para crear eventos");let r=this.validateEventData(e);if(r.length>0)throw new Error(r.join(", "));return this.setLoading(!0),this.eventRepository.create(e).pipe(o(a=>{if(!a.success||!a.data)throw new Error(a.error||"Error creando evento");return this.updateEventCache(a.data.id,a.data),a.data}),c(a=>{throw new Error(a.message||"Error creando evento")}),h(()=>this.setLoading(!1)))}createQuickEvent(e){let t=this.authService.currentUser;if(!t)throw new Error("Usuario no autenticado");if(t.role==="participant")throw new Error("No tienes permisos para crear eventos");if(!e.title||e.title.trim().length<5)throw new Error("El t\xEDtulo debe tener al menos 5 caracteres");if(!e.eventTypeId||e.eventTypeId<=0)throw new Error("Tipo de evento requerido");return this.setLoading(!0),this.eventRepository.createQuickEvent(e).pipe(o(r=>{if(!r.success||!r.data)throw new Error(r.error||"Error creando evento r\xE1pido");return this.updateEventCache(r.data.id,r.data),r.data}),c(r=>{throw new Error(r.message||"Error creando evento r\xE1pido")}),h(()=>this.setLoading(!1)))}updateEvent(e,t){if(!this.authService.currentUser)throw new Error("Usuario no autenticado");return this.setLoading(!0),this.eventRepository.update(e,t).pipe(o(a=>{if(!a.success||!a.data)throw new Error(a.error||"Error actualizando evento");return this.updateEventCache(e,a.data),a.data}),c(a=>{throw new Error(a.message||"Error actualizando evento")}),h(()=>this.setLoading(!1)))}deleteEvent(e){if(!this.authService.currentUser)throw new Error("Usuario no autenticado");return this.setLoading(!0),this.eventRepository.delete(e).pipe(o(r=>{if(!r.success)throw new Error(r.error||"Error eliminando evento");return this.removeFromCache(e),!0}),c(r=>{throw new Error(r.message||"Error eliminando evento")}),h(()=>this.setLoading(!1)))}changeEventStatus(e,t){if(!this.authService.currentUser)throw new Error("Usuario no autenticado");let a=this.validateStatusTransition(e,t);if(a)throw new Error(a);return this.setLoading(!0),this.eventRepository.changeStatus(e,t).pipe(o(n=>{if(!n.success||!n.data)throw new Error("Error cambiando estado del evento");return this.updateEventCache(e,n.data),n.data}),c(n=>{throw new Error(n.message||"Error cambiando estado del evento")}),h(()=>this.setLoading(!1)))}publishEvent(e){return this.changeEventStatus(e,"published")}openRegistrations(e){return this.changeEventStatus(e,"reg_open")}closeRegistrations(e){return this.changeEventStatus(e,"reg_closed")}activateEvent(e){return this.changeEventStatus(e,"active")}completeEvent(e){return this.changeEventStatus(e,"completed")}cancelEvent(e,t){let r="cancelled";return this.eventRepository.changeStatus(e,r).pipe(o(a=>{if(!a.success||!a.data)throw new Error("Error cancelando evento");return this.updateEventCache(e,a.data),a.data}),c(a=>{throw new Error(a.message||"Error cancelando evento")}))}initializeSearch(){y([this.searchSubject.pipe(O(300),m()),this.filtersSubject.pipe(m((e,t)=>JSON.stringify(e)===JSON.stringify(t)))]).subscribe(([e,t])=>{(e||Object.keys(t).length>0)&&this.performSearch(e,t)})}setSearchQuery(e){this.searchSubject.next(e)}setFilters(e){this.filtersSubject.next(e)}clearSearch(){this.searchSubject.next(""),this.filtersSubject.next({})}performSearch(e,t){let r=this.convertToRepositoryFilters(t);this.eventRepository.search(e,r).pipe(o(a=>a.map(n=>(this.updateEventCache(n.id,n),E.event.toCard(n)))),c(()=>u([]))).subscribe(a=>{this.eventsSubject.next(a)})}quickSearch(e,t=10){return!e||e.length<3?u([]):this.eventRepository.search(e,{}).pipe(o(r=>r.slice(0,t).map(a=>E.event.toCard(a))),c(()=>u([])))}queryEventsForAutocomplete(e){return this.eventRepository.queryEvents(e).pipe(c(t=>(console.error("Error en autocomplete eventos:",t),u([]))))}preloadEventsForAutocomplete(e=20){let t={limit:e};return this.queryEventsForAutocomplete(t)}getFeaturedEvents(e=6){return this.eventRepository.findFeatured().pipe(o(t=>{let r=t.slice(0,e).map(a=>(this.updateEventCache(a.id,a),E.event.toCard(a)));return this.featuredEventsSubject.next(r),r}),c(()=>u([])))}toggleFeatured(e){let t=this.authService.currentUser;if(!t||t.role!=="admin")throw new Error("No tienes permisos para destacar eventos");return this.eventRepository.findById(e).pipe(R(r=>{if(!r.success||!r.data)throw new Error("Evento no encontrado");let n=!r.data.isFeatured;return this.eventRepository.update(e,{isFeatured:n})}),o(r=>{if(!r.success||!r.data)throw new Error("Error cambiando estado destacado");return this.updateEventCache(e,r.data),r.data}),c(r=>{throw new Error(r.message||"Error cambiando estado destacado")}))}getEventStats(e){return this.eventRepository.getStats(e).pipe(o(t=>({totalRegistrations:t.totalRegistrations||0,confirmedRegistrations:t.confirmedRegistrations||0,attendedCount:t.attendedCount||0,attendanceRate:t.attendanceRate||0,certificatesIssued:t.certificatesIssued||0,certificatesDownloaded:t.certificatesDownloaded||0,certificatesVerified:t.certificatesVerified||0,revenue:t.revenue})),c(()=>u({totalRegistrations:0,confirmedRegistrations:0,attendedCount:0,attendanceRate:0,certificatesIssued:0,certificatesDownloaded:0,certificatesVerified:0})))}getUpcomingEvents(e=10){return this.eventRepository.findUpcoming(e).pipe(o(t=>t.map(r=>E.event.toCard(r))),c(()=>u([])))}getMyEvents(e){let t=e||this.authService.currentUser?.id;return t?this.eventRepository.findByOrganizer(t).pipe(o(r=>r.map(a=>(this.updateEventCache(a.id,a),E.event.toCard(a)))),c(()=>u([]))):u([])}batchOperation(e){let t=this.authService.currentUser;if(!t||t.role==="participant")throw new Error("No tienes permisos para operaciones masivas");this.setLoading(!0);let r=Date.now(),a=e.options?.stopOnError===!0;return S(e.operations).pipe(D(n=>{let i=new Date().toISOString();return n.operation==="create"?this.eventRepository.create(n.data).pipe(o(d=>({success:d.success,data:d.data,error:d.error,timestamp:i}))):n.operation==="update"?n.id?this.eventRepository.update(n.id,n.data).pipe(o(d=>({success:d.success,data:d.data,error:d.error,timestamp:i}))):u({success:!1,error:"ID requerido para update",timestamp:i}):n.operation==="delete"?n.id?this.eventRepository.delete(n.id).pipe(o(d=>({success:d.success,data:void 0,error:d.error,timestamp:i}))):u({success:!1,error:"ID requerido para delete",timestamp:i}):u({success:!1,error:"Operaci\xF3n no soportada",timestamp:i})}),C(),o(n=>{let i=n.filter(s=>s.success).length,d=n.length-i,p=n.filter(s=>!s.success&&s.error).map(s=>s.error),g=Date.now()-r,v=n;if(a){let s=n.findIndex(F=>!F.success);s>=0&&(v=n.slice(0,s+1))}let w={success:d===0,results:v.map(s=>({success:s.success,data:s.data,error:s.error,timestamp:s.timestamp})),summary:{total:v.length,successful:v.filter(s=>s.success).length,failed:v.filter(s=>!s.success).length,errors:v.filter(s=>!s.success&&s.error).map(s=>s.error)},executionTime:g};return this.clearCache(),w}),c(n=>{throw new Error(n.message||"Error en operaci\xF3n masiva")}),h(()=>this.setLoading(!1)))}duplicateEvent(e,t){return this.eventRepository.duplicate(e,t||"Copia de evento").pipe(o(r=>{if(!r.success||!r.data)throw new Error(r.error||"Error duplicando evento");return this.updateEventCache(r.data.id,r.data),r.data}),c(r=>{throw new Error(r.message||"Error duplicando evento")}))}convertToRepositoryFilters(e,t,r,a){let n=e||{},i=n.dateFrom,d=n.dateTo,p=new Date().toISOString();if(n.timingStatus&&n.timingStatus.length>0){let v=n.timingStatus[0];v==="upcoming"?i=p:v==="ongoing"?(i=p,d=p):v==="finished"&&(d=p)}if(t||r||a){let v=n.myEvents?this.authService.currentUser?.id:void 0;return{page:r||1,pageSize:a||20,search:n.query,sortBy:t?.field||"created_at",sortDirection:t?.direction||"desc",status:Array.isArray(n.status)?n.status[0]:n.status,eventTypeId:Array.isArray(n.eventTypeId)?n.eventTypeId[0]:n.eventTypeId,organizerId:v||n.organizerId,location:Array.isArray(n.locationType)?n.locationType[0]:n.location,isPublic:n.isPublic,dateFrom:i,dateTo:d,tags:n.tags}}return{eventTypeId:n.eventTypeId||void 0,status:n.status||void 0,locationType:n.locationType,dateFrom:i,dateTo:d,organizerId:n.myEvents?this.authService.currentUser?.id:n.organizerId,isFeatured:n.featured,isPublic:n.isPublic,tags:n.tags}}setLoading(e){this.loadingSubject.next(e)}isEventCached(e){let t=this.cacheTimestamp.get(e);return t?Date.now()-t<this.CACHE_TTL&&this.eventCache.has(e):!1}updateEventCache(e,t){this.eventCache.set(e,t),this.cacheTimestamp.set(e,Date.now())}removeFromCache(e){this.eventCache.delete(e),this.cacheTimestamp.delete(e)}clearCache(){this.eventCache.clear(),this.cacheTimestamp.clear()}validateEventData(e){let t=[];return(!e.title||e.title.trim().length<5)&&t.push("El t\xEDtulo debe tener al menos 5 caracteres"),(!e.eventTypeId||e.eventTypeId<=0)&&t.push("Tipo de evento inv\xE1lido"),!e.startDate||!e.endDate?t.push("Fechas de inicio y fin requeridas"):new Date(e.startDate)>=new Date(e.endDate)&&t.push("La fecha de fin debe ser posterior a la de inicio"),e.registrationStart&&e.registrationEnd&&new Date(e.registrationStart)>new Date(e.registrationEnd)&&t.push("El fin de inscripci\xF3n debe ser posterior al inicio"),e.cost!==void 0&&e.cost<0&&t.push("El costo no puede ser negativo"),e.locationType||t.push("Tipo de ubicaci\xF3n requerido"),t}validateStatusTransition(e,t){let r=this.eventCache.get(e);if(!r)return null;let a=r.status,n={draft:["published","reg_open","cancelled"],published:["reg_open","reg_closed","cancelled"],reg_open:["reg_closed","active","cancelled"],reg_closed:["active","cancelled"],active:["completed","cancelled"],completed:[],cancelled:[]};return!n[a]||!n[a].includes(t)?`Transici\xF3n de estado no permitida: ${a} \u2192 ${t}`:null}getDashboardStats(){return this.eventRepository.getDashboardStats()}static \u0275fac=function(t){return new(t||b)(f(L),f(U))};static \u0275prov=T({token:b,factory:b.\u0275fac,providedIn:"root"})};export{U as a,P as b};
