import{a as R,b,c as D,d as L,g as z,h as j,i as V,j as G,k as Y,l as B,o as $,p as Z,q as H}from"./chunk-HUOKS4AF.js";import{$ as m,A as O,Ca as A,F as U,Ha as T,Ka as N,L as p,M as g,Ma as I,Pa as q,Q as d,R as a,Ra as J,S as o,Sa as K,T as u,X as w,Z as x,fa as M,h as F,ha as s,ia as h,ja as _,k,l as C,m as E,n as S,s as c,t as P,x as n}from"./chunk-VTOYO4CT.js";import{i as v}from"./chunk-ODN5LVDJ.js";var y=class r{constructor(t){this.supabaseService=t}_registering=c(!1);_error=c(null);_success=c(!1);registering=this._registering.asReadonly();error=this._error.asReadonly();success=this._success.asReadonly();registerUser(t){return v(this,null,function*(){try{this._registering.set(!0),this._error.set(null),this._success.set(!1);let{data:e}=yield this.supabaseService.client.from("allowed_users").select("id").eq("email",t.email.toLowerCase().trim()).single();if(e)throw new Error("Ya existe un usuario registrado con este email");if(t.username){let{data:f}=yield this.supabaseService.client.from("allowed_users").select("id").eq("username",t.username.toLowerCase().trim()).single();if(f)throw new Error("Ya existe un usuario con este nombre de usuario")}let i={email:t.email.toLowerCase().trim(),username:t.username?.toLowerCase().trim(),display_name:t.display_name,role:"guest",permissions:["certificate"],active:!1,notes:t.notes||"Usuario registrado autom\xE1ticamente",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{error:l}=yield this.supabaseService.client.from("allowed_users").insert([i]);if(l)throw new Error(`Error en el registro: ${l.message}`);return this._success.set(!0),!0}catch(e){let i=e?.message||"Error durante el registro";return this._error.set(i),!1}finally{this._registering.set(!1)}})}checkEmailAvailability(t){return v(this,null,function*(){try{let{data:e}=yield this.supabaseService.client.from("allowed_users").select("id").eq("email",t.toLowerCase().trim()).single();return!e}catch{return!0}})}checkUsernameAvailability(t){return v(this,null,function*(){try{let{data:e}=yield this.supabaseService.client.from("allowed_users").select("id").eq("username",t.toLowerCase().trim()).single();return!e}catch{return!0}})}clearError(){this._error.set(null)}clearSuccess(){this._success.set(!1)}static \u0275fac=function(e){return new(e||r)(k(J))};static \u0275prov=F({token:r,factory:r.\u0275fac,providedIn:"root"})};function X(r,t){if(r&1&&(a(0,"div",1)(1,"div",34),u(2,"i",35),o(),a(3,"h1",36),s(4),o(),a(5,"p",37),s(6),o()()),r&2){let e=m();n(2),d("ngClass",e.isEditMode()?"bi-person-gear":"bi-person-plus-fill"),n(2),_(" ",e.isEditMode()?"Editar Usuario":"Nuevo Usuario"," "),n(2),_(" ",e.isEditMode()?"Modifique la informaci\xF3n del usuario":"Complete los datos para crear un nuevo usuario"," ")}}function ee(r,t){if(r&1&&(a(0,"div",2)(1,"div",38),u(2,"i",39),a(3,"span",40),s(4),o()()()),r&2){let e=m();n(4),h(e.success())}}function te(r,t){if(r&1&&(a(0,"div",3)(1,"div",38),u(2,"i",41),a(3,"span",40),s(4),o()()()),r&2){let e=m();n(4),h(e.error())}}function ie(r,t){if(r&1&&(a(0,"div",4)(1,"div",42)(2,"div",43)(3,"span",44),s(4,"Procesando..."),o()(),a(5,"p",37),s(6),o()()()),r&2){let e=m();n(6),h(e.isEditMode()?"Guardando cambios...":"Creando usuario...")}}function re(r,t){if(r&1&&(a(0,"div",11),s(1),o()),r&2){let e=m();n(),h(e.getFieldError("email"))}}function ne(r,t){if(r&1&&(a(0,"div",12),u(1,"i",45),s(2),o()),r&2){let e=m();d("ngClass",e.emailAvailable()?"text-success":"text-danger"),n(),d("ngClass",e.emailAvailable()?"bi-check-circle":"bi-x-circle"),n(),_(" ",e.emailCheckMessage()," ")}}function ae(r,t){if(r&1&&(a(0,"div",11),s(1),o()),r&2){let e=m();n(),h(e.getFieldError("username"))}}function oe(r,t){if(r&1&&(a(0,"div",12),u(1,"i",45),s(2),o()),r&2){let e=m();d("ngClass",e.usernameAvailable()?"text-success":"text-danger"),n(),d("ngClass",e.usernameAvailable()?"bi-check-circle":"bi-x-circle"),n(),_(" ",e.usernameCheckMessage()," ")}}function se(r,t){if(r&1&&(a(0,"div",11),s(1),o()),r&2){let e=m();n(),h(e.getFieldError("display_name"))}}function le(r,t){if(r&1&&(a(0,"div",11),s(1),o()),r&2){let e=m();n(),h(e.getFieldError("routes"))}}function de(r,t){r&1&&u(0,"span",48)}function me(r,t){if(r&1&&u(0,"i",45),r&2){let e=m(2);d("ngClass",e.isEditMode()?"bi-check-lg":"bi-person-plus")}}function ce(r,t){if(r&1){let e=w();a(0,"div",31)(1,"div",20)(2,"button",46),x("click",function(){E(e);let l=m();return S(l.isEditMode()?l.goToUserManagement():l.goToLogin())}),u(3,"i",45),s(4),o()(),a(5,"div",20)(6,"button",47),p(7,de,1,0,"span",48)(8,me,1,1,"i",45),s(9),o()()()}if(r&2){let e=m();n(3),d("ngClass",e.isEditMode()?"bi-arrow-left":"bi-box-arrow-in-left"),n(),_(" ",e.isEditMode()?"Volver a Gesti\xF3n":"Ir al Login"," "),n(2),d("disabled",e.userForm.invalid||e.processing()||!e.emailAvailable()&&!e.isEditMode()||!e.usernameAvailable()&&!e.isEditMode()),n(),g(e.processing()?7:8),n(2),_(" ",e.isEditMode()?"Actualizar Usuario":"Crear Usuario"," ")}}function ue(r,t){r&1&&u(0,"span",48)}function pe(r,t){if(r&1&&u(0,"i",45),r&2){let e=m(2);d("ngClass",e.isEditMode()?"bi-check-lg":"bi-person-plus")}}function ge(r,t){if(r&1){let e=w();a(0,"div",32)(1,"button",49),x("click",function(){E(e);let l=m();return S(l.goToUserManagement())}),s(2," Cancelar "),o(),a(3,"button",50),p(4,ue,1,0,"span",48)(5,pe,1,1,"i",45),s(6),o()()}if(r&2){let e=m();n(3),d("disabled",e.userForm.invalid||e.processing()||!e.emailAvailable()&&!e.isEditMode()||!e.usernameAvailable()&&!e.isEditMode()),n(),g(e.processing()?4:5),n(2),_(" ",e.isEditMode()?"Actualizar":"Crear"," Usuario ")}}function ve(r,t){r&1&&(a(0,"div",33)(1,"p",37),s(2," \xBFYa tienes una cuenta? "),a(3,"a",51),s(4,"Iniciar sesi\xF3n"),o()()())}var Q=class r{isModal=!1;editMode=!1;userToEdit=null;userSaved=new U;modalClosed=new U;registrationService=C(y);userManagementService=C(K);fb=C($);router=C(I);route=C(N);processing=c(!1);error=c("");success=c("");isEditMode=c(!1);currentUser=c(null);emailAvailable=c(!0);usernameAvailable=c(!0);emailCheckMessage=c("");usernameCheckMessage=c("");userForm;ngOnInit(){if(this.initializeForm(),!this.isModal){let t=this.route.snapshot.paramMap.get("id");t&&(this.isEditMode.set(!0),this.loadUser(t))}}ngOnChanges(t){this.isModal&&(this.userForm||this.initializeForm(),this.isEditMode.set(this.editMode),t.userToEdit&&this.userToEdit?(this.currentUser.set(this.userToEdit),this.populateForm(this.userToEdit)):t.editMode&&!this.editMode&&(this.currentUser.set(null),this.resetForm()))}loadUser(t){return v(this,null,function*(){try{this.processing.set(!0);let e=parseInt(t,10);if(isNaN(e)){this.error.set("ID de usuario inv\xE1lido");return}let i=yield this.userManagementService.getUserById(e);i&&(this.currentUser.set(i),this.populateForm(i))}catch{this.error.set("Error al cargar el usuario")}finally{this.processing.set(!1)}})}populateForm(t){this.userForm&&this.userForm.patchValue({email:t.email,username:t.username,display_name:t.display_name,role:t.role,active:t.active,routes:t.permissions?t.permissions.join(", "):"",notes:t.notes||""})}initializeForm(){this.userForm=this.fb.group({email:["",[b.required,b.email]],username:["",[b.required,b.minLength(3),b.pattern(/^[a-zA-Z0-9_]+$/)]],display_name:["",[b.required,b.minLength(2)]],role:["user",[b.required]],active:[!0],routes:[""],notes:[""]})}onSubmit(){return v(this,null,function*(){if(this.userForm.invalid||!this.isEditMode()&&(!this.emailAvailable()||!this.usernameAvailable())){this.markFormGroupTouched();return}try{this.processing.set(!0),this.error.set(""),this.isEditMode()?yield this.updateUser():yield this.createUser()}catch(t){this.error.set(t.message||"Error al procesar la solicitud")}finally{this.processing.set(!1)}})}createUser(){return v(this,null,function*(){let t=this.userForm.value,e=t.routes?t.routes.split(",").map(l=>l.trim()).filter(l=>l):[],i={email:t.email,username:t.username,display_name:t.display_name,role:t.role,permissions:e,notes:t.notes};yield this.userManagementService.createUser(i),this.success.set("Usuario creado exitosamente"),this.isModal?this.userSaved.emit():setTimeout(()=>this.router.navigate(["/admin/users"]),2e3)})}updateUser(){return v(this,null,function*(){let t=this.currentUser();if(!t?.id)return;let e=this.userForm.value,i=e.routes?e.routes.split(",").map(f=>f.trim()).filter(f=>f):[],l={id:t.id,email:e.email,username:e.username,display_name:e.display_name,role:e.role,active:e.active,permissions:i,notes:e.notes};yield this.userManagementService.updateUser(l),this.success.set("Usuario actualizado exitosamente"),this.isModal?this.userSaved.emit():setTimeout(()=>this.router.navigate(["/admin/users"]),2e3)})}resetForm(){this.userForm&&this.userForm.reset({role:"user",active:!0,routes:""}),this.emailAvailable.set(!0),this.usernameAvailable.set(!0),this.emailCheckMessage.set(""),this.usernameCheckMessage.set("")}checkEmailAvailability(){return v(this,null,function*(){let t=this.userForm.get("email")?.value;if(!t||this.userForm.get("email")?.invalid){this.emailCheckMessage.set("");return}if(this.isEditMode()){let i=this.currentUser();if(i&&i.email===t){this.emailAvailable.set(!0),this.emailCheckMessage.set("");return}}let e=yield this.registrationService.checkEmailAvailability(t);this.emailAvailable.set(e),e?this.emailCheckMessage.set("Correo electr\xF3nico disponible"):this.emailCheckMessage.set("Este correo electr\xF3nico ya est\xE1 registrado")})}checkUsernameAvailability(){return v(this,null,function*(){let t=this.userForm.get("username")?.value;if(!t||this.userForm.get("username")?.invalid){this.usernameCheckMessage.set("");return}if(this.isEditMode()){let i=this.currentUser();if(i&&i.username===t){this.usernameAvailable.set(!0),this.usernameCheckMessage.set("");return}}let e=yield this.registrationService.checkUsernameAvailability(t);this.usernameAvailable.set(e),e?this.usernameCheckMessage.set("Nombre de usuario disponible"):this.usernameCheckMessage.set("Este nombre de usuario ya est\xE1 en uso")})}goToLogin(){this.isModal?this.modalClosed.emit():this.router.navigate(["/login"])}goToUserManagement(){this.isModal?this.modalClosed.emit():this.router.navigate(["/admin/users"])}hasFieldError(t){let e=this.userForm.get(t);return!!(e?.invalid&&e?.touched)}getFieldError(t){let e=this.userForm.get(t);if(e?.invalid&&e?.touched){if(e.errors?.required)return"Este campo es obligatorio";if(e.errors?.email)return"Ingrese un correo electr\xF3nico v\xE1lido";if(e.errors?.minlength)return`Debe contener al menos ${e.errors?.minlength.requiredLength} caracteres`;if(e.errors?.pattern&&t==="username")return"Solo se permiten letras, n\xFAmeros y guiones bajos"}return""}markFormGroupTouched(){Object.keys(this.userForm.controls).forEach(t=>{this.userForm.get(t)?.markAsTouched()})}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=O({type:r,selectors:[["app-user"]],inputs:{isModal:"isModal",editMode:"editMode",userToEdit:"userToEdit"},outputs:{userSaved:"userSaved",modalClosed:"modalClosed"},features:[P],decls:65,vars:31,consts:[[3,"ngClass"],[1,"text-center","mb-4"],[1,"alert","alert-success","border-0","bg-success","bg-opacity-10","mb-4"],[1,"alert","alert-danger","border-0","bg-danger","bg-opacity-10","mb-4"],[1,"card","border-0","shadow-sm","mb-4"],["novalidate","",3,"ngSubmit","formGroup"],[1,"row","g-3"],[1,"col-12"],["for","email",1,"form-label","small","fw-medium"],[1,"text-danger"],["type","email","id","email","formControlName","email","placeholder","usuario@ejemplo.com",1,"form-control","form-control-sm",3,"blur"],[1,"invalid-feedback","small"],[1,"form-text","small",3,"ngClass"],["for","username",1,"form-label","small","fw-medium"],["type","text","id","username","formControlName","username","placeholder","usuario123",1,"form-control","form-control-sm",3,"blur"],["for","display_name",1,"form-label","small","fw-medium"],["type","text","id","display_name","formControlName","display_name","placeholder","Nombre Apellido",1,"form-control","form-control-sm"],["for","routes",1,"form-label","small","fw-medium"],["type","text","id","routes","formControlName","routes","placeholder","admin, certificate, dashboard",1,"form-control","form-control-sm"],[1,"form-text","small","text-muted"],[1,"col-12","col-md-6"],["for","role",1,"form-label","small","fw-medium"],["id","role","formControlName","role",1,"form-select","form-select-sm"],["value","user"],["value","admin"],["value","guest"],["for","active",1,"form-label","small","fw-medium"],["id","active","formControlName","active",1,"form-select","form-select-sm"],[3,"value"],["for","notes",1,"form-label","small","fw-medium"],["id","notes","formControlName","notes","rows","3","placeholder","Informaci\xF3n adicional sobre el usuario (opcional)",1,"form-control","form-control-sm"],[1,"row","g-2","mt-4"],[1,"d-flex","justify-content-end","gap-2","mt-4"],[1,"text-center","mt-4"],[1,"bg-white","rounded-circle","shadow-sm","d-inline-flex","align-items-center","justify-content-center","mb-3",2,"width","64px","height","64px"],[1,"bi","text-dark",2,"font-size","1.5rem",3,"ngClass"],[1,"h4","fw-bold","text-dark","mb-2"],[1,"text-muted","small","mb-0"],[1,"d-flex","align-items-center"],[1,"bi","bi-check-circle-fill","text-success","me-2"],[1,"fw-medium"],[1,"bi","bi-exclamation-triangle-fill","text-danger","me-2"],[1,"card-body","text-center","py-4"],["role","status",1,"spinner-border","spinner-border-sm","text-dark","mb-2"],[1,"visually-hidden"],[1,"bi","me-1",3,"ngClass"],["type","button",1,"btn","btn-outline-secondary","btn-sm","w-100",3,"click"],["type","submit",1,"btn","btn-dark","btn-sm","w-100",3,"disabled"],["role","status",1,"spinner-border","spinner-border-sm","me-2"],["type","button",1,"btn","btn-secondary","btn-sm",3,"click"],["type","submit",1,"btn","btn-dark","btn-sm",3,"disabled"],["href","/login",1,"text-decoration-none","fw-medium"]],template:function(e,i){if(e&1&&(a(0,"div",0)(1,"div",0)(2,"div",0)(3,"div",0),p(4,X,7,3,"div",1),p(5,ee,5,1,"div",2),p(6,te,5,1,"div",3),p(7,ie,7,1,"div",4),a(8,"div",0)(9,"div",0)(10,"form",5),x("ngSubmit",function(){return i.onSubmit()}),a(11,"div",6)(12,"div",7)(13,"label",8),s(14," Correo electr\xF3nico "),a(15,"span",9),s(16,"*"),o()(),a(17,"input",10),x("blur",function(){return i.checkEmailAvailability()}),o(),p(18,re,2,1,"div",11)(19,ne,3,3,"div",12),o(),a(20,"div",7)(21,"label",13),s(22,"Nombre de usuario"),o(),a(23,"input",14),x("blur",function(){return i.checkUsernameAvailability()}),o(),p(24,ae,2,1,"div",11)(25,oe,3,3,"div",12),o(),a(26,"div",7)(27,"label",15),s(28," Nombre completo "),a(29,"span",9),s(30,"*"),o()(),u(31,"input",16),p(32,se,2,1,"div",11),o(),a(33,"div",7)(34,"label",17),s(35,"Rutas autorizadas"),o(),u(36,"input",18),a(37,"div",19),s(38," Ingrese las rutas separadas por comas (ej: admin, certificate, user) "),o(),p(39,le,2,1,"div",11),o(),a(40,"div",20)(41,"label",21),s(42,"Rol"),o(),a(43,"select",22)(44,"option",23),s(45,"Usuario"),o(),a(46,"option",24),s(47,"Administrador"),o(),a(48,"option",25),s(49,"Invitado"),o()()(),a(50,"div",20)(51,"label",26),s(52,"Estado"),o(),a(53,"select",27)(54,"option",28),s(55,"Activo"),o(),a(56,"option",28),s(57,"Inactivo"),o()()(),a(58,"div",7)(59,"label",29),s(60,"Notas adicionales"),o(),u(61,"textarea",30),o()(),p(62,ce,10,5,"div",31)(63,ge,7,3,"div",32),o()()(),p(64,ve,5,0,"div",33),o()()()()),e&2){let l,f;d("ngClass",i.isModal?"p-4":"min-vh-100 bg-light py-4"),n(),d("ngClass",i.isModal?"":"container"),n(),d("ngClass",i.isModal?"":"row justify-content-center"),n(),d("ngClass",i.isModal?"":"col-12 col-md-8 col-lg-6 col-xl-5"),n(),g(i.isModal?-1:4),n(),g(i.success()?5:-1),n(),g(i.error()?6:-1),n(),g(i.processing()?7:-1),n(),d("ngClass",i.isModal?"":"card border-0 shadow-sm"),n(),d("ngClass",i.isModal?"":"card-body p-4"),n(),d("formGroup",i.userForm),n(7),M("is-invalid",i.hasFieldError("email")||!i.emailAvailable()&&!i.isEditMode())("is-valid",!i.hasFieldError("email")&&i.emailAvailable()&&((l=i.userForm.get("email"))==null?null:l.value)),n(),g(i.hasFieldError("email")?18:i.emailCheckMessage()&&!i.isEditMode()?19:-1),n(5),M("is-invalid",i.hasFieldError("username")||!i.usernameAvailable()&&!i.isEditMode())("is-valid",!i.hasFieldError("username")&&i.usernameAvailable()&&((f=i.userForm.get("username"))==null?null:f.value)),n(),g(i.hasFieldError("username")?24:i.usernameCheckMessage()&&!i.isEditMode()?25:-1),n(7),M("is-invalid",i.hasFieldError("display_name")),n(),g(i.hasFieldError("display_name")?32:-1),n(4),M("is-invalid",i.hasFieldError("routes")),n(3),g(i.hasFieldError("routes")?39:-1),n(15),d("value",!0),n(2),d("value",!1),n(6),g(i.isModal?63:62),n(2),g(i.isEditMode()?-1:64)}},dependencies:[T,A,Z,z,Y,B,R,G,D,L,H,j,V,q],styles:[".min-vh-100[_ngcontent-%COMP%]{background:linear-gradient(135deg,var(--bs-light) 0%,#f8f9fa 100%)}.form-floating[_ngcontent-%COMP%]{position:relative}.form-floating[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}.form-floating[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]:focus{border-color:var(--bs-primary);box-shadow:0 0 0 .2rem rgba(var(--bs-primary-rgb),.25)}.form-floating[_ngcontent-%COMP%]   .form-control.is-invalid[_ngcontent-%COMP%]{border-color:var(--bs-danger)}.form-floating[_ngcontent-%COMP%]   .form-control.is-invalid[_ngcontent-%COMP%]:focus{border-color:var(--bs-danger);box-shadow:0 0 0 .2rem rgba(var(--bs-danger-rgb),.25)}.form-floating[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{color:var(--bs-secondary);transition:all .15s ease-in-out}.card[_ngcontent-%COMP%]{border-radius:1rem;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]{position:relative}.bg-success.bg-opacity-10[_ngcontent-%COMP%]{background-color:rgba(var(--bs-success-rgb),.1)!important}.btn[_ngcontent-%COMP%]{border-radius:.5rem;font-weight:500;transition:all .2s ease-in-out}.btn.btn-lg[_ngcontent-%COMP%]{font-size:1rem;font-weight:600}.btn[_ngcontent-%COMP%]:hover{transform:translateY(-1px);box-shadow:0 4px 8px #00000026}.btn[_ngcontent-%COMP%]:disabled{transform:none;box-shadow:none}.spinner-border[_ngcontent-%COMP%]{animation:spinner-border .75s linear infinite}.rounded-circle[_ngcontent-%COMP%]{transition:all .3s ease-in-out}.rounded-circle[_ngcontent-%COMP%]:hover{transform:scale(1.05)}.alert[_ngcontent-%COMP%]{border-radius:.75rem}.alert.alert-success[_ngcontent-%COMP%]{background-color:rgba(var(--bs-success-rgb),.1);border:1px solid rgba(var(--bs-success-rgb),.2);color:var(--bs-success-text-emphasis)}.alert.alert-danger[_ngcontent-%COMP%]{background-color:rgba(var(--bs-danger-rgb),.1);border:1px solid rgba(var(--bs-danger-rgb),.2);color:var(--bs-danger-text-emphasis)}.form-text[_ngcontent-%COMP%]{font-size:.875rem}.form-text.text-success[_ngcontent-%COMP%]{color:var(--bs-success)!important}.form-text.text-danger[_ngcontent-%COMP%]{color:var(--bs-danger)!important}@media (max-width: 768px){.card-body[_ngcontent-%COMP%]{padding:2rem 1.5rem!important}.btn-lg[_ngcontent-%COMP%]{padding:.75rem 1rem;font-size:.95rem}.h3[_ngcontent-%COMP%]{font-size:1.5rem}}@media (max-width: 576px){.min-vh-100[_ngcontent-%COMP%]{padding:2rem 0}.card-body[_ngcontent-%COMP%]{padding:1.5rem 1rem!important}.col-12[_ngcontent-%COMP%]{padding-left:1rem;padding-right:1rem}}"]})};export{Q as a};
