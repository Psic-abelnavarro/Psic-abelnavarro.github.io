import{Ma as l,Qa as c,Ra as h,Sa as d,h as u,l as i,s as a,va as n}from"./chunk-IF5T24EF.js";import{i as t}from"./chunk-ODN5LVDJ.js";var m=class o{supabaseService=i(h);userManagementService=i(d);router=i(l);_currentUser=a(null);_loading=a(!1);_error=a(null);currentUser=this._currentUser.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();isAuthenticated=n(()=>this._currentUser()!==null);userEmail=n(()=>this._currentUser()?.email??null);userId=n(()=>this._currentUser()?.id??null);constructor(){this.initializeAuth(),this.setupSessionRefresh()}setupSessionRefresh(){c.auth.autoRefreshToken&&setInterval(()=>t(this,null,function*(){let{data:{session:e}}=yield this.supabaseService.auth.getSession();if(!e)return;e.expires_at-Math.floor(Date.now()/1e3)<300&&(yield this.supabaseService.auth.refreshSession())}),6e4)}initializeAuth(){return t(this,null,function*(){try{yield this.checkSession(),this.supabaseService.auth.onAuthStateChange((e,r)=>t(this,null,function*(){let s=r?.user??null;if(s?.email&&!(yield this.userManagementService.isUserAuthorized(s.email))){yield this.handleUnauthorizedUser();return}this._currentUser.set(s),this._error.set(null)}))}catch{this._error.set("Failed to initialize authentication")}})}checkSession(){return t(this,null,function*(){try{this._loading.set(!0),this._error.set(null);let{data:{session:e},error:r}=yield this.supabaseService.auth.getSession();if(r)throw r;let s=e?.user??null;if(s?.email&&!(yield this.userManagementService.isUserAuthorized(s.email))){yield this.handleUnauthorizedUser();return}this._currentUser.set(s)}catch(e){this._currentUser.set(null),this._error.set(e?.message||"Failed to check session")}finally{this._loading.set(!1)}})}handleUnauthorizedUser(){return t(this,null,function*(){yield this.supabaseService.auth.signOut(),this._currentUser.set(null),this._error.set("Usuario no autorizado"),this.router.navigate(["/"],{queryParams:{error:"unauthorized_user",message:"Usuario no autorizado para acceder a la aplicaci\xF3n"}})})}signInWithGoogle(){return t(this,null,function*(){try{this._loading.set(!0),this._error.set(null);let{data:e,error:r}=yield this.supabaseService.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/auth/callback`,queryParams:{access_type:"offline",prompt:"consent"},scopes:"openid email profile"}});return r?(this._error.set(r.message),{data:null,error:r}):{data:e,error:null}}catch(e){let r=e?.message||"Unexpected error during Google authentication";return this._error.set(r),{data:null,error:{message:r}}}finally{this._loading.set(!1)}})}signOut(){return t(this,null,function*(){try{this._loading.set(!0),this._error.set(null);let{error:e}=yield this.supabaseService.auth.signOut();return e?(this._error.set(e.message),{error:e}):(this._currentUser.set(null),this.userManagementService.clearAuthCache(),{error:null})}catch(e){let r=e?.message||"Failed to sign out";return this._error.set(r),{error:{message:r}}}finally{this._loading.set(!1)}})}getCurrentUser(){return this._currentUser()}clearError(){this._error.set(null)}getSessionInfo(){return t(this,null,function*(){try{let{data:{session:e}}=yield this.supabaseService.auth.getSession();if(!e)return{isActive:!1};let r=e.expires_at-Math.floor(Date.now()/1e3);return{isActive:!0,expiresAt:e.expires_at,timeUntilExpiry:r,refreshToken:e.refresh_token}}catch{return{isActive:!1}}})}extendSession(){return t(this,null,function*(){try{let{error:e}=yield this.supabaseService.auth.refreshSession();return e?(this._error.set("Error al extender la sesi\xF3n"),!1):!0}catch{return this._error.set("Error inesperado al extender la sesi\xF3n"),!1}})}isCurrentUserAdmin(){return t(this,null,function*(){try{if(!this.userEmail())return!1;let{data:r,error:s}=yield this.supabaseService.client.rpc("is_admin");return s?!1:r||!1}catch{return!1}})}static \u0275fac=function(r){return new(r||o)};static \u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"})};export{m as a};
