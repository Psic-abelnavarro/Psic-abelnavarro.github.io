import{La as h,Ma as f,g as y,o as i,sa as n}from"./chunk-IWV4FJLC.js";import{a as d,b as m,c as _,i as t}from"./chunk-ODN5LVDJ.js";var b=class g{supabase;TABLE_NAME="allowed_users";_users=i([]);_loading=i(!1);_error=i(null);_totalUsers=i(0);_currentPage=i(1);_pageSize=i(10);_filters=i({});users=this._users.asReadonly();loading=this._loading.asReadonly();error=this._error.asReadonly();totalUsers=this._totalUsers.asReadonly();currentPage=this._currentPage.asReadonly();pageSize=this._pageSize.asReadonly();filters=this._filters.asReadonly();totalPages=n(()=>Math.ceil(this._totalUsers()/this._pageSize()));hasNextPage=n(()=>this._currentPage()<this.totalPages());hasPreviousPage=n(()=>this._currentPage()>1);filteredUsersCount=n(()=>this._users().length);activeUsersCount=n(()=>this._users().filter(r=>r.active).length);adminUsersCount=n(()=>this._users().filter(r=>r.role==="admin").length);constructor(){this.supabase=f(h.supabase.url,h.supabase.anonKey)}getUsers(){return t(this,arguments,function*(r={page:1,limit:10},e={}){try{this._loading.set(!0),this._error.set(null),this._currentPage.set(r.page),this._pageSize.set(r.limit),this._filters.set(e);let s=this.supabase.from(this.TABLE_NAME).select("*",{count:"exact"});e.search&&(s=s.or(`email.ilike.%${e.search}%,username.ilike.%${e.search}%,display_name.ilike.%${e.search}%`)),e.role&&(s=s.eq("role",e.role)),e.active!==void 0&&(s=s.eq("active",e.active));let a=(r.page-1)*r.limit,o=a+r.limit-1;s=s.range(a,o).order("created_at",{ascending:!1});let{data:c,error:u,count:l}=yield s;if(u)throw new Error(`Error fetching users: ${u.message}`);let p=c||[];return this._users.set(p),this._totalUsers.set(l||0),{data:p,total:l||0,page:r.page,limit:r.limit,totalPages:Math.ceil((l||0)/r.limit)}}catch(s){let a=s?.message||"Error al obtener usuarios";throw this._error.set(a),s}finally{this._loading.set(!1)}})}getUserById(r){return t(this,null,function*(){try{this._loading.set(!0),this._error.set(null);let{data:e,error:s}=yield this.supabase.from(this.TABLE_NAME).select("*").eq("id",r).single();if(s){if(s.code==="PGRST116")return null;throw new Error(`Error fetching user: ${s.message}`)}return e}catch(e){let s=e?.message||"Error al obtener usuario";throw this._error.set(s),e}finally{this._loading.set(!1)}})}getUserByEmail(r){return t(this,null,function*(){try{let{data:e,error:s}=yield this.supabase.from(this.TABLE_NAME).select("*").eq("email",r.toLowerCase().trim()).single();if(s){if(s.code==="PGRST116")return null;throw new Error(`Error fetching user: ${s.message}`)}return e}catch{return null}})}createUser(r){return t(this,null,function*(){try{if(this._loading.set(!0),this._error.set(null),yield this.getUserByEmail(r.email))throw new Error("Ya existe un usuario con este email");let s=m(d({},r),{email:r.email.toLowerCase().trim(),permissions:r.permissions?this.parsePermissions(r.permissions):this.getDefaultPermissions(r.role),active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:a,error:o}=yield this.supabase.from(this.TABLE_NAME).insert([s]).select().single();if(o)throw new Error(`Error creating user: ${o.message}`);return yield this.refreshCurrentPage(),a}catch(e){let s=e?.message||"Error al crear usuario";throw this._error.set(s),e}finally{this._loading.set(!1)}})}updateUser(r){return t(this,null,function*(){try{this._loading.set(!0),this._error.set(null);let s=m(d({},r),{updated_at:new Date().toISOString()});if(s.email){s.email=s.email.toLowerCase().trim();let l=yield this.getUserByEmail(s.email);if(l&&l.id!==r.id)throw new Error("Ya existe otro usuario con este email")}s.role&&!s.permissions&&(s.permissions=this.getDefaultPermissions(s.role)),s.permissions&&(s.permissions=this.parsePermissions(s.permissions));let e=s,{id:a}=e,o=_(e,["id"]),{data:c,error:u}=yield this.supabase.from(this.TABLE_NAME).update(o).eq("id",a).select().single();if(u)throw new Error(`Error updating user: ${u.message}`);return yield this.refreshCurrentPage(),c}catch(s){let a=s?.message||"Error al actualizar usuario";throw this._error.set(a),s}finally{this._loading.set(!1)}})}deleteUser(r){return t(this,null,function*(){try{this._loading.set(!0),this._error.set(null);let{error:e}=yield this.supabase.from(this.TABLE_NAME).update({active:!1,updated_at:new Date().toISOString()}).eq("id",r);if(e)throw new Error(`Error deleting user: ${e.message}`);yield this.refreshCurrentPage()}catch(e){let s=e?.message||"Error al eliminar usuario";throw this._error.set(s),e}finally{this._loading.set(!1)}})}permanentDeleteUser(r){return t(this,null,function*(){try{this._loading.set(!0),this._error.set(null);let{error:e}=yield this.supabase.from(this.TABLE_NAME).delete().eq("id",r);if(e)throw new Error(`Error permanently deleting user: ${e.message}`);yield this.refreshCurrentPage()}catch(e){let s=e?.message||"Error al eliminar usuario permanentemente";throw this._error.set(s),e}finally{this._loading.set(!1)}})}toggleUserStatus(r){return t(this,null,function*(){try{let e=yield this.getUserById(r);if(!e)throw new Error("Usuario no encontrado");return yield this.updateUser({id:r,active:!e.active})}catch(e){let s=e?.message||"Error al cambiar estado del usuario";throw this._error.set(s),e}})}refreshCurrentPage(){return t(this,null,function*(){yield this.getUsers({page:this._currentPage(),limit:this._pageSize()},this._filters())})}getDefaultPermissions(r){switch(r){case"admin":return["certificate","admin","dashboard","reports","users"];case"user":return["certificate","profile"];case"guest":return["certificate"];default:return["certificate"]}}parsePermissions(r){return Array.isArray(r)?r:typeof r=="string"?r.split(",").map(e=>e.trim()).filter(e=>e.length>0):["certificate"]}clearError(){this._error.set(null)}goToPage(r){return t(this,null,function*(){r<1||r>this.totalPages()||(yield this.getUsers({page:r,limit:this._pageSize()},this._filters()))})}changePageSize(r){return t(this,null,function*(){yield this.getUsers({page:1,limit:r},this._filters())})}applyFilters(r){return t(this,null,function*(){yield this.getUsers({page:1,limit:this._pageSize()},r)})}checkRouteAccess(r,e){return t(this,null,function*(){try{let s=yield this.getUserByEmail(r);return!s||!s.active?!1:s.permissions.includes(e)}catch{return!1}})}getUserPermissions(r){return t(this,null,function*(){try{let e=yield this.getUserByEmail(r);return!e||!e.active?null:{has_access:!0,user_role:e.role,permissions:e.permissions,display_name:e.display_name}}catch{return null}})}static \u0275fac=function(e){return new(e||g)};static \u0275prov=y({token:g,factory:g.\u0275fac,providedIn:"root"})};export{b as a};
