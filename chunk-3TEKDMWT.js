import{a as q,b,c as R,d as L,g as V,h as j,i as z,j as G,k as Y,l as B,o as $,p as Z,q as H}from"./chunk-T4GT6RDP.js";import{$ as d,A as O,Ca as T,F as w,Ha as A,Ka as N,L as c,M as m,Ma as I,Pa as D,Q as l,R as a,Ra as J,S as o,Sa as K,T as u,X as U,Z as C,fa as x,h as F,ha as s,ia as f,ja as h,k,l as _,m as E,n as S,s as g,t as P,x as n}from"./chunk-APCKJ7FH.js";import{i as v}from"./chunk-ODN5LVDJ.js";var y=class i{constructor(t){this.supabaseService=t}_registering=g(!1);_error=g(null);_success=g(!1);registering=this._registering.asReadonly();error=this._error.asReadonly();success=this._success.asReadonly();registerUser(t){return v(this,null,function*(){try{this._registering.set(!0),this._error.set(null),this._success.set(!1);let{data:e}=yield this.supabaseService.client.from("allowed_users").select("id").eq("email",t.email.toLowerCase().trim()).single();if(e)throw new Error("Ya existe un usuario registrado con este email");if(t.username){let{data:M}=yield this.supabaseService.client.from("allowed_users").select("id").eq("username",t.username.toLowerCase().trim()).single();if(M)throw new Error("Ya existe un usuario con este nombre de usuario")}let r={email:t.email.toLowerCase().trim(),username:t.username?.toLowerCase().trim(),display_name:t.display_name,role:"guest",permissions:["certificate"],active:!1,notes:t.notes||"Usuario registrado autom\xE1ticamente",created_at:new Date().toISOString(),updated_at:new Date().toISOString()},{error:p}=yield this.supabaseService.client.from("allowed_users").insert([r]);if(p)throw new Error(`Error en el registro: ${p.message}`);return this._success.set(!0),!0}catch(e){let r=e?.message||"Error durante el registro";return this._error.set(r),!1}finally{this._registering.set(!1)}})}checkEmailAvailability(t){return v(this,null,function*(){try{let{data:e}=yield this.supabaseService.client.from("allowed_users").select("id").eq("email",t.toLowerCase().trim()).single();return!e}catch{return!0}})}checkUsernameAvailability(t){return v(this,null,function*(){try{let{data:e}=yield this.supabaseService.client.from("allowed_users").select("id").eq("username",t.toLowerCase().trim()).single();return!e}catch{return!0}})}clearError(){this._error.set(null)}clearSuccess(){this._success.set(!1)}static \u0275fac=function(e){return new(e||i)(k(J))};static \u0275prov=F({token:i,factory:i.\u0275fac,providedIn:"root"})};function X(i,t){if(i&1&&(a(0,"div",1)(1,"div",22),u(2,"i",23),o(),a(3,"h1",24),s(4),o(),a(5,"p",25),s(6),o()()),i&2){let e=d();n(2),l("ngClass",e.isEditMode()?"bi-person-gear":"bi-person-plus-fill"),n(2),h(" ",e.isEditMode()?"Editar Usuario":"Nuevo Usuario"," "),n(2),h(" ",e.isEditMode()?"Modifique la informaci\xF3n del usuario":"Complete los datos para crear un nuevo usuario"," ")}}function ee(i,t){if(i&1&&(a(0,"div",2)(1,"div",26),u(2,"i",27),a(3,"span",28),s(4),o()()()),i&2){let e=d();n(4),f(e.success())}}function te(i,t){if(i&1&&(a(0,"div",3)(1,"div",26),u(2,"i",29),a(3,"span",28),s(4),o()()()),i&2){let e=d();n(4),f(e.error())}}function ie(i,t){if(i&1&&(a(0,"div",4)(1,"div",30)(2,"div",31)(3,"span",32),s(4,"Procesando..."),o()(),a(5,"p",25),s(6),o()()()),i&2){let e=d();n(6),f(e.isEditMode()?"Guardando cambios...":"Creando usuario...")}}function re(i,t){if(i&1&&(a(0,"div",11),s(1),o()),i&2){let e=d();n(),f(e.getFieldError("email"))}}function ne(i,t){if(i&1&&(a(0,"div",12),u(1,"i",33),s(2),o()),i&2){let e=d();l("ngClass",e.emailAvailable()?"text-success":"text-danger"),n(),l("ngClass",e.emailAvailable()?"bi-check-circle":"bi-x-circle"),n(),h(" ",e.emailCheckMessage()," ")}}function ae(i,t){if(i&1&&(a(0,"div",11),s(1),o()),i&2){let e=d();n(),f(e.getFieldError("username"))}}function oe(i,t){if(i&1&&(a(0,"div",12),u(1,"i",33),s(2),o()),i&2){let e=d();l("ngClass",e.usernameAvailable()?"text-success":"text-danger"),n(),l("ngClass",e.usernameAvailable()?"bi-check-circle":"bi-x-circle"),n(),h(" ",e.usernameCheckMessage()," ")}}function se(i,t){if(i&1&&(a(0,"div",11),s(1),o()),i&2){let e=d();n(),f(e.getFieldError("display_name"))}}function le(i,t){i&1&&(a(0,"div",34)(1,"label",35),s(2,"Rol"),o(),a(3,"select",36)(4,"option",37),s(5,"Usuario"),o(),a(6,"option",38),s(7,"Administrador"),o(),a(8,"option",39),s(9,"Invitado"),o()()(),a(10,"div",34)(11,"label",40),s(12,"Estado"),o(),a(13,"select",41)(14,"option",42),s(15,"Activo"),o(),a(16,"option",42),s(17,"Inactivo"),o()()()),i&2&&(n(14),l("value",!0),n(2),l("value",!1))}function de(i,t){if(i&1&&(a(0,"div",11),s(1),o()),i&2){let e=d(2);n(),f(e.getFieldError("password"))}}function ce(i,t){if(i&1&&(a(0,"div",7)(1,"label",43),s(2," Contrase\xF1a "),a(3,"span",9),s(4,"*"),o()(),u(5,"input",44),c(6,de,2,1,"div",11),o()),i&2){let e=d();n(5),x("is-invalid",e.hasFieldError("password")),n(),m(e.hasFieldError("password")?6:-1)}}function me(i,t){i&1&&(a(0,"div",7)(1,"label",43),s(2,"Nueva contrase\xF1a"),o(),u(3,"input",45),a(4,"div",46),s(5," Solo complete este campo si desea cambiar la contrase\xF1a "),o()())}function ue(i,t){i&1&&u(0,"span",49)}function pe(i,t){if(i&1&&u(0,"i",33),i&2){let e=d(2);l("ngClass",e.isEditMode()?"bi-check-lg":"bi-person-plus")}}function ge(i,t){if(i&1){let e=U();a(0,"div",19)(1,"div",34)(2,"button",47),C("click",function(){E(e);let p=d();return S(p.isEditMode()?p.goToUserManagement():p.goToLogin())}),u(3,"i",33),s(4),o()(),a(5,"div",34)(6,"button",48),c(7,ue,1,0,"span",49)(8,pe,1,1,"i",33),s(9),o()()()}if(i&2){let e=d();n(3),l("ngClass",e.isEditMode()?"bi-arrow-left":"bi-box-arrow-in-left"),n(),h(" ",e.isEditMode()?"Volver a Gesti\xF3n":"Ir al Login"," "),n(2),l("disabled",e.userForm.invalid||e.processing()||!e.emailAvailable()&&!e.isEditMode()||!e.usernameAvailable()&&!e.isEditMode()),n(),m(e.processing()?7:8),n(2),h(" ",e.isEditMode()?"Actualizar Usuario":"Crear Usuario"," ")}}function ve(i,t){i&1&&u(0,"span",49)}function be(i,t){if(i&1&&u(0,"i",33),i&2){let e=d(2);l("ngClass",e.isEditMode()?"bi-check-lg":"bi-person-plus")}}function fe(i,t){if(i&1){let e=U();a(0,"div",20)(1,"button",50),C("click",function(){E(e);let p=d();return S(p.goToUserManagement())}),s(2," Cancelar "),o(),a(3,"button",51),c(4,ve,1,0,"span",49)(5,be,1,1,"i",33),s(6),o()()}if(i&2){let e=d();n(3),l("disabled",e.userForm.invalid||e.processing()||!e.emailAvailable()&&!e.isEditMode()||!e.usernameAvailable()&&!e.isEditMode()),n(),m(e.processing()?4:5),n(2),h(" ",e.isEditMode()?"Actualizar":"Crear"," Usuario ")}}function he(i,t){i&1&&(a(0,"div",21)(1,"p",25),s(2," \xBFYa tienes una cuenta? "),a(3,"a",52),s(4,"Iniciar sesi\xF3n"),o()()())}var Q=class i{isModal=!1;editMode=!1;userToEdit=null;userSaved=new w;modalClosed=new w;registrationService=_(y);userManagementService=_(K);fb=_($);router=_(I);route=_(N);processing=g(!1);error=g("");success=g("");isEditMode=g(!1);currentUser=g(null);emailAvailable=g(!0);usernameAvailable=g(!0);emailCheckMessage=g("");usernameCheckMessage=g("");userForm;ngOnInit(){if(this.initializeForm(),!this.isModal){let t=this.route.snapshot.paramMap.get("id");t&&(this.isEditMode.set(!0),this.loadUser(t))}}ngOnChanges(t){this.isModal&&(this.isEditMode.set(this.editMode),t.userToEdit&&this.userToEdit?(this.currentUser.set(this.userToEdit),this.populateForm(this.userToEdit)):t.editMode&&!this.editMode&&(this.currentUser.set(null),this.resetForm()))}loadUser(t){return v(this,null,function*(){try{this.processing.set(!0);let e=parseInt(t,10);if(isNaN(e)){this.error.set("ID de usuario inv\xE1lido");return}let r=yield this.userManagementService.getUserById(e);r&&(this.currentUser.set(r),this.populateForm(r))}catch{this.error.set("Error al cargar el usuario")}finally{this.processing.set(!1)}})}populateForm(t){this.userForm.patchValue({email:t.email,username:t.username,display_name:t.display_name,role:t.role,active:t.active,notes:t.notes||""})}initializeForm(){this.userForm=this.fb.group({email:["",[b.required,b.email]],username:["",[b.required,b.minLength(3),b.pattern(/^[a-zA-Z0-9_]+$/)]],display_name:["",[b.required,b.minLength(2)]],role:["user",[b.required]],active:[!0],password:[""],notes:[""]}),this.isEditMode()||this.userForm.get("password")?.setValidators([b.required,b.minLength(6)])}onSubmit(){return v(this,null,function*(){if(this.userForm.invalid||!this.isEditMode()&&(!this.emailAvailable()||!this.usernameAvailable())){this.markFormGroupTouched();return}try{this.processing.set(!0),this.error.set(""),this.isEditMode()?yield this.updateUser():yield this.createUser()}catch(t){this.error.set(t.message||"Error al procesar la solicitud")}finally{this.processing.set(!1)}})}createUser(){return v(this,null,function*(){let t=this.userForm.value,e={email:t.email,username:t.username,display_name:t.display_name,notes:t.notes};yield this.registrationService.registerUser(e),this.success.set("Usuario creado exitosamente"),this.isModal?this.userSaved.emit():setTimeout(()=>this.router.navigate(["/admin/users"]),2e3)})}updateUser(){return v(this,null,function*(){let t=this.currentUser();if(!t?.id)return;let e=this.userForm.value,r={id:t.id,email:e.email,username:e.username,display_name:e.display_name,role:e.role,active:e.active,notes:e.notes};yield this.userManagementService.updateUser(r),this.success.set("Usuario actualizado exitosamente"),this.isModal?this.userSaved.emit():setTimeout(()=>this.router.navigate(["/admin/users"]),2e3)})}resetForm(){this.userForm.reset({role:"user",active:!0}),this.emailAvailable.set(!0),this.usernameAvailable.set(!0),this.emailCheckMessage.set(""),this.usernameCheckMessage.set("")}checkEmailAvailability(){return v(this,null,function*(){let t=this.userForm.get("email")?.value;if(!t||this.userForm.get("email")?.invalid){this.emailCheckMessage.set("");return}if(this.isEditMode()){let r=this.currentUser();if(r&&r.email===t){this.emailAvailable.set(!0),this.emailCheckMessage.set("");return}}let e=yield this.registrationService.checkEmailAvailability(t);this.emailAvailable.set(e),e?this.emailCheckMessage.set("Correo electr\xF3nico disponible"):this.emailCheckMessage.set("Este correo electr\xF3nico ya est\xE1 registrado")})}checkUsernameAvailability(){return v(this,null,function*(){let t=this.userForm.get("username")?.value;if(!t||this.userForm.get("username")?.invalid){this.usernameCheckMessage.set("");return}if(this.isEditMode()){let r=this.currentUser();if(r&&r.username===t){this.usernameAvailable.set(!0),this.usernameCheckMessage.set("");return}}let e=yield this.registrationService.checkUsernameAvailability(t);this.usernameAvailable.set(e),e?this.usernameCheckMessage.set("Nombre de usuario disponible"):this.usernameCheckMessage.set("Este nombre de usuario ya est\xE1 en uso")})}goToLogin(){this.isModal?this.modalClosed.emit():this.router.navigate(["/login"])}goToUserManagement(){this.isModal?this.modalClosed.emit():this.router.navigate(["/admin/users"])}hasFieldError(t){let e=this.userForm.get(t);return!!(e?.invalid&&e?.touched)}getFieldError(t){let e=this.userForm.get(t);if(e?.invalid&&e?.touched){if(e.errors?.required)return"Este campo es obligatorio";if(e.errors?.email)return"Ingrese un correo electr\xF3nico v\xE1lido";if(e.errors?.minlength)return`Debe contener al menos ${e.errors?.minlength.requiredLength} caracteres`;if(e.errors?.pattern&&t==="username")return"Solo se permiten letras, n\xFAmeros y guiones bajos"}return""}markFormGroupTouched(){Object.keys(this.userForm.controls).forEach(t=>{this.userForm.get(t)?.markAsTouched()})}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=O({type:i,selectors:[["app-user"]],inputs:{isModal:"isModal",editMode:"editMode",userToEdit:"userToEdit"},outputs:{userSaved:"userSaved",modalClosed:"modalClosed"},features:[P],decls:43,vars:28,consts:[[3,"ngClass"],[1,"text-center","mb-4"],[1,"alert","alert-success","border-0","bg-success","bg-opacity-10","mb-4"],[1,"alert","alert-danger","border-0","bg-danger","bg-opacity-10","mb-4"],[1,"card","border-0","shadow-sm","mb-4"],["novalidate","",3,"ngSubmit","formGroup"],[1,"row","g-3"],[1,"col-12"],["for","email",1,"form-label","small","fw-medium"],[1,"text-danger"],["type","email","id","email","formControlName","email","placeholder","usuario@ejemplo.com",1,"form-control","form-control-sm",3,"blur"],[1,"invalid-feedback","small"],[1,"form-text","small",3,"ngClass"],["for","username",1,"form-label","small","fw-medium"],["type","text","id","username","formControlName","username","placeholder","usuario123",1,"form-control","form-control-sm",3,"blur"],["for","display_name",1,"form-label","small","fw-medium"],["type","text","id","display_name","formControlName","display_name","placeholder","Nombre Apellido",1,"form-control","form-control-sm"],["for","notes",1,"form-label","small","fw-medium"],["id","notes","formControlName","notes","rows","3","placeholder","Informaci\xF3n adicional sobre el usuario (opcional)",1,"form-control","form-control-sm"],[1,"row","g-2","mt-4"],[1,"d-flex","justify-content-end","gap-2","mt-4"],[1,"text-center","mt-4"],[1,"bg-white","rounded-circle","shadow-sm","d-inline-flex","align-items-center","justify-content-center","mb-3",2,"width","64px","height","64px"],[1,"bi","text-dark",2,"font-size","1.5rem",3,"ngClass"],[1,"h4","fw-bold","text-dark","mb-2"],[1,"text-muted","small","mb-0"],[1,"d-flex","align-items-center"],[1,"bi","bi-check-circle-fill","text-success","me-2"],[1,"fw-medium"],[1,"bi","bi-exclamation-triangle-fill","text-danger","me-2"],[1,"card-body","text-center","py-4"],["role","status",1,"spinner-border","spinner-border-sm","text-dark","mb-2"],[1,"visually-hidden"],[1,"bi","me-1",3,"ngClass"],[1,"col-12","col-md-6"],["for","role",1,"form-label","small","fw-medium"],["id","role","formControlName","role",1,"form-select","form-select-sm"],["value","user"],["value","admin"],["value","guest"],["for","active",1,"form-label","small","fw-medium"],["id","active","formControlName","active",1,"form-select","form-select-sm"],[3,"value"],["for","password",1,"form-label","small","fw-medium"],["type","password","id","password","formControlName","password","placeholder","\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",1,"form-control","form-control-sm"],["type","password","id","password","formControlName","password","placeholder","Dejar vac\xEDo para mantener la actual",1,"form-control","form-control-sm"],[1,"form-text","small","text-muted"],["type","button",1,"btn","btn-outline-secondary","btn-sm","w-100",3,"click"],["type","submit",1,"btn","btn-dark","btn-sm","w-100",3,"disabled"],["role","status",1,"spinner-border","spinner-border-sm","me-2"],["type","button",1,"btn","btn-secondary","btn-sm",3,"click"],["type","submit",1,"btn","btn-dark","btn-sm",3,"disabled"],["href","/login",1,"text-decoration-none","fw-medium"]],template:function(e,r){if(e&1&&(a(0,"div",0)(1,"div",0)(2,"div",0)(3,"div",0),c(4,X,7,3,"div",1),c(5,ee,5,1,"div",2),c(6,te,5,1,"div",3),c(7,ie,7,1,"div",4),a(8,"div",0)(9,"div",0)(10,"form",5),C("ngSubmit",function(){return r.onSubmit()}),a(11,"div",6)(12,"div",7)(13,"label",8),s(14," Correo electr\xF3nico "),a(15,"span",9),s(16,"*"),o()(),a(17,"input",10),C("blur",function(){return r.checkEmailAvailability()}),o(),c(18,re,2,1,"div",11)(19,ne,3,3,"div",12),o(),a(20,"div",7)(21,"label",13),s(22,"Nombre de usuario"),o(),a(23,"input",14),C("blur",function(){return r.checkUsernameAvailability()}),o(),c(24,ae,2,1,"div",11)(25,oe,3,3,"div",12),o(),a(26,"div",7)(27,"label",15),s(28," Nombre completo "),a(29,"span",9),s(30,"*"),o()(),u(31,"input",16),c(32,se,2,1,"div",11),o(),c(33,le,18,2),c(34,ce,7,3,"div",7)(35,me,6,0,"div",7),a(36,"div",7)(37,"label",17),s(38,"Notas adicionales"),o(),u(39,"textarea",18),o()(),c(40,ge,10,5,"div",19)(41,fe,7,3,"div",20),o()()(),c(42,he,5,0,"div",21),o()()()()),e&2){let p,M;l("ngClass",r.isModal?"p-4":"min-vh-100 bg-light py-4"),n(),l("ngClass",r.isModal?"":"container"),n(),l("ngClass",r.isModal?"":"row justify-content-center"),n(),l("ngClass",r.isModal?"":"col-12 col-md-8 col-lg-6 col-xl-5"),n(),m(r.isModal?-1:4),n(),m(r.success()?5:-1),n(),m(r.error()?6:-1),n(),m(r.processing()?7:-1),n(),l("ngClass",r.isModal?"":"card border-0 shadow-sm"),n(),l("ngClass",r.isModal?"":"card-body p-4"),n(),l("formGroup",r.userForm),n(7),x("is-invalid",r.hasFieldError("email")||!r.emailAvailable()&&!r.isEditMode())("is-valid",!r.hasFieldError("email")&&r.emailAvailable()&&((p=r.userForm.get("email"))==null?null:p.value)),n(),m(r.hasFieldError("email")?18:r.emailCheckMessage()&&!r.isEditMode()?19:-1),n(5),x("is-invalid",r.hasFieldError("username")||!r.usernameAvailable()&&!r.isEditMode())("is-valid",!r.hasFieldError("username")&&r.usernameAvailable()&&((M=r.userForm.get("username"))==null?null:M.value)),n(),m(r.hasFieldError("username")?24:r.usernameCheckMessage()&&!r.isEditMode()?25:-1),n(7),x("is-invalid",r.hasFieldError("display_name")),n(),m(r.hasFieldError("display_name")?32:-1),n(),m(r.isEditMode()?33:-1),n(),m(r.isEditMode()?35:34),n(6),m(r.isModal?41:40),n(2),m(r.isEditMode()?-1:42)}},dependencies:[A,T,Z,V,Y,B,q,G,R,L,H,j,z,D],styles:[".min-vh-100[_ngcontent-%COMP%]{background:linear-gradient(135deg,var(--bs-light) 0%,#f8f9fa 100%)}.form-floating[_ngcontent-%COMP%]{position:relative}.form-floating[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]{transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}.form-floating[_ngcontent-%COMP%]   .form-control[_ngcontent-%COMP%]:focus{border-color:var(--bs-primary);box-shadow:0 0 0 .2rem rgba(var(--bs-primary-rgb),.25)}.form-floating[_ngcontent-%COMP%]   .form-control.is-invalid[_ngcontent-%COMP%]{border-color:var(--bs-danger)}.form-floating[_ngcontent-%COMP%]   .form-control.is-invalid[_ngcontent-%COMP%]:focus{border-color:var(--bs-danger);box-shadow:0 0 0 .2rem rgba(var(--bs-danger-rgb),.25)}.form-floating[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{color:var(--bs-secondary);transition:all .15s ease-in-out}.card[_ngcontent-%COMP%]{border-radius:1rem;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.card[_ngcontent-%COMP%]   .card-body[_ngcontent-%COMP%]{position:relative}.bg-success.bg-opacity-10[_ngcontent-%COMP%]{background-color:rgba(var(--bs-success-rgb),.1)!important}.btn[_ngcontent-%COMP%]{border-radius:.5rem;font-weight:500;transition:all .2s ease-in-out}.btn.btn-lg[_ngcontent-%COMP%]{font-size:1rem;font-weight:600}.btn[_ngcontent-%COMP%]:hover{transform:translateY(-1px);box-shadow:0 4px 8px #00000026}.btn[_ngcontent-%COMP%]:disabled{transform:none;box-shadow:none}.spinner-border[_ngcontent-%COMP%]{animation:spinner-border .75s linear infinite}.rounded-circle[_ngcontent-%COMP%]{transition:all .3s ease-in-out}.rounded-circle[_ngcontent-%COMP%]:hover{transform:scale(1.05)}.alert[_ngcontent-%COMP%]{border-radius:.75rem}.alert.alert-success[_ngcontent-%COMP%]{background-color:rgba(var(--bs-success-rgb),.1);border:1px solid rgba(var(--bs-success-rgb),.2);color:var(--bs-success-text-emphasis)}.alert.alert-danger[_ngcontent-%COMP%]{background-color:rgba(var(--bs-danger-rgb),.1);border:1px solid rgba(var(--bs-danger-rgb),.2);color:var(--bs-danger-text-emphasis)}.form-text[_ngcontent-%COMP%]{font-size:.875rem}.form-text.text-success[_ngcontent-%COMP%]{color:var(--bs-success)!important}.form-text.text-danger[_ngcontent-%COMP%]{color:var(--bs-danger)!important}@media (max-width: 768px){.card-body[_ngcontent-%COMP%]{padding:2rem 1.5rem!important}.btn-lg[_ngcontent-%COMP%]{padding:.75rem 1rem;font-size:.95rem}.h3[_ngcontent-%COMP%]{font-size:1.5rem}}@media (max-width: 576px){.min-vh-100[_ngcontent-%COMP%]{padding:2rem 0}.card-body[_ngcontent-%COMP%]{padding:1.5rem 1rem!important}.col-12[_ngcontent-%COMP%]{padding-left:1rem;padding-right:1rem}}"]})};export{Q as a};
