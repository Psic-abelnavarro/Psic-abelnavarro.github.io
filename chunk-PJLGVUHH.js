import{a as U}from"./chunk-MPC7SZEK.js";import{l as P}from"./chunk-CF2QCA26.js";import{A as s,I as d,Q as R,S as l,V as E,Y as w,Z as v,g as f,k as i,q as o}from"./chunk-6O7NOF42.js";import{a as b,b as g}from"./chunk-FK42CRUA.js";var S=new w("USER_REPOSITORY"),D=class m{constructor(e,r){this.userRepository=e;this.authService=r}usersSubject=new f([]);loadingSubject=new f(!1);userCache=new Map;get users$(){return this.usersSubject.asObservable()}get loading$(){return this.loadingSubject.asObservable()}getUserById(e){let r=this.userCache.get(e);return r?i(r):(this.setLoading(!0),this.userRepository.findById(e).pipe(o(t=>{if(!t.success||!t.data)throw new Error(t.error||"Usuario no encontrado");return this.userCache.set(e,t.data),t.data}),s(t=>{throw new Error(t.message||"Error obteniendo usuario")}),l(()=>this.setLoading(!1))))}getUserByEmail(e){return this.setLoading(!0),this.userRepository.findByEmail(e).pipe(o(r=>{if(!r.success||!r.data)throw new Error(r.error||"Usuario no encontrado");return this.userCache.set(r.data.id,r.data),r.data}),s(r=>{throw new Error(r.message||"Error buscando usuario")}),l(()=>this.setLoading(!1)))}createUser(e){let r=this.authService.currentUser;if(!r||r.role==="participant")throw new Error("No tienes permisos para crear usuarios");if(!e.email||!e.fullName)throw new Error("Email y nombre completo son requeridos");return this.setLoading(!0),this.userRepository.create(e).pipe(o(t=>{if(!t.success||!t.data)throw new Error(t.error||"Error creando usuario r\xE1pido");this.userCache.set(t.data.id,t.data);let n=this.usersSubject.value;return n.length>0&&this.usersSubject.next([t.data,...n]),t.data}),s(t=>{throw new Error(t.message||"Error creando usuario r\xE1pido")}),l(()=>this.setLoading(!1)))}createQuickUser(e){let r=this.authService.currentUser;if(!r||r.role==="participant")throw new Error("No tienes permisos para crear usuarios");if(!e.email||!e.fullName)throw new Error("Email y nombre completo son requeridos");return this.setLoading(!0),this.userRepository.createQuickUser(e).pipe(o(t=>{if(!t.success||!t.data)throw new Error(t.error||"Error creando usuario r\xE1pido");this.userCache.set(t.data.id,t.data);let n=this.usersSubject.value;return n.length>0&&this.usersSubject.next([t.data,...n]),t.data}),s(t=>{throw new Error(t.message||"Error creando usuario r\xE1pido")}),l(()=>this.setLoading(!1)))}getUsers(e=1,r=20,t,n="created_at",u="desc"){this.setLoading(!0);let p=g(b({},t),{page:e,pageSize:r,sortBy:n,sortDirection:u});return this.userRepository.findAll(p).pipe(o(a=>({items:a.items.map(h=>U.user.toListItem(h)),pagination:{currentPage:a.page,totalPages:a.totalPages,totalItems:a.total,itemsPerPage:a.pageSize,hasNextPage:a.hasNextPage,hasPrevPage:a.hasPreviousPage,nextPage:a.hasNextPage?a.page+1:void 0,prevPage:a.hasPreviousPage?a.page-1:void 0},filters:p,sorting:{field:n,direction:u}})),s(a=>{throw console.error("Error obteniendo usuarios:",a),new Error(a.message||"Error obteniendo usuarios")}),d(()=>this.setLoading(!1)))}updateUserProfile(e,r){return this.setLoading(!0),this.userRepository.update(e,r).pipe(o(t=>{if(!t.success||!t.data)throw new Error(t.error||"Error actualizando perfil");return this.userCache.set(e,t.data),t.data}),s(t=>{throw new Error(t.message||"Error actualizando perfil")}),l(()=>this.setLoading(!1)))}toggleUserStatus(e){return this.setLoading(!0),this.userRepository.findById(e).pipe(R(r=>{if(!r.success||!r.data)throw new Error(r.error||"Usuario no encontrado");let t=!r.data.isActive;return this.userRepository.activateDeactivate(e,t)}),o(r=>{if(!r.success||!r.data)throw new Error(r.error||"Error cambiando estado del usuario");return this.userCache.set(e,r.data),r.data}),s(r=>{throw new Error(r.message||"Error cambiando estado del usuario")}),d(()=>this.setLoading(!1)))}changeUserRole(e,r){return this.setLoading(!0),this.userRepository.changeRole(e,r).pipe(o(t=>{if(!t.success||!t.data)throw new Error(t.error||"Error cambiando rol del usuario");return this.userCache.set(e,t.data),t.data}),s(t=>{throw new Error(t.message||"Error cambiando rol del usuario")}),l(()=>this.setLoading(!1)))}verifyUserEmail(e){return this.setLoading(!0),this.userRepository.verifyEmail(e).pipe(o(r=>r.success===!0),s(()=>i(!1)),d(()=>this.setLoading(!1)))}verifyUserPhone(e){return this.setLoading(!0),this.userRepository.verifyPhone(e).pipe(o(r=>r.success===!0),s(()=>i(!1)),d(()=>this.setLoading(!1)))}getUserStats(e){return this.userRepository.getStats(e).pipe(o(r=>({eventsAttended:r?.eventsAttended??0,certificatesEarned:r?.certificatesEarned??0,upcomingEvents:r?.upcomingEvents??0,totalRegistrations:r?.totalRegistrations??0,attendanceRate:r?.attendanceRate??0})),s(()=>i({eventsAttended:0,certificatesEarned:0,upcomingEvents:0,totalRegistrations:0,attendanceRate:0})))}searchUsers(e,r=10){return!e||e.length<3?i([]):this.userRepository.search(e).pipe(o(t=>t.slice(0,r)),s(()=>i([])))}queryUsersForAutocomplete(e){return this.userRepository.queryUsers(e).pipe(s(r=>(console.error("Error in queryUsersForAutocomplete:",r),i([]))))}preloadUsersForAutocomplete(e=15){let r={query:"",limit:e};return this.userRepository.queryUsers(r).pipe(s(t=>(console.error("Error in preloadUsersForAutocomplete:",t),i([]))))}checkEmailAvailability(e,r){return this.userRepository.findByEmail(e).pipe(o(t=>!t.success||!t.data?!0:r?t.data.id===r:!1),s(()=>i(!1)))}checkDocumentAvailability(e,r){return this.userRepository.findByDocument(e).pipe(o(t=>!t.success||!t.data?!0:r?t.data.id===r:!1),s(()=>i(!1)))}getRecentUsers(e=5){return this.userRepository.findRecentlyRegistered(30).pipe(o(r=>r.slice(0,e).map(t=>U.user.toListItem(t))),s(()=>i([])))}exportUsers(e,r="xlsx"){let t=e?.pageSize??1e3,n=e?.page??1,u=g(b({},e),{page:n,pageSize:t});return this.userRepository.findAll(u).pipe(o(p=>{let a=["Email","Nombre","Rol","Estado","Fecha Registro"],y=p.items.map(c=>[c.email,c.fullName,c.role,c.isActive?"Activo":"Inactivo",c.createdAt]),h=[a,...y].map(c=>c.map(L=>`"${(L??"").toString().replace(/"/g,'""')}"`).join(",")).join(`
`),O=r==="csv"?"text/csv":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";return new Blob([h],{type:O})}),s(()=>{throw new Error("Error exportando usuarios")}))}validateProfileData(e){let r=[];return e.fullName&&e.fullName.trim().length<2&&r.push("El nombre debe tener al menos 2 caracteres"),e.documentNumber&&(e.documentType==="DNI"&&!/^\d{8}$/.test(e.documentNumber)?r.push("DNI debe tener 8 d\xEDgitos"):e.documentType==="RUC"&&!/^\d{11}$/.test(e.documentNumber)&&r.push("RUC debe tener 11 d\xEDgitos")),e.phone&&!/^(\+51|51)?[9]\d{8}$/.test(e.phone)&&r.push("Formato de tel\xE9fono inv\xE1lido (ej: +51987654321)"),r}calculateProfileCompletion(e){let r=[{key:"fullName",label:"Nombre completo",value:e.fullName},{key:"documentType",label:"Tipo de documento",value:e.documentType},{key:"documentNumber",label:"N\xFAmero de documento",value:e.documentNumber},{key:"phone",label:"Tel\xE9fono",value:e.phone},{key:"departmentId",label:"Departamento",value:e.departmentId},{key:"institution",label:"Instituci\xF3n",value:e.institution},{key:"jobTitle",label:"Cargo",value:e.jobTitle}],t=r.filter(u=>!!u.value),n=r.filter(u=>!u.value).map(u=>u.label);return{percentage:Math.round(t.length/r.length*100),missingFields:n}}setLoading(e){this.loadingSubject.next(e)}deleteUser(e){return this.setLoading(!0),this.userRepository.delete(e).pipe(o(r=>r.success===!0),s(()=>i(!1)),d(()=>this.setLoading(!1)))}setUserActive(e,r){return this.setLoading(!0),this.userRepository.activateDeactivate(e,r).pipe(o(t=>{if(!t.success||!t.data)throw new Error(t.error||"Error actualizando estado");return this.userCache.set(e,t.data),t.data}),s(t=>{throw new Error(t.message||"Error actualizando estado")}),d(()=>this.setLoading(!1)))}getUsersByRole(e){return this.userRepository.findByRole(e)}getUsersByDepartment(e){return this.userRepository.findByDepartment(e)}getRecentlyRegistered(e,r=10){return this.userRepository.findRecentlyRegistered(e).pipe(o(t=>t.slice(0,r)),s(()=>i([])))}getDashboardStats(){return this.userRepository.getDashboardStats()}static \u0275fac=function(r){return new(r||m)(v(S),v(P))};static \u0275prov=E({token:m,factory:m.\u0275fac,providedIn:"root"})};export{S as a,D as b};
