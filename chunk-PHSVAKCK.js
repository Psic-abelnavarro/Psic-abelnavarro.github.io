import{a as T}from"./chunk-CYLPXQIR.js";import{a as A,b as l,c as b}from"./chunk-TMGCMHHJ.js";import{l as y}from"./chunk-IIPOJGOQ.js";import{A as c,D,H as E,Q as v,S as g,V as N,Y as C,_ as h,bc as I,k as n,ma as R,q as o,r as S}from"./chunk-5W5GNUFO.js";import{a as f}from"./chunk-FK42CRUA.js";var O=new C("REGISTRATION_REPOSITORY"),P=class m{CACHE_TTL_MS=3*60*1e3;SEARCH_DEBOUNCE_MS=300;authService=h(y);registrationRepository=h(O);staticDataService=h(T);registrationsSig=R([]);myRegistrationsSig=R([]);loadingSig=R(!1);searchSig=R("");filtersSig=R({});registrationCache=new Map;registrationCacheTs=new Map;registrationStatesSig=b(this.staticDataService.registrationStates$,{initialValue:null});statusFlow={draft:["pending_validation","cancelled_by_user"],pending_validation:["payment_required","confirmed"],payment_required:["payment_pending","cancelled_by_user"],payment_pending:["confirmed","payment_failed"],payment_failed:["payment_pending","cancelled_by_user"],confirmed:["checked_in","no_show"],waitlist:["pending_validation","cancelled_by_user"],checked_in:["attended"],attended:[],no_show:[],cancelled_by_user:[],cancelled_by_admin:[]};searchParamsSig=b(S([l(this.searchSig).pipe(D(this.SEARCH_DEBOUNCE_MS),E()),l(this.filtersSig).pipe(E((e,t)=>JSON.stringify(e)===JSON.stringify(t)))]),{initialValue:["",{}]});searchEffect=I(()=>{let[e,t]=this.searchParamsSig();!e&&(!t||Object.keys(t).length===0)||this.performSearch(e,t)});get registrations$(){return l(this.registrationsSig)}get myRegistrations$(){return l(this.myRegistrationsSig)}get loading$(){return l(this.loadingSig)}get searchQuery$(){return l(this.searchSig)}get filters$(){return l(this.filtersSig)}getRegistrationById(e){return this.isRegistrationCached(e)?n(this.registrationCache.get(e)):(this.setLoading(!0),this.registrationRepository.findById(e).pipe(o(t=>{if(!t.success||!t.data)throw new Error(t.error||"Inscripci\xF3n no encontrada");return this.updateRegistrationCache(e,t.data),t.data}),c(t=>{throw new Error(t.message||"Error obteniendo inscripci\xF3n")}),g(()=>this.setLoading(!1))))}getRegistrations(e=1,t=20,i,r={field:"created_at",direction:"desc"}){this.setLoading(!0);let s=this.convertToRepositoryFilters(i||{},e,t);return this.registrationRepository.findAll(s).pipe(o(a=>({items:a.items.map(p=>(this.updateRegistrationCache(p.id,p),this.toCardViewModel(p))),pagination:{currentPage:a.page,totalPages:a.totalPages,totalItems:a.total,itemsPerPage:a.pageSize,hasNextPage:a.hasNextPage,hasPrevPage:a.hasPreviousPage,nextPage:a.hasNextPage?a.page+1:void 0,prevPage:a.hasPreviousPage?a.page-1:void 0},filters:i,sorting:{field:r.field,direction:r.direction}})),c(a=>{throw new Error(a.message||"Error obteniendo inscripciones")}),g(a=>{this.registrationsSig.set(a.items),this.setLoading(!1)}))}createRegistration(e){if(!this.authService.currentUser)throw new Error("Usuario no autenticado");let i=this.validateRegistrationData(e);if(i.length>0)throw new Error(i.join(", "));return this.setLoading(!0),this.registrationRepository.create(e).pipe(o(r=>{if(!r.success||!r.data)throw new Error(r.error||"Error creando inscripci\xF3n");return this.updateRegistrationCache(r.data.id,r.data),r.data}),c(r=>{throw new Error(r.message||"Error creando inscripci\xF3n")}),g(()=>this.setLoading(!1)))}updateRegistration(e,t){if(!this.authService.currentUser)throw new Error("Usuario no autenticado");this.setLoading(!0);let r={notes:t.specialRequirements,metadata:{firstName:t.firstName,lastName:t.lastName,email:t.email,phone:t.phone,institution:t.institution,position:t.position},participantRoleId:t.participantRoleId};return this.registrationRepository.update(e,r).pipe(o(s=>{if(!s.success||!s.data)throw new Error(s.error||"Error actualizando inscripci\xF3n");return this.updateRegistrationCache(e,s.data),s.data}),c(s=>{throw new Error(s.message||"Error actualizando inscripci\xF3n")}),g(()=>this.setLoading(!1)))}getRegisteredUserIds(e,t){return this.registrationRepository.getRegisteredUserIds(e,t).pipe(c(i=>(console.error("Error obteniendo IDs de usuarios registrados:",i),n({userIds:[]}))))}cancelRegistration(e,t){if(!this.authService.currentUser)return n({success:!1,message:"Usuario no autenticado"});this.setLoading(!0);let r={newStateKey:"cancelled_by_user",notes:t};return this.registrationRepository.changeState(e,r).pipe(o(s=>!s.success||!s.data?{success:!1,message:s.error||"Error cancelando inscripci\xF3n"}:(this.updateRegistrationCache(e,s.data),{success:!0,message:"Inscripci\xF3n cancelada exitosamente",newStatus:"cancelled_by_user"})),c(s=>n({success:!1,message:s.message||"Error cancelando inscripci\xF3n"})),g(()=>this.setLoading(!1)))}changeRegistrationState(e,t,i){return this.authService.currentUser?this.getRegistrationById(e).pipe(v(s=>{let a=this.getDetailedStateFromRegistration(s),u=this.validateStateTransition(a,t);if(u)return n({success:!1,message:u});this.setLoading(!0);let p={newStateKey:t,notes:i?.notes,metadata:i};return this.registrationRepository.changeState(e,p).pipe(o(d=>!d.success||!d.data?{success:!1,message:d.error||"Error cambiando estado"}:(this.updateRegistrationCache(e,d.data),{success:!0,message:this.getStateChangeMessage(t),newStatus:t,paymentRequired:t==="payment_pending"})),c(d=>n({success:!1,message:d.message||"Error cambiando estado"})),g(()=>this.setLoading(!1)))})):n({success:!1,message:"Usuario no autenticado"})}confirmRegistration(e){return this.changeRegistrationState(e,"confirmed")}submitForValidation(e){return this.changeRegistrationState(e,"pending_validation")}addToWaitlist(e){return this.changeRegistrationState(e,"waitlist")}markAsNoShow(e){return this.changeRegistrationState(e,"no_show")}checkInParticipant(e){let t=this.authService.currentUser;return!t||t.role==="participant"?n({success:!1,message:"No tienes permisos para registrar asistencia"}):(this.setLoading(!0),this.registrationRepository.checkIn(e).pipe(o(i=>!i.success||!i.data?{success:!1,message:i.error||"Error en check-in"}:(this.registrationCache.set(e,i.data),{success:!0,message:"Check-in realizado exitosamente",newStatus:"checked_in"})),c(i=>n({success:!1,message:i.message||"Error en check-in"})),g(()=>this.setLoading(!1))))}markAsAttended(e,t=100){let i=this.authService.currentUser;return!i||i.role==="participant"?n({success:!1,message:"No tienes permisos para registrar asistencia"}):(this.setLoading(!0),this.registrationRepository.verifyAttendance(e,t).pipe(o(r=>{if(!r.success||!r.data)return{success:!1,message:r.error||"Error verificando asistencia"};this.registrationCache.set(e,r.data);let s=t>=80?"attended":"no_show";return{success:!0,message:`Asistencia verificada: ${t}%`,newStatus:s}}),c(r=>n({success:!1,message:r.message||"Error verificando asistencia"})),g(()=>this.setLoading(!1))))}initiatePayment(e,t,i){if(!this.authService.currentUser)return n({success:!1,message:"Usuario no autenticado"});this.setLoading(!0);let s="Pagos no implementados en esta etapa";return this.setLoading(!1),n({success:!1,message:s})}initializeSearch(){}setSearchQuery(e){this.searchSig.set(e)}setFilters(e){this.filtersSig.set(e)}clearSearch(){this.searchSig.set(""),this.filtersSig.set({})}performSearch(e,t){let i=this.convertToRepositoryFilters(t,1,20);this.registrationRepository.findAll(i).pipe(o(r=>r.items.map(s=>(this.updateRegistrationCache(s.id,s),this.toCardViewModel(s)))),c(()=>n([]))).pipe(A()).subscribe(r=>{this.registrationsSig.set(r)})}getMyRegistrations(){let e=this.authService.currentUser;return e?this.registrationRepository.findByUserId(e.id).pipe(o(t=>{let i=t.map(r=>(this.updateRegistrationCache(r.id,r),this.toCardViewModel(r)));return this.myRegistrationsSig.set(i),i}),c(()=>n([]))):n([])}getRegistrationStats(e){return this.registrationRepository.getEventStats(e).pipe(o(t=>({totalRegistrations:t.totalRegistrations||0,byStatus:t.byStatus||{},byPaymentStatus:t.byPaymentStatus||{},attendanceRate:t.attendanceRate||0})),c(()=>n({totalRegistrations:0,byStatus:{},byPaymentStatus:{},attendanceRate:0})))}createQuickRegistration(e){let t=this.authService.currentUser;return!t||t.role==="participant"?n({success:!1,message:"No tienes permisos para registro r\xE1pido"}):(this.setLoading(!0),this.registrationRepository.quickRegister(e.eventId,e.userId,e.participantRoleId).pipe(o(i=>!i.success||!i.data?{success:!1,message:i.error||"Error en registro r\xE1pido"}:(this.updateRegistrationCache(i.data.id,i.data),{success:!0,message:"Registro r\xE1pido completado: Inscrito \u2192 Confirmado \u2192 Check-in \u2192 Asistido",newStatus:"attended"})),c(i=>n({success:!1,message:i.message||"Error en registro r\xE1pido"})),g(()=>this.setLoading(!1))))}processQuickRegistrationSequence(e){return n({success:!0,message:"Secuencia r\xE1pida gestionada por el repositorio"})}bulkCreateQuickRegistration(e,t,i=1){let r=this.authService.currentUser;if(!r||r.role==="participant")return n({success:0,failed:t.length,results:t.map(a=>({userId:a,success:!1,message:"No tienes permisos para registro r\xE1pido m\xFAltiple"}))});this.setLoading(!0);let s=t.map(a=>this.createQuickRegistration({eventId:e,userId:a,participantRoleId:i}).pipe(o(u=>({userId:a,success:u.success,message:u.message})),c(()=>n({userId:a,success:!1,message:"Error procesando usuario"}))));return S(s).pipe(o(a=>{let u=a.filter(d=>d.success).length,p=a.filter(d=>!d.success).length;return{success:u,failed:p,results:a}}),g(()=>this.setLoading(!1)))}getPendingPayments(e){return this.registrationRepository.findPendingPayments(e).pipe(o(t=>t.map(i=>(this.updateRegistrationCache(i.id,i),this.toCardViewModel(i)))),c(()=>n([])))}getEligibleForCertificates(e){return this.registrationRepository.findEligibleForCertificates(e).pipe(o(t=>t.map(i=>(this.updateRegistrationCache(i.id,i),this.toCardViewModel(i)))),c(()=>n([])))}getRegistrationsByState(e){return this.registrationRepository.findByState(e).pipe(o(t=>t.map(i=>(this.updateRegistrationCache(i.id,i),this.toCardViewModel(i)))),c(()=>n([])))}getEventRegistrations(e){return this.registrationRepository.findByEventId(e).pipe(o(t=>t.map(i=>(this.updateRegistrationCache(i.id,i),this.toCardViewModel(i)))),c(()=>n([])))}validateRegistrationData(e){let t=[];return e.eventId||t.push("ID de evento es requerido"),e.participantRoleId&&e.participantRoleId<=0&&t.push("Rol de participante inv\xE1lido"),t}validateStateTransition(e,t){return(this.statusFlow[e]||[]).includes(t)?null:`No se puede cambiar de ${e} a ${t}`}getStateChangeMessage(e){return{draft:"Inscripci\xF3n guardada como borrador",pending_validation:"Inscripci\xF3n enviada para validaci\xF3n",payment_required:"Se requiere pago",payment_pending:"Pago pendiente",payment_failed:"Pago fallido",confirmed:"Inscripci\xF3n confirmada",waitlist:"En lista de espera",checked_in:"Registrado en evento",attended:"Asistencia confirmada",no_show:"No asisti\xF3",cancelled_by_user:"Cancelado por usuario",cancelled_by_admin:"Cancelado por administrador"}[e]||"Estado actualizado"}getDetailedStateFromRegistration(e){return e.currentState?.stateKey?e.currentState.stateKey:this.getStateKeyFromId(e.currentStateId)}toCardViewModel(e){let t=this.mapStateToStatus(e.currentStateId);return{id:e.id,eventTitle:e.event?.title||`Evento ${e.eventId}`,eventStartDate:e.event?.startDate||new Date(Date.now()+7*24*60*60*1e3).toISOString(),status:t,detailedState:e.currentState?.stateKey||"draft",paymentRequired:(e.paymentInfo?.totalAmount||0)>(e.paymentInfo?.paidAmount||0),paymentAmount:e.paymentInfo?.totalAmount,userName:e.user?.fullName||"Usuario desconocido",userEmail:e.user?.email||"",registrationDate:e.createdAt,canCancel:e.permissions?.canCancel||!1,canEdit:e.permissions?.canEdit||!1}}mapStateToStatus(e){switch(this.getStateKeyFromId(e)){case"draft":case"pending_validation":case"payment_required":case"payment_pending":return"pending";case"payment_failed":case"cancelled_by_user":case"cancelled_by_admin":return"cancelled";case"confirmed":case"waitlist":case"checked_in":return"confirmed";case"attended":return"attended";case"no_show":return"no_show";default:return"pending"}}setLoading(e){this.loadingSig.set(e)}processFilters(e){if(!e)return{};let t=f({},e);return e.status&&(t.status=e.status.join(",")),e.detailedState&&(t.detailedState=e.detailedState.join(",")),t}isRegistrationCached(e){let t=this.registrationCacheTs.get(e);return t?Date.now()-t<this.CACHE_TTL_MS&&this.registrationCache.has(e):!1}updateRegistrationCache(e,t){this.registrationCache.set(e,t),this.registrationCacheTs.set(e,Date.now())}getStateKeyFromId(e){let t=this.registrationStatesSig();if(t){let i=t[String(e)];if(i?.stateKey)return i.stateKey}return"draft"}convertToRepositoryFilters(e,t,i){let r=this.authService.currentUser,s=e.detailedState?.[0]||void 0;return{eventId:e.eventId,userId:e.myRegistrations&&r?r.id:e.userId,participantRoleId:void 0,status:s,dateFrom:e.startDate,dateTo:e.endDate,attendanceVerified:e.hasAttended,page:t,pageSize:i}}static \u0275fac=function(t){return new(t||m)};static \u0275prov=N({token:m,factory:m.\u0275fac,providedIn:"root"})};export{O as a,P as b};
