import"./chunk-VXK4KFJ3.js";import"./chunk-PLLGRK62.js";import"./chunk-FK6H3RFT.js";import{a as he}from"./chunk-U3NQJ2F2.js";import{b as O}from"./chunk-BWDGGP5N.js";import"./chunk-ZS5CCIUB.js";import{b as Ce}from"./chunk-663N75WB.js";import{a as fe}from"./chunk-RCRSDNNN.js";import{b as le,c as oe,e as B,i as re,l as de,o as se,p as ce,q as me,v as pe,w as Q,x as ue}from"./chunk-XPHFKPJP.js";import"./chunk-3AZUY6EQ.js";import{a as ge}from"./chunk-GY3IPELX.js";import"./chunk-MPC7SZEK.js";import{a as T}from"./chunk-TVASKIN6.js";import{k as ae}from"./chunk-EDRQHDMA.js";import{i as ie,l as ne}from"./chunk-PZ46FPEX.js";import{$a as K,Ab as P,Cc as L,D as q,Da as r,Db as Z,Gb as o,H as J,Hb as v,Ib as f,Lb as A,Mb as W,Na as V,Nb as $,Rb as ee,_ as E,ab as X,ac as x,bb as p,bc as te,cb as u,da as C,ea as h,eb as Y,fb as M,fc as j,gb as D,gc as z,hb as _,hc as N,ia as k,ib as i,jb as n,kb as d,ma as b,o as U,rb as y,sb as S,ub as c,zb as F}from"./chunk-DCXCOY7M.js";import"./chunk-LJ5XHLMQ.js";import{a as w,b as R,h as G}from"./chunk-FK42CRUA.js";var ye=["modal"],Ee=(l,t)=>t.id;function Te(l,t){if(l&1&&(i(0,"option",20),o(1),n()),l&2){let e=t.$implicit;_("value",e.id),r(),v(e.name)}}function Ie(l,t){if(l&1&&(i(0,"div",27),d(1,"i",28),o(2),n()),l&2){let e=c(2);r(2),f(" ",e.error()," ")}}function we(l,t){if(l&1){let e=y();i(0,"div",13),d(1,"i",14),i(2,"div")(3,"strong"),o(4,"Certificado ID:"),n(),o(5),d(6,"br"),i(7,"strong"),o(8,"Participante:"),n(),o(9),d(10,"br"),i(11,"strong"),o(12,"Plantilla actual:"),n(),o(13),n()(),i(14,"div",15)(15,"label",16),d(16,"i",17),o(17," Nueva Plantilla "),n(),i(18,"select",18),$("ngModelChange",function(s){C(e);let m=c();return W(m.newTemplateId,s)||(m.newTemplateId=s),h(s)}),i(19,"option",19),o(20,"Seleccionar nueva plantilla..."),n(),M(21,Te,2,2,"option",20,Ee),n()(),i(23,"div",15)(24,"label",21),d(25,"i",22),o(26," Raz\xF3n del cambio (opcional) "),n(),i(27,"textarea",23),$("ngModelChange",function(s){C(e);let m=c();return W(m.reason,s)||(m.reason=s),h(s)}),n()(),i(28,"div",24)(29,"input",25),$("ngModelChange",function(s){C(e);let m=c();return W(m.regenerate,s)||(m.regenerate=s),h(s)}),n(),i(30,"label",26),o(31," Regenerar PDF del certificado autom\xE1ticamente "),n()(),p(32,Ie,3,1,"div",27)}if(l&2){let e,a,s=c();r(5),f(" ",(e=s.certificate())==null?null:e.id),r(4),f(" ",(a=s.certificate())==null||a.userInfo==null?null:a.userInfo.fullName),r(4),f(" ",s.getCurrentTemplateName()," "),r(5),A("ngModel",s.newTemplateId),r(3),D(s.availableTemplates()),r(6),A("ngModel",s.reason),r(2),A("ngModel",s.regenerate),r(3),u(s.error()?32:-1)}}function Re(l,t){l&1&&(d(0,"span",29),o(1," Cambiando... "))}function Me(l,t){l&1&&(d(0,"i",30),o(1," Cambiar Plantilla "))}var H=class l{certificateService=E(O);destroyRef=E(k);modal=N("modal");certificate=z(null);templates=z([]);templateChanged=j();modalClosed=j();processing=b(!1);error=b(null);newTemplateId=null;reason="";regenerate=!1;availableTemplates=x(()=>{let t=this.certificate();return t?this.templates().filter(e=>e.id!==t.templateId):this.templates()});constructor(){te(()=>{this.certificate()&&this.resetForm()})}getCurrentTemplateName(){let t=this.certificate();return t?this.templates().find(a=>a.id===t.templateId)?.name||`Plantilla ${t.templateId}`:""}getTemplateName(t){return this.templates().find(a=>a.id===t)?.name||`Plantilla ${t}`}open(){let t=this.modal()?.nativeElement;if(t){let e=window.bootstrap;e&&(new e.Modal(t).show(),t.addEventListener("hidden.bs.modal",()=>{this.handleModalClose()}))}}close(){let t=this.modal()?.nativeElement;if(t){let e=window.bootstrap;if(e){let a=e.Modal.getInstance(t);a&&a.hide()}}}confirmChange(){let t=this.certificate();if(!t||!this.newTemplateId){this.error.set("Por favor seleccione una nueva plantilla");return}this.processing.set(!0),this.error.set(null);let e={certificateId:t.id,newTemplateId:this.newTemplateId,reason:this.reason||void 0,regenerate:this.regenerate};this.certificateService.changeCertificateTemplate(e).pipe(T(this.destroyRef)).subscribe({next:a=>{a.success?(this.templateChanged.emit({certificateId:t.id,newTemplateId:this.newTemplateId,templateName:this.getTemplateName(this.newTemplateId)}),this.close()):this.error.set(a.message||"Error cambiando plantilla")},error:a=>{this.error.set("Error cambiando plantilla: "+a.message)},complete:()=>{this.processing.set(!1)}})}handleModalClose(){this.resetForm(),this.modalClosed.emit()}resetForm(){this.newTemplateId=null,this.reason="",this.regenerate=!1,this.error.set(null),this.processing.set(!1)}static \u0275fac=function(e){return new(e||l)};static \u0275cmp=V({type:l,selectors:[["app-change-template-modal"]],viewQuery:function(e,a){e&1&&F(a.modal,ye,5),e&2&&P()},inputs:{certificate:[1,"certificate"],templates:[1,"templates"]},outputs:{templateChanged:"templateChanged",modalClosed:"modalClosed"},decls:18,vars:3,consts:[["modal",""],["id","changeTemplateModal","tabindex","-1","aria-labelledby","changeTemplateModalLabel","aria-hidden","true",1,"modal","fade"],[1,"modal-dialog"],[1,"modal-content"],[1,"modal-header"],["id","changeTemplateModalLabel",1,"modal-title"],[1,"bi","bi-arrow-repeat","me-2"],["type","button","data-bs-dismiss","modal","aria-label","Close",1,"btn-close"],[1,"modal-body"],[1,"modal-footer"],["type","button","data-bs-dismiss","modal",1,"btn","btn-secondary"],[1,"bi","bi-x-lg","me-1"],["type","button",1,"btn","btn-primary",3,"click","disabled"],[1,"alert","alert-info","d-flex","align-items-center","mb-3"],[1,"bi","bi-info-circle","me-2"],[1,"mb-3"],["for","newTemplateSelect",1,"form-label","fw-semibold"],[1,"bi","bi-file-earmark-richtext","me-1"],["id","newTemplateSelect",1,"form-select",3,"ngModelChange","ngModel"],["value",""],[3,"value"],["for","changeReason",1,"form-label","fw-semibold"],[1,"bi","bi-chat-left-text","me-1"],["id","changeReason","rows","3","placeholder","Descripci\xF3n del motivo del cambio...",1,"form-control",3,"ngModelChange","ngModel"],[1,"form-check"],["type","checkbox","id","regeneratePdf",1,"form-check-input",3,"ngModelChange","ngModel"],["for","regeneratePdf",1,"form-check-label"],[1,"alert","alert-danger","mt-3"],[1,"bi","bi-exclamation-triangle","me-2"],["role","status","aria-hidden","true",1,"spinner-border","spinner-border-sm","me-2"],[1,"bi","bi-check-lg","me-1"]],template:function(e,a){if(e&1){let s=y();i(0,"div",1,0)(2,"div",2)(3,"div",3)(4,"div",4)(5,"h5",5),d(6,"i",6),o(7," Cambiar Plantilla de Certificado "),n(),d(8,"button",7),n(),i(9,"div",8),p(10,we,33,7),n(),i(11,"div",9)(12,"button",10),d(13,"i",11),o(14," Cancelar "),n(),i(15,"button",12),S("click",function(){return C(s),h(a.confirmChange())}),p(16,Re,2,0)(17,Me,2,0),n()()()()()}e&2&&(r(10),u(a.certificate()?10:-1),r(5),_("disabled",!a.newTemplateId||a.processing()),r(),u(a.processing()?16:17))},dependencies:[L,Q,ce,me,oe,le,se,B,re],encapsulation:2})};var De=["confirmModal"],Fe=["changeTemplateModal"],Ne=()=>[1,2,3,4,5,6];function Ge(l,t){if(l&1&&(i(0,"span",17),o(1),n()),l&2){let e=c();r(),v(e.getTotalAttended())}}function ke(l,t){if(l&1){let e=y();i(0,"div",26),d(1,"i",52),i(2,"div",53),o(3),n(),i(4,"button",54),S("click",function(){C(e);let s=c();return h(s.success.set(null))}),n()()}if(l&2){let e=c();r(3),v(e.success())}}function Ve(l,t){if(l&1){let e=y();i(0,"div",27),d(1,"i",55),i(2,"div",53),o(3),n(),i(4,"button",54),S("click",function(){C(e);let s=c();return h(s.error.set(null))}),n()()}if(l&2){let e=c();r(3),v(e.error())}}function Pe(l,t){l&1&&(i(0,"span",34),o(1,"Configurado"),n())}function Ae(l,t){l&1&&(i(0,"div",41),d(1,"div",56),i(2,"small",57),o(3,"Cargando eventos..."),n()())}function We(l,t){if(l&1){let e=y();i(0,"div",42)(1,"span",45),d(2,"i",58),n(),i(3,"app-autocomplete",59),S("valueChange",function(s){C(e);let m=c();return h(m.onEventSelected(s))}),n()()}if(l&2){let e=c();r(3),_("options",e.availableEvents())("displayFn",e.displayEvent)("placeholder","Buscar eventos... ("+e.availableEvents().length+" disponibles)")("minChars",e.autocompleteConfig.minCharsLocal)("maxHeight",e.autocompleteConfig.maxHeight)("noResultsMessage","No se encontraron eventos")("formControl",e.eventAutocompleteControl)("inputClass","form-control border-start-0 bg-light form-control-sm")("inInputGroup",!0)("highlightSearch",!0)}}function $e(l,t){l&1&&(i(0,"div",43),d(1,"i",60),o(2,"No hay eventos disponibles para certificar "),n())}function Le(l,t){if(l&1&&(i(0,"div",48),d(1,"i",61),o(2),n()),l&2){let e=c();r(2),f(" Certificado: ",e.selectedRole().certificateTitle," ")}}function Be(l,t){if(l&1&&o(0),l&2){let e=c(2);f(" - ",e.formatEventDate(e.selectedEvent().endDate)," ")}}function Qe(l,t){if(l&1&&(i(0,"span",67),d(1,"i",74),i(2,"span",69),o(3),n()()),l&2){let e=c(2);r(3),v(e.selectedEvent().location)}}function Oe(l,t){if(l&1&&(i(0,"div",49)(1,"div",62)(2,"div",63)(3,"h6",64),d(4,"i",65),o(5),n(),i(6,"div",66)(7,"span",67),d(8,"i",68),i(9,"span",69),o(10),p(11,Be,1,1),n()(),p(12,Qe,4,1,"span",67),n()(),i(13,"div",70)(14,"span",71),d(15,"i",72),i(16,"span",73),o(17,"Evento Seleccionado"),n()()()()()),l&2){let e=c();r(5),f(" ",e.selectedEvent().title," "),r(5),f("",e.selectedEvent().startDate?e.formatEventDate(e.selectedEvent().startDate):"Sin fecha"," "),r(),u(e.selectedEvent().endDate?11:-1),r(),u(e.selectedEvent().location?12:-1)}}function He(l,t){if(l&1&&(i(0,"div",82),d(1,"i",65),o(2),n()),l&2){let e=c(2);r(2),f(" Plantilla sugerida: ",e.getTemplateName(e.defaultTemplateId())," ")}}function je(l,t){if(l&1){let e=y();i(0,"div",28)(1,"div",75)(2,"h6",76),d(3,"i",77),o(4," Configuraci\xF3n de Certificado "),n()(),i(5,"div",35)(6,"div",78)(7,"div",79)(8,"label",38),d(9,"i",80),o(10," Plantilla de Certificado "),n(),i(11,"div",42)(12,"span",45),d(13,"i",81),n(),i(14,"app-autocomplete",59),S("valueChange",function(s){C(e);let m=c();return h(m.onTemplateChange(s))}),n()(),p(15,He,3,1,"div",82),n(),i(16,"div",83)(17,"div",84)(18,"span",71),d(19,"i",85),o(20),n(),i(21,"span",86),d(22,"i",87),o(23),n()()()()()()}if(l&2){let e=c();r(14),_("options",e.templatesWithId())("displayFn",e.displayTemplate)("placeholder","Seleccionar plantilla... ("+e.templatesWithId().length+" disponibles)")("minChars",e.autocompleteConfig.minCharsLocal)("maxHeight",e.autocompleteConfig.maxHeight)("noResultsMessage","No se encontraron plantillas")("formControl",e.templateAutocompleteControl)("inputClass","form-control border-start-0 bg-light form-control-sm")("inInputGroup",!0)("highlightSearch",!0),r(),u(e.defaultTemplateId()?15:-1),r(5),f("",e.selectedRole().name," "),r(3),f("",e.selectedRole().certificateTitle," ")}}function ze(l,t){l&1&&(i(0,"tr")(1,"td",100),d(2,"span",101),n(),i(3,"td",100)(4,"div",30),d(5,"span",102),i(6,"div",103)(7,"div",104),d(8,"span",105)(9,"span",106),n()()()(),i(10,"td",107)(11,"div",104),d(12,"span",108)(13,"span",109),n()(),i(14,"td",110),d(15,"span",111),n(),i(16,"td",112),d(17,"span",113),n(),i(18,"td",112),d(19,"span",114),n(),i(20,"td",112),d(21,"span",115),n()())}function Ue(l,t){l&1&&(i(0,"div",50)(1,"div",88)(2,"div",89)(3,"table",90)(4,"thead",91)(5,"tr")(6,"th",92),o(7,"Sel."),n(),i(8,"th",93),o(9,"Participante"),n(),i(10,"th",94),o(11,"Email"),n(),i(12,"th",95),o(13,"Plantilla"),n(),i(14,"th",93),o(15,"Estado"),n(),i(16,"th",93),o(17,"Certificado"),n(),i(18,"th",96),o(19,"Acciones"),n()()(),i(20,"tbody"),M(21,ze,22,0,"tr",null,Y),n()()(),i(23,"div",97)(24,"div",98)(25,"span",99),o(26,"Cargando..."),n()(),i(27,"span",57),o(28,"Cargando participantes asistidos..."),n()()()()),l&2&&(r(21),D(ee(0,Ne)))}function qe(l,t){if(l&1&&(i(0,"span",71),o(1),n()),l&2){let e=c(2);r(),v(e.getTotalAttended())}}function Je(l,t){l&1&&(d(0,"span",135),i(1,"span",16),o(2,"Generando..."),n())}function Ke(l,t){if(l&1&&(d(0,"i",87),i(1,"span",16),o(2),n()),l&2){let e=c(2);r(2),f("Generar (",e.getAvailableCount(),")")}}function Xe(l,t){if(l&1){let e=y();i(0,"div",129)(1,"input",153),S("change",function(){C(e);let s=c().$implicit,m=c(2);return h(m.toggleRegistration(s.id))}),n(),i(2,"label",154),o(3," Seleccionar participante "),n()()}if(l&2){let e=c().$implicit;r(),_("id","reg-"+e.id)("checked",e.selected),r(),_("for","reg-"+e.id)}}function Ye(l,t){l&1&&d(0,"i",136)}function Ze(l,t){if(l&1&&(i(0,"span",143),d(1,"i",155),o(2),n()),l&2){let e=c().$implicit,a=c(2);r(2),f(" ",a.getDisplayTemplateName(e)," ")}}function et(l,t){if(l&1&&(i(0,"span",144),d(1,"i",155),o(2),n()),l&2){let e=c().$implicit,a=c(2);r(2),f(" ",a.getDisplayTemplateName(e)," ")}}function tt(l,t){if(l&1&&(i(0,"div",145),o(1),n()),l&2){let e=c().$implicit;r(),v(e.userInfo==null?null:e.userInfo.institution)}}function it(l,t){if(l&1&&(i(0,"div",146),o(1),n()),l&2){let e=c().$implicit;r(),f("Doc: ",e.userInfo==null?null:e.userInfo.documentNumber)}}function nt(l,t){if(l&1&&(i(0,"span",143),d(1,"i",155),o(2),n()),l&2){let e=c().$implicit,a=c(2);r(2),f(" ",a.getDisplayTemplateName(e)," ")}}function at(l,t){if(l&1&&(i(0,"span",144),d(1,"i",155),o(2),n()),l&2){let e=c().$implicit,a=c(2);r(2),f(" ",a.getDisplayTemplateName(e)," ")}}function lt(l,t){l&1&&(i(0,"span",146),o(1,"-"),n())}function ot(l,t){l&1&&(i(0,"span",150),d(1,"i",156),i(2,"span",73),o(3,"Generado"),n()())}function rt(l,t){l&1&&(i(0,"span",151),d(1,"i",157),i(2,"span",73),o(3,"Pendiente"),n()())}function dt(l,t){if(l&1){let e=y();i(0,"div",152)(1,"button",158),d(2,"i",159),n(),i(3,"ul",160)(4,"li")(5,"h6",161),o(6,"Plantilla Actual:"),n()(),i(7,"li")(8,"span",162),o(9),n()(),i(10,"li"),d(11,"hr",163),n(),i(12,"li")(13,"button",164),S("click",function(){C(e);let s=c().$implicit,m=c(2);return h(m.updateCertificateTemplate(s.existingCertificate,0))}),d(14,"i",165),o(15,"Cambiar Plantilla "),n()()()()}if(l&2){let e=c().$implicit,a=c(2);r(),_("id","dropdown-"+e.id),r(2),K("aria-labelledby","dropdown-"+e.id),r(6),f(" ",a.getTemplateName(e.existingCertificate.templateId)," ")}}function st(l,t){l&1&&(i(0,"span",121),d(1,"i",166),n())}function ct(l,t){if(l&1&&(i(0,"tr")(1,"td",100),p(2,Xe,4,3,"div",129)(3,Ye,1,0,"i",136),n(),i(4,"td",100)(5,"div",30)(6,"div",137),d(7,"i",138),n(),i(8,"div",139)(9,"div",140),o(10),n(),i(11,"div",141),o(12),n(),i(13,"div",142),p(14,Ze,3,1,"span",143)(15,et,3,1,"span",144),n(),p(16,tt,2,1,"div",145),n()()(),i(17,"td",107)(18,"div")(19,"div",146),o(20),n(),p(21,it,2,1,"div",146),n()(),i(22,"td",147)(23,"div",148),p(24,nt,3,1,"span",143)(25,at,3,1,"span",144)(26,lt,2,0,"span",146),n()(),i(27,"td",112)(28,"span",149),d(29,"i",61),i(30,"span",73),o(31,"Asistido"),n()()(),i(32,"td",112),p(33,ot,4,0,"span",150)(34,rt,4,0,"span",151),n(),i(35,"td",112),p(36,dt,16,3,"div",152)(37,st,2,0,"span",121),n()()),l&2){let e=t.$implicit,a=c(2);Z("table-active",e.selected)("bg-light",e.hasExistingCertificate),r(2),u(e.hasExistingCertificate?3:2),r(8),v((e.userInfo==null?null:e.userInfo.fullName)||"Usuario sin nombre"),r(2),v((e.userInfo==null?null:e.userInfo.email)||"Sin email"),r(2),u(e.hasExistingCertificate&&(e.existingCertificate!=null&&e.existingCertificate.templateId)?14:a.selectedTemplateId()?15:-1),r(2),u(e.userInfo!=null&&e.userInfo.institution?16:-1),r(4),v((e.userInfo==null?null:e.userInfo.email)||"Sin email"),r(),u(e.userInfo!=null&&e.userInfo.documentNumber?21:-1),r(3),u(e.hasExistingCertificate&&(e.existingCertificate!=null&&e.existingCertificate.templateId)?24:a.selectedTemplateId()?25:26),r(9),u(e.hasExistingCertificate?33:34),r(3),u(e.hasExistingCertificate&&e.existingCertificate?36:37)}}function mt(l,t){if(l&1){let e=y();i(0,"div",50)(1,"div",29)(2,"div",116)(3,"div",117)(4,"div",31),d(5,"i",118),i(6,"h6",33),o(7,"Participantes Asistidos"),n()(),p(8,qe,2,1,"span",71),n(),i(9,"div",119)(10,"div",120)(11,"span",121),o(12," Total: "),i(13,"span",122),o(14),n()(),i(15,"span",123),o(16," Disponibles: "),i(17,"span",124),o(18),n()(),i(19,"span",125),o(20," Con certificado: "),i(21,"span",124),o(22),n()()(),i(23,"div",31)(24,"button",126),S("click",function(){C(e);let s=c();return h(s.generateCertificates())}),p(25,Je,3,0)(26,Ke,3,1),n()()()()(),i(27,"div",127)(28,"div",89)(29,"table",128)(30,"thead",91)(31,"tr")(32,"th",92)(33,"div",129)(34,"input",130),S("change",function(){C(e);let s=c();return h(s.toggleSelectAll())}),n(),i(35,"label",131),o(36," Seleccionar todo "),n()()(),i(37,"th",93),o(38,"Participante"),n(),i(39,"th",94),o(40,"Email"),n(),i(41,"th",95),o(42,"Plantilla"),n(),i(43,"th",132),o(44,"Estado"),n(),i(45,"th",132),o(46,"Certificado"),n(),i(47,"th",133),o(48,"Acciones"),n()()(),i(49,"tbody"),M(50,ct,38,14,"tr",134,X().trackByRegistrationId,!0),n()()()()()}if(l&2){let e=c();r(8),u(e.getTotalAttended()>0?8:-1),r(6),v(e.getTotalAttended()),r(4),v(e.getAvailableCount()),r(4),v(e.getExistingCount()),r(2),_("disabled",!e.canGenerate()||e.processingCertificates()||e.getAvailableCount()===0),r(),u(e.processingCertificates()?25:26),r(9),_("checked",e.allSelected())("indeterminate",e.someSelected()),r(16),D(e.attendedRegistrations())}}function pt(l,t){l&1&&(i(0,"div",50)(1,"div",167)(2,"div",168),d(3,"i",169),n(),i(4,"h6",170),o(5,"No hay participantes asistidos"),n(),i(6,"p",171),o(7,' No se encontraron participantes con estado "asistido" para el evento y rol seleccionados. '),n()()())}function ut(l,t){l&1&&(i(0,"div",50)(1,"div",167)(2,"div",172),d(3,"i",173),n(),i(4,"h6",170),o(5,"Seleccione Evento y Rol"),n(),i(6,"p",171),o(7," Elija un evento y un rol de participante para ver los registros disponibles para certificaci\xF3n. "),n()()())}var gt=9,be=class l{fb=E(pe);destroyRef=E(k);eventService=E(Ce);certificateService=E(O);staticDataService=E(ge);confirmModal=N("confirmModal");changeTemplateModal=N("changeTemplateModal");autocompleteConfig=ae.autocomplete;loadingState=b("idle");loading=x(()=>this.loadingState()==="loading");processingState=b("idle");processingCertificates=x(()=>this.processingState()==="processing");error=b(null);success=b(null);loadingRegistrations=b(!1);availableEvents=b([]);availableRoles=b([]);certificateTemplatesMap=b(null);registrations=b([]);selectedEvent=b(null);selectedRole=b(null);selectedTemplateId=b(null);selectedCertificateForChange=b(null);templatesWithId=x(()=>{let t=this.certificateTemplatesMap();return t?Object.entries(t).map(([e,a])=>w({id:parseInt(e)},a)):[]});filtersForm=this.fb.group({eventId:this.fb.control(null),participantRoleId:this.fb.control(null),templateId:this.fb.control(null)});eventAutocompleteControl=this.fb.control(null);roleAutocompleteControl=this.fb.control(null);templateAutocompleteControl=this.fb.control(null);_attendedRegistrationsCache=x(()=>this.registrations().filter(e=>this.isAttendedState(e.currentStateId)));attendedRegistrations=x(()=>this._attendedRegistrationsCache());selectedRegistrations=x(()=>this.attendedRegistrations().filter(e=>e.selected));allSelected=x(()=>{let t=this.attendedRegistrations();return t.length>0&&t.every(e=>e.selected)});someSelected=x(()=>this.attendedRegistrations().some(t=>t.selected)&&!this.allSelected());canGenerate=x(()=>this.selectedRegistrations().length>0&&this.selectedTemplateId()!==null&&this.availableForGeneration().length>0);defaultTemplateId=x(()=>{let t=this.selectedRole(),e=this.selectedEvent();if(t?.templateId)return t.templateId;if(e){let a=this.templatesWithId();return a.length>0?a[0].id:null}return null});availableForGeneration=x(()=>this.selectedRegistrations().filter(e=>!e.hasExistingCertificate));existingCertificates=x(()=>this.selectedRegistrations().filter(t=>t.hasExistingCertificate));generationSummary=x(()=>{let t=this.attendedRegistrations().length,e=this.existingCertificates().length,a=this.selectedRegistrations().length,s=this.availableForGeneration().length;return{total:t,eligible:s,existing:e,selected:a}});trackByRegistrationId=(t,e)=>e.id;trackByTemplateId=(t,e)=>e.name||t;Math=Math;displayEvent=t=>{if(!t)return"";let e=t.startDate?new Date(t.startDate).toLocaleDateString("es-CO"):"Sin fecha";return`${t.title} (${e})`};displayRole=t=>t?`${t.name} - ${t.description}`:"";displayTemplate=t=>t?t.name:"";ngOnInit(){this.loadInitialData(),this.setupSubscriptions()}setupSubscriptions(){this.filtersForm.valueChanges.pipe(q(300),J(),T(this.destroyRef)).subscribe(()=>{this.onSelectionChange()})}loadInitialData(){return G(this,null,function*(){this.loadingState.set("loading"),this.error.set(null);try{let t=[this.loadEvents(),this.loadRoles(),this.loadCertificateTemplates()];yield Promise.allSettled(t),this.loadingState.set("success")}catch(t){console.error("Error initializing component:",t),this.error.set("Error cargando datos iniciales. Por favor, recargue la p\xE1gina."),this.loadingState.set("error")}})}loadEvents(){return G(this,null,function*(){try{let t=yield U(this.eventService.getEvents(1,100));this.availableEvents.set(t?.items||[])}catch(t){console.error("Error loading events:",t),this.availableEvents.set([])}})}loadRoles(){return G(this,null,function*(){this.staticDataService.participantRoles$.pipe(T(this.destroyRef)).subscribe(t=>{t&&this.availableRoles.set(Object.values(t))})})}loadCertificateTemplates(){this.staticDataService.certificateTemplates$.pipe(T(this.destroyRef)).subscribe({next:t=>{this.certificateTemplatesMap.set(t)},error:t=>{console.error("Error cargando plantillas:",t)}})}onEventSelected(t){this.selectedEvent.set(t),this.filtersForm.patchValue({eventId:t?t.id.toString():null},{emitEvent:!0})}onRoleSelected(t){if(t){let e=this.getRoleId(t.name);this.selectedRole.set(t),t.templateId&&(this.selectedTemplateId.set(t.templateId),this.filtersForm.patchValue({templateId:t.templateId.toString()},{emitEvent:!1})),this.filtersForm.patchValue({participantRoleId:e.toString()},{emitEvent:!0})}else this.selectedRole.set(null),this.selectedTemplateId.set(null),this.filtersForm.patchValue({participantRoleId:null,templateId:null},{emitEvent:!0})}onTemplateChange(t){let e=t?.id?.toString()||null,a=t?.id||null;this.selectedTemplateId.set(a),this.filtersForm.patchValue({templateId:e},{emitEvent:!1})}onSelectionChange(){let t=this.filtersForm.get("eventId")?.value,e=this.filtersForm.get("participantRoleId")?.value;t&&e?this.loadRegistrations(Number(t),Number(e)):this.registrations.set([])}loadRegistrations(t,e){this.loadingRegistrations.set(!0),this.error.set(null),!this.selectedTemplateId()&&this.defaultTemplateId()&&this.selectedTemplateId.set(this.defaultTemplateId());let a={eventId:t,participantRoleId:e,includeWithCertificates:!0};this.certificateService.getEligibleRegistrationsForCertificates(a).pipe(T(this.destroyRef)).subscribe({next:s=>{let m=s.items.map(g=>({id:g.registrationId,eventId:g.eventId,userId:g.userId,participantRoleId:g.participantRoleId,currentStateId:g.currentStateId,registrationDate:g.registrationDate,selected:g.isCheckable,hasExistingCertificate:g.hasCertificate,existingCertificate:g.certificate?{id:g.certificate.id,userId:g.userId,templateId:g.certificate.templateId}:void 0,userInfo:g.user,eventInfo:g.event}));this.registrations.set(m),this.loadingRegistrations.set(!1)},error:s=>{console.error("Error cargando registros elegibles:",s),this.error.set("Error cargando registros: "+s.message),this.registrations.set([]),this.loadingRegistrations.set(!1)}})}toggleSelectAll(){let t=this.allSelected(),e=this.attendedRegistrations(),a=this.registrations().map(s=>R(w({},s),{selected:e.includes(s)?!t:s.selected}));this.registrations.set(a)}toggleRegistration(t){let e=this.registrations().map(a=>a.id===t?R(w({},a),{selected:!a.selected}):a);this.registrations.set(e)}generateCertificates(){let t=this.availableForGeneration(),e=this.selectedTemplateId(),a=this.selectedEvent(),s=this.selectedRole(),m=this.validateCertificateGeneration(t,e,a,s);if(m){this.error.set(m);return}this.processingState.set("processing"),this.error.set(null);let g={eventId:a.id,userIds:t.map(I=>I.userId),templateId:e,participantRoleId:this.getRoleId(s.name)};this.certificateService.generateBulkCertificates(g).pipe(T(this.destroyRef)).subscribe({next:I=>{let xe=I.totalSuccessful||I.successful?.length||0;this.success.set(`Se generaron ${xe} certificados exitosamente`),this.processingState.set("complete"),this.loadRegistrations(a.id,this.getRoleId(s.name)),setTimeout(()=>this.success.set(null),5e3)},error:I=>{this.error.set("Error generando certificados: "+I.message),this.processingState.set("error")}})}validateCertificateGeneration(t,e,a,s){return t.length?e?a?s?null:"No se ha seleccionado un rol de participante":"No se ha seleccionado un evento":"No se ha seleccionado una plantilla de certificado":"No hay registros seleccionados para generar certificados"}formatEventDate(t){return new Date(t).toLocaleDateString("es-PE",{day:"numeric",month:"short",year:"numeric"})}getTemplateName(t){return this.templatesWithId().find(s=>s.id===t)?.name||`Plantilla ${t}`}getDisplayTemplateName(t){return t.hasExistingCertificate&&t.existingCertificate?.templateId?this.getTemplateName(t.existingCertificate.templateId):this.selectedTemplateId()?this.getTemplateName(this.selectedTemplateId()):"-"}getRoleName(t){let e=this.availableRoles(),a=t-1;return e[a]?.name||`Rol ${t}`}hasAnySelected(){return this.someSelected()}getSelectedCount(){return this.selectedRegistrations().length}getTotalAttended(){return this.attendedRegistrations().length}getExistingCount(){return this.existingCertificates().length}getAvailableCount(){return this.availableForGeneration().length}updateCertificateTemplate(t,e){this.selectedCertificateForChange.set(t);let a=this.changeTemplateModal();a&&a.open()}onTemplateChanged(t){this.success.set(`Plantilla cambiada exitosamente a ${t.templateName}`),this.updateCertificateTemplateInTable(t.certificateId,t.newTemplateId)}updateCertificateTemplateInTable(t,e){let s=this.registrations().map(m=>m.hasExistingCertificate&&m.existingCertificate?.id===t?R(w({},m),{existingCertificate:R(w({},m.existingCertificate),{templateId:e})}):m);this.registrations.set(s)}onModalClosed(){}isAttendedState(t){return t===gt}getRoleId(t){let e=this.availableRoles().findIndex(a=>a.name===t);return e===-1?0:e+1}static \u0275fac=function(e){return new(e||l)};static \u0275cmp=V({type:l,selectors:[["app-certificate-generate"]],viewQuery:function(e,a){e&1&&(F(a.confirmModal,De,5),F(a.changeTemplateModal,Fe,5)),e&2&&P(2)},decls:73,vars:24,consts:[["confirmModal",""],["changeTemplateModal",""],[1,"container-fluid","py-3"],["title","Confirmar Generaci\xF3n","message","\xBFEst\xE1 seguro de generar los certificados seleccionados?","confirmText","S\xED, Generar"],["aria-label","breadcrumb",1,"mb-3"],[1,"breadcrumb","mb-0","small"],[1,"breadcrumb-item"],["routerLink","/",1,"text-decoration-none","link-primary"],[1,"bi","bi-house-door","me-1"],[1,"d-none","d-sm-inline"],["routerLink","/certificados",1,"text-decoration-none","link-primary"],["aria-current","page",1,"breadcrumb-item","active"],[1,"d-flex","flex-column","flex-sm-row","align-items-start","align-items-sm-center","justify-content-between","gap-2","mb-3"],[1,"order-1","order-sm-0"],[1,"h6","mb-1","fw-normal","d-flex","align-items-center"],[1,"bi","bi-award","me-2","text-primary"],[1,"small"],[1,"badge","text-bg-primary","ms-2","small"],[1,"text-muted","small","mb-0","d-none","d-sm-block"],[1,"d-flex","flex-wrap","gap-1","order-0","order-sm-1"],["routerLink","/certificados","title","Ver lista de certificados",1,"btn","btn-outline-secondary","btn-sm","d-flex","align-items-center","px-2"],[1,"bi","bi-list-ul","me-1"],[1,"d-none","d-md-inline","small"],["routerLink","/verificar-certificado","title","Verificar certificado",1,"btn","btn-outline-info","btn-sm","d-flex","align-items-center","px-2"],[1,"bi","bi-shield-check","me-1"],[1,"d-none","d-lg-inline","small"],["role","alert",1,"alert","alert-success","alert-dismissible","d-flex","align-items-center","mb-3","py-2"],["role","alert",1,"alert","alert-danger","alert-dismissible","d-flex","align-items-center","mb-3","py-2"],[1,"card","border-0","shadow-sm","mb-3"],[1,"card-header","bg-light","border-bottom","py-2"],[1,"d-flex","align-items-center","gap-2"],[1,"d-flex","align-items-center","gap-1"],[1,"bi","bi-funnel","text-primary"],[1,"mb-0","fw-normal","small"],[1,"badge","text-bg-success","small"],[1,"card-body","py-3"],[1,"row","g-2"],[1,"col-12","col-md-6"],[1,"form-label","fw-normal","small","mb-1"],[1,"bi","bi-calendar-event","me-1","text-primary"],[1,"text-danger"],[1,"d-flex","align-items-center","py-2"],[1,"input-group","input-group-sm"],[1,"form-text","text-warning","small"],[1,"bi","bi-person-badge","me-1","text-primary"],[1,"input-group-text","bg-light","border-end-0"],[1,"bi","bi-person-badge","text-muted"],[3,"valueChange","options","displayFn","placeholder","minChars","maxHeight","noResultsMessage","formControl","inputClass","inInputGroup","highlightSearch","disabled"],[1,"form-text","text-success","small"],[1,"alert","alert-info","mt-3","py-2"],[1,"card","border-0","shadow-sm"],[3,"templateChanged","modalClosed","certificate","templates"],[1,"bi","bi-check-circle-fill","me-2","text-success","fs-7"],[1,"flex-grow-1","small"],["type","button","aria-label","Cerrar",1,"btn-close","btn-close-sm",3,"click"],[1,"bi","bi-exclamation-triangle-fill","me-2","text-danger","fs-7"],["role","status","aria-hidden","true",1,"spinner-border","spinner-border-sm","me-2",2,"width","1rem","height","1rem"],[1,"text-muted","fs-7"],[1,"bi","bi-search","text-muted"],[3,"valueChange","options","displayFn","placeholder","minChars","maxHeight","noResultsMessage","formControl","inputClass","inInputGroup","highlightSearch"],[1,"bi","bi-exclamation-triangle","me-1"],[1,"bi","bi-check-circle","me-1"],[1,"row","align-items-center","g-2"],[1,"col-md-8"],[1,"alert-heading","mb-1","fw-medium","d-flex","align-items-center","small"],[1,"bi","bi-info-circle","me-1"],[1,"d-flex","flex-wrap","gap-3","small"],[1,"d-flex","align-items-center"],[1,"bi","bi-calendar-range","me-1","text-primary","fs-7"],[1,"fs-8"],[1,"col-md-4","text-md-end"],[1,"badge","text-bg-info","small"],[1,"bi","bi-calendar-check","me-1"],[1,"d-none","d-lg-inline"],[1,"bi","bi-geo-alt","me-1","text-success","fs-7"],[1,"card-header","bg-success-subtle","border-bottom","py-2"],[1,"mb-0","fw-normal","text-success-emphasis","d-flex","align-items-center","small"],[1,"bi","bi-palette","me-1"],[1,"row","g-2","align-items-end"],[1,"col-12","col-md-8"],[1,"bi","bi-file-earmark-richtext","me-1","text-primary"],[1,"bi","bi-file-earmark-richtext","text-muted"],[1,"form-text","small"],[1,"col-12","col-md-4"],[1,"d-flex","flex-column","gap-1"],[1,"bi","bi-person","me-1"],[1,"badge","text-bg-primary","small"],[1,"bi","bi-award","me-1"],[1,"card-body","p-3"],[1,"table-responsive"],[1,"table","table-hover","mb-0","table-sm"],[1,"table-light"],["scope","col",1,"border-0",2,"width","40px"],["scope","col",1,"fw-semibold","border-0","fs-7"],["scope","col",1,"fw-semibold","border-0","d-none","d-md-table-cell","fs-7"],["scope","col",1,"fw-semibold","border-0","d-none","d-lg-table-cell","fs-7"],["scope","col",1,"fw-semibold","border-0","fs-7",2,"width","120px"],[1,"text-center","mt-3"],["role","status",1,"spinner-border","text-primary","me-2",2,"width","1.25rem","height","1.25rem"],[1,"visually-hidden"],[1,"border-0"],[1,"placeholder","bg-secondary","rounded",2,"width","16px","height","16px"],[1,"placeholder","bg-primary","rounded-circle",2,"width","32px","height","32px"],[1,"flex-grow-1"],[1,"placeholder-glow"],[1,"placeholder","col-8","mb-1"],[1,"placeholder","col-6"],[1,"border-0","d-none","d-md-table-cell"],[1,"placeholder","col-10","mb-1"],[1,"placeholder","col-7"],[1,"border-0","d-none","d-lg-table-cell","text-center"],[1,"placeholder","bg-secondary","rounded-pill",2,"width","80px","height","20px"],[1,"border-0","text-center"],[1,"placeholder","bg-success","rounded-pill",2,"width","70px","height","18px"],[1,"placeholder","bg-warning","rounded-pill",2,"width","80px","height","18px"],[1,"placeholder","bg-secondary","rounded",2,"width","32px","height","24px"],[1,"d-flex","flex-column","flex-lg-row","align-items-start","align-items-lg-center","gap-2"],[1,"d-flex","align-items-center","gap-2","flex-grow-1"],[1,"bi","bi-people","text-primary"],[1,"d-flex","flex-wrap","align-items-center","gap-2"],[1,"d-flex","align-items-center","gap-2","small"],[1,"text-muted"],[1,"fw-medium","text-dark"],[1,"text-success"],[1,"fw-medium"],[1,"text-info"],["type","button",1,"btn","btn-primary","btn-sm",3,"click","disabled"],[1,"card-body","p-0"],[1,"table","table-hover","align-middle","mb-0","table-sm"],[1,"form-check"],["type","checkbox","id","selectAllTable",1,"form-check-input","form-check-input-sm",3,"change","checked","indeterminate"],["for","selectAllTable",1,"form-check-label","visually-hidden"],["scope","col",1,"fw-semibold","border-0","text-center","fs-7"],["scope","col",1,"fw-semibold","border-0","text-center","fs-7",2,"width","120px"],[3,"table-active","bg-light"],["role","status","aria-hidden","true",1,"spinner-border","spinner-border-sm","me-1"],[1,"bi","bi-check-circle-fill","text-success","fs-7"],[1,"avatar","text-bg-primary","rounded-circle","d-flex","align-items-center","justify-content-center","flex-shrink-0",2,"width","32px","height","32px"],[1,"bi","bi-person-fill","fs-7"],[1,"overflow-hidden"],[1,"fw-medium","text-truncate","fs-7"],[1,"text-muted","small","text-truncate","d-md-none"],[1,"d-flex","flex-wrap","gap-1","mt-1","d-lg-none"],[1,"badge","text-bg-primary","fs-8"],[1,"badge","text-bg-secondary","fs-8"],[1,"text-muted","fs-8","text-truncate"],[1,"text-muted","fs-8"],[1,"border-0","d-none","d-lg-table-cell"],[1,"text-center"],[1,"badge","text-bg-success","fs-8"],[1,"badge","text-bg-info","fs-8"],[1,"badge","text-bg-warning","fs-8"],[1,"dropdown"],["type","checkbox",1,"form-check-input","form-check-input-sm",3,"change","id","checked"],[1,"form-check-label","visually-hidden",3,"for"],[1,"bi","bi-file-earmark-text","me-1"],[1,"bi","bi-award-fill","me-1"],[1,"bi","bi-clock","me-1"],["type","button","data-bs-toggle","dropdown","aria-expanded","false","title","Opciones de certificado",1,"btn","btn-outline-secondary","btn-sm","dropdown-toggle","px-2",3,"id"],[1,"bi","bi-gear","fs-7"],[1,"dropdown-menu","dropdown-menu-end"],[1,"dropdown-header","fs-8"],[1,"dropdown-item-text","fs-8","text-muted"],[1,"dropdown-divider"],["type","button","title","Cambiar plantilla del certificado",1,"dropdown-item","fs-8",3,"click"],[1,"bi","bi-pencil","me-2"],[1,"bi","bi-dash","fs-7"],[1,"card-body","text-center","py-4"],[1,"text-muted","mb-3"],[1,"bi","bi-person-x","opacity-25",2,"font-size","3rem"],[1,"text-muted","mb-2"],[1,"text-muted","mb-0","fs-7"],[1,"text-primary","mb-3"],[1,"bi","bi-award","opacity-25",2,"font-size","3rem"]],template:function(e,a){if(e&1){let s=y();i(0,"div",2),d(1,"app-confirm-modal",3,0),i(3,"nav",4)(4,"ol",5)(5,"li",6)(6,"a",7),d(7,"i",8),i(8,"span",9),o(9,"Inicio"),n()()(),i(10,"li",6)(11,"a",10),o(12,"Certificados"),n()(),i(13,"li",11),o(14,"Generar"),n()()(),i(15,"div",12)(16,"div",13)(17,"h1",14),d(18,"i",15),i(19,"span",16),o(20,"Generaci\xF3n de Certificados"),n(),p(21,Ge,2,1,"span",17),n(),i(22,"p",18),o(23,"Generar certificados masivos para participantes que asistieron a eventos"),n()(),i(24,"div",19)(25,"button",20),d(26,"i",21),i(27,"span",22),o(28,"Ver Certificados"),n()(),i(29,"button",23),d(30,"i",24),i(31,"span",25),o(32,"Verificar"),n()()()(),p(33,ke,5,1,"div",26),p(34,Ve,5,1,"div",27),i(35,"div",28)(36,"div",29)(37,"div",30)(38,"div",31),d(39,"i",32),i(40,"h6",33),o(41,"Selecci\xF3n de Evento y Rol"),n()(),p(42,Pe,2,0,"span",34),n()(),i(43,"div",35)(44,"div",36)(45,"div",37)(46,"label",38),d(47,"i",39),o(48," Evento "),i(49,"span",40),o(50,"*"),n()(),p(51,Ae,4,0,"div",41)(52,We,4,10,"div",42),p(53,$e,3,0,"div",43),n(),i(54,"div",37)(55,"label",38),d(56,"i",44),o(57," Rol de Participante "),i(58,"span",40),o(59,"*"),n()(),i(60,"div",42)(61,"span",45),d(62,"i",46),n(),i(63,"app-autocomplete",47),S("valueChange",function(g){return C(s),h(a.onRoleSelected(g))}),n()(),p(64,Le,3,1,"div",48),n()(),p(65,Oe,18,4,"div",49),n(),p(66,je,24,13,"div",28),p(67,Ue,29,1,"div",50)(68,mt,52,8,"div",50)(69,pt,8,0,"div",50),p(70,ut,8,0,"div",50),n(),i(71,"app-change-template-modal",51,1),S("templateChanged",function(g){return C(s),h(a.onTemplateChanged(g))})("modalClosed",function(){return C(s),h(a.onModalClosed())}),n()()}e&2&&(r(21),u(a.getTotalAttended()>0?21:-1),r(12),u(a.success()?33:-1),r(),u(a.error()?34:-1),r(8),u(a.selectedEvent()&&a.selectedRole()?42:-1),r(9),u(a.loading()?51:52),r(2),u(a.availableEvents().length===0&&!a.loading()?53:-1),r(10),_("options",a.availableRoles())("displayFn",a.displayRole)("placeholder","Seleccionar rol... ("+a.availableRoles().length+" disponibles)")("minChars",a.autocompleteConfig.minCharsLocal)("maxHeight",a.autocompleteConfig.maxHeight)("noResultsMessage","No se encontraron roles")("formControl",a.roleAutocompleteControl)("inputClass","form-control border-start-0 bg-light form-control-sm")("inInputGroup",!0)("highlightSearch",!0)("disabled",!a.selectedEvent()||a.loading()),r(),u(a.selectedRole()?64:-1),r(),u(a.selectedEvent()?65:-1),r(),u(a.selectedEvent()&&a.selectedRole()?66:-1),r(),u(a.loadingRegistrations()?67:a.attendedRegistrations().length>0?68:a.selectedEvent()&&a.selectedRole()&&!a.loadingRegistrations()?69:-1),r(3),u(!a.selectedEvent()||!a.selectedRole()?70:-1),r(),_("certificate",a.selectedCertificateForChange())("templates",a.templatesWithId()))},dependencies:[L,ue,B,de,Q,ne,ie,he,fe,H],encapsulation:2,changeDetection:0})};export{be as CertificateGenerateComponent};
