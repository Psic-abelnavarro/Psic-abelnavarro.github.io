import"./chunk-XEAQFPKZ.js";import"./chunk-VF5TSERA.js";import"./chunk-YUNYRAF7.js";import"./chunk-FK6H3RFT.js";import{a as Ce}from"./chunk-PT3J4EFC.js";import{b as q}from"./chunk-MQP2EC7J.js";import"./chunk-PHSVAKCK.js";import{b as fe}from"./chunk-22IHSIXM.js";import{a as ge}from"./chunk-W55XPYIR.js";import{b as oe,c as re,e as B,g as de,j as se,m as ce,n as W,o as O,s as me,t as j,u as pe}from"./chunk-KBXA6SDK.js";import"./chunk-7M4K7CII.js";import{a as ue}from"./chunk-CYLPXQIR.js";import"./chunk-MPC7SZEK.js";import{a as T}from"./chunk-TMGCMHHJ.js";import{j as le}from"./chunk-IIPOJGOQ.js";import{i as ne,l as ae}from"./chunk-C3HOFUSH.js";import{$a as Z,Ab as P,Bc as Q,D as X,Da as r,Db as ee,Gb as o,H as Y,Hb as _,Ib as f,Jb as te,Lb as A,Mb as L,Na as V,Nb as $,_ as y,ab as U,ac as h,bb as p,bc as ie,cb as u,da as C,ea as b,ec as z,fb as R,fc as J,gb as M,gc as N,hb as x,ia as k,ib as i,jb as a,kb as s,ma as v,o as K,rb as E,sb as S,ub as c,zb as F}from"./chunk-5W5GNUFO.js";import"./chunk-LJ5XHLMQ.js";import{a as w,b as D,h as G}from"./chunk-FK42CRUA.js";var Se=["modal"],Ee=(l,t)=>t.id;function ye(l,t){if(l&1&&(i(0,"option",20),o(1),a()),l&2){let e=t.$implicit;x("value",e.id),r(),_(e.name)}}function Te(l,t){if(l&1&&(i(0,"div",27),s(1,"i",28),o(2),a()),l&2){let e=c(2);r(2),f(" ",e.error()," ")}}function Ie(l,t){if(l&1){let e=E();i(0,"div",13),s(1,"i",14),i(2,"div")(3,"strong"),o(4,"Certificado ID:"),a(),o(5),s(6,"br"),i(7,"strong"),o(8,"Participante:"),a(),o(9),s(10,"br"),i(11,"strong"),o(12,"Plantilla actual:"),a(),o(13),a()(),i(14,"div",15)(15,"label",16),s(16,"i",17),o(17," Nueva Plantilla "),a(),i(18,"select",18),$("ngModelChange",function(d){C(e);let m=c();return L(m.newTemplateId,d)||(m.newTemplateId=d),b(d)}),i(19,"option",19),o(20,"Seleccionar nueva plantilla..."),a(),R(21,ye,2,2,"option",20,Ee),a()(),i(23,"div",15)(24,"label",21),s(25,"i",22),o(26," Raz\xF3n del cambio (opcional) "),a(),i(27,"textarea",23),$("ngModelChange",function(d){C(e);let m=c();return L(m.reason,d)||(m.reason=d),b(d)}),a()(),i(28,"div",24)(29,"input",25),$("ngModelChange",function(d){C(e);let m=c();return L(m.regenerate,d)||(m.regenerate=d),b(d)}),a(),i(30,"label",26),o(31," Regenerar PDF del certificado autom\xE1ticamente "),a()(),p(32,Te,3,1,"div",27)}if(l&2){let e,n,d=c();r(5),f(" ",(e=d.certificate())==null?null:e.id),r(4),f(" ",(n=d.certificate())==null||n.userInfo==null?null:n.userInfo.fullName),r(4),f(" ",d.getCurrentTemplateName()," "),r(5),A("ngModel",d.newTemplateId),r(3),M(d.availableTemplates()),r(6),A("ngModel",d.reason),r(2),A("ngModel",d.regenerate),r(3),u(d.error()?32:-1)}}function we(l,t){l&1&&(s(0,"span",29),o(1," Cambiando... "))}function Re(l,t){l&1&&(s(0,"i",30),o(1," Cambiar Plantilla "))}var H=class l{certificateService=y(q);destroyRef=y(k);modal=N("modal");certificate=J(null);templates=J([]);templateChanged=z();modalClosed=z();processing=v(!1);error=v(null);newTemplateId=null;reason="";regenerate=!1;availableTemplates=h(()=>{let t=this.certificate();return t?this.templates().filter(e=>e.id!==t.templateId):this.templates()});constructor(){ie(()=>{this.certificate()&&this.resetForm()})}getCurrentTemplateName(){let t=this.certificate();return t?this.templates().find(n=>n.id===t.templateId)?.name||`Plantilla ${t.templateId}`:""}getTemplateName(t){return this.templates().find(n=>n.id===t)?.name||`Plantilla ${t}`}open(){let t=this.modal()?.nativeElement;if(t){let e=window.bootstrap;e&&(new e.Modal(t).show(),t.addEventListener("hidden.bs.modal",()=>{this.handleModalClose()}))}}close(){let t=this.modal()?.nativeElement;if(t){let e=window.bootstrap;if(e){let n=e.Modal.getInstance(t);n&&n.hide()}}}confirmChange(){let t=this.certificate();if(!t||!this.newTemplateId){this.error.set("Por favor seleccione una nueva plantilla");return}this.processing.set(!0),this.error.set(null);let e={certificateId:t.id,newTemplateId:this.newTemplateId,reason:this.reason||void 0,regenerate:this.regenerate};this.certificateService.changeCertificateTemplate(e).pipe(T(this.destroyRef)).subscribe({next:n=>{n.success?(this.templateChanged.emit({certificateId:t.id,newTemplateId:this.newTemplateId,templateName:this.getTemplateName(this.newTemplateId)}),this.close()):this.error.set(n.message||"Error cambiando plantilla")},error:n=>{this.error.set("Error cambiando plantilla: "+n.message)},complete:()=>{this.processing.set(!1)}})}handleModalClose(){this.resetForm(),this.modalClosed.emit()}resetForm(){this.newTemplateId=null,this.reason="",this.regenerate=!1,this.error.set(null),this.processing.set(!1)}static \u0275fac=function(e){return new(e||l)};static \u0275cmp=V({type:l,selectors:[["app-change-template-modal"]],viewQuery:function(e,n){e&1&&F(n.modal,Se,5),e&2&&P()},inputs:{certificate:[1,"certificate"],templates:[1,"templates"]},outputs:{templateChanged:"templateChanged",modalClosed:"modalClosed"},decls:18,vars:3,consts:[["modal",""],["id","changeTemplateModal","tabindex","-1","aria-labelledby","changeTemplateModalLabel","aria-hidden","true",1,"modal","fade"],[1,"modal-dialog"],[1,"modal-content"],[1,"modal-header"],["id","changeTemplateModalLabel",1,"modal-title"],[1,"bi","bi-arrow-repeat","me-2"],["type","button","data-bs-dismiss","modal","aria-label","Close",1,"btn-close"],[1,"modal-body"],[1,"modal-footer"],["type","button","data-bs-dismiss","modal",1,"btn","btn-secondary"],[1,"bi","bi-x-lg","me-1"],["type","button",1,"btn","btn-primary",3,"click","disabled"],[1,"alert","alert-info","d-flex","align-items-center","mb-3"],[1,"bi","bi-info-circle","me-2"],[1,"mb-3"],["for","newTemplateSelect",1,"form-label","fw-semibold"],[1,"bi","bi-file-earmark-richtext","me-1"],["id","newTemplateSelect",1,"form-select",3,"ngModelChange","ngModel"],["value",""],[3,"value"],["for","changeReason",1,"form-label","fw-semibold"],[1,"bi","bi-chat-left-text","me-1"],["id","changeReason","rows","3","placeholder","Descripci\xF3n del motivo del cambio...",1,"form-control",3,"ngModelChange","ngModel"],[1,"form-check"],["type","checkbox","id","regeneratePdf",1,"form-check-input",3,"ngModelChange","ngModel"],["for","regeneratePdf",1,"form-check-label"],[1,"alert","alert-danger","mt-3"],[1,"bi","bi-exclamation-triangle","me-2"],["role","status","aria-hidden","true",1,"spinner-border","spinner-border-sm","me-2"],[1,"bi","bi-check-lg","me-1"]],template:function(e,n){if(e&1){let d=E();i(0,"div",1,0)(2,"div",2)(3,"div",3)(4,"div",4)(5,"h5",5),s(6,"i",6),o(7," Cambiar Plantilla de Certificado "),a(),s(8,"button",7),a(),i(9,"div",8),p(10,Ie,33,7),a(),i(11,"div",9)(12,"button",10),s(13,"i",11),o(14," Cancelar "),a(),i(15,"button",12),S("click",function(){return C(d),b(n.confirmChange())}),p(16,we,2,0)(17,Re,2,0),a()()()()()}e&2&&(r(10),u(n.certificate()?10:-1),r(5),x("disabled",!n.newTemplateId||n.processing()),r(),u(n.processing()?16:17))},dependencies:[Q,j,W,O,re,oe,ce,B,de],encapsulation:2})};var Me=["confirmModal"],De=["changeTemplateModal"],Fe=(l,t)=>t.name;function Ne(l,t){if(l&1&&(i(0,"span",16),o(1),a()),l&2){let e=c();r(),_(e.getTotalAttended())}}function Ge(l,t){if(l&1){let e=E();i(0,"div",24),s(1,"i",50),i(2,"div",51),o(3),a(),i(4,"button",52),S("click",function(){C(e);let d=c();return b(d.success.set(null))}),a()()}if(l&2){let e=c();r(3),_(e.success())}}function ke(l,t){if(l&1){let e=E();i(0,"div",25),s(1,"i",53),i(2,"div",51),o(3),a(),i(4,"button",52),S("click",function(){C(e);let d=c();return b(d.error.set(null))}),a()()}if(l&2){let e=c();r(3),_(e.error())}}function Ve(l,t){l&1&&(i(0,"span",32),o(1,"Configurado"),a())}function Pe(l,t){l&1&&(i(0,"div",39),s(1,"div",54),i(2,"small",55),o(3,"Cargando eventos..."),a()())}function Ae(l,t){if(l&1){let e=E();i(0,"div",40)(1,"span",56),s(2,"i",57),a(),i(3,"app-autocomplete",58),S("valueChange",function(d){C(e);let m=c();return b(m.onEventSelected(d))}),a()()}if(l&2){let e=c();r(3),x("searchFn",e.searchEvents)("preloadFn",e.preloadEvents)("displayFn",e.displayEvent)("placeholder","Buscar eventos... ("+e.availableEvents().length+" disponibles)")("minChars",e.autocompleteConfig.minCharsRemote)("searchLimit",e.autocompleteConfig.searchLimit)("debounceMs",e.autocompleteConfig.debounceTime)("maxHeight",e.autocompleteConfig.maxHeight)("noResultsMessage","No se encontraron eventos")("enablePreload",!0)("formControl",e.eventAutocompleteControl)("inputClass","form-control border-start-0 bg-light")("inInputGroup",!0)("enableCaching",!0)("cacheSize",100)("highlightSearch",!0)("loadingMessage","Buscando eventos...")}}function Le(l,t){l&1&&(i(0,"div",41),s(1,"i",59),o(2,"No hay eventos disponibles para certificar "),a())}function $e(l,t){if(l&1&&(i(0,"option",45),o(1),a()),l&2){let e=t.$implicit;x("value",e.name),r(),te("",e.name," - ",e.description)}}function Qe(l,t){if(l&1&&(i(0,"div",46),s(1,"i",60),o(2),a()),l&2){let e=c();r(2),f(" Certificado: ",e.selectedRole().certificateTitle," ")}}function Be(l,t){if(l&1&&o(0),l&2){let e=c(2);f(" - ",e.formatEventDate(e.selectedEvent().endDate)," ")}}function We(l,t){if(l&1&&(i(0,"span",39),s(1,"i",70),o(2),a()),l&2){let e=c(2);r(2),f(" ",e.selectedEvent().location," ")}}function Oe(l,t){if(l&1&&(i(0,"div",47)(1,"div",61)(2,"div",62)(3,"h6",63),s(4,"i",64),o(5),a(),i(6,"div",65)(7,"span",39),s(8,"i",66),o(9),p(10,Be,1,1),a(),p(11,We,3,1,"span",39),a()(),i(12,"div",67)(13,"span",68),s(14,"i",69),o(15," Evento Seleccionado "),a()()()()),l&2){let e=c();r(5),f(" ",e.selectedEvent().title," "),r(4),f(" ",e.selectedEvent().startDate?e.formatEventDate(e.selectedEvent().startDate):"Sin fecha"," "),r(),u(e.selectedEvent().endDate?10:-1),r(),u(e.selectedEvent().location?11:-1)}}function je(l,t){if(l&1&&(i(0,"option",45),o(1),a()),l&2){let e=t.$implicit;x("value",e.id),r(),_(e.name)}}function qe(l,t){if(l&1&&(i(0,"div",78),s(1,"i",84),o(2),a()),l&2){let e=c(2);r(2),f(" Plantilla sugerida: ",e.getTemplateName(e.defaultTemplateId())," ")}}function He(l,t){if(l&1){let e=E();i(0,"div",26)(1,"div",71)(2,"h6",72),s(3,"i",73),o(4," Configuraci\xF3n de Certificado "),a()(),i(5,"div",33)(6,"div",74)(7,"div",75)(8,"label",36),s(9,"i",76),o(10," Plantilla de Certificado "),a(),i(11,"select",77),S("change",function(d){C(e);let m=c();return b(m.onTemplateChange(d))}),i(12,"option",44),o(13,"Seleccionar plantilla..."),a(),R(14,je,2,2,"option",45,U().trackByTemplateId,!0),a(),p(16,qe,3,1,"div",78),a(),i(17,"div",79)(18,"div",80)(19,"span",68),s(20,"i",81),o(21),a(),i(22,"span",82),s(23,"i",83),o(24),a()()()()()()}if(l&2){let e=c();r(11),x("value",e.selectedTemplateId()||""),r(3),M(e.templatesWithId()),r(2),u(e.defaultTemplateId()?16:-1),r(5),f("",e.selectedRole().name," "),r(3),f("",e.selectedRole().certificateTitle," ")}}function Ue(l,t){l&1&&(i(0,"div",48)(1,"div",85)(2,"div",86)(3,"span",87),o(4,"Cargando participantes..."),a()(),i(5,"p",88),o(6,"Cargando participantes asistidos..."),a()()())}function ze(l,t){if(l&1&&(i(0,"span",92),o(1),a()),l&2){let e=c(2);r(),_(e.getTotalAttended())}}function Je(l,t){l&1&&(s(0,"span",54),o(1," Generando... "))}function Ke(l,t){if(l&1&&(s(0,"i",83),o(1)),l&2){let e=c(2);r(),f(" Generar (",e.getAvailableCount(),") ")}}function Xe(l,t){if(l&1){let e=E();i(0,"div",105)(1,"input",132),S("change",function(){C(e);let d=c().$implicit,m=c(2);return b(m.toggleRegistration(d.id))}),a(),i(2,"label",133),o(3," Seleccionar participante "),a()()}if(l&2){let e=c().$implicit;r(),x("id","reg-"+e.id)("checked",e.selected),r(),x("for","reg-"+e.id)}}function Ye(l,t){l&1&&s(0,"i",115)}function Ze(l,t){if(l&1&&(i(0,"span",122),s(1,"i",134),o(2),a()),l&2){let e=c().$implicit,n=c(2);r(2),f(" ",n.getDisplayTemplateName(e)," ")}}function et(l,t){if(l&1&&(i(0,"span",123),s(1,"i",134),o(2),a()),l&2){let e=c().$implicit,n=c(2);r(2),f(" ",n.getDisplayTemplateName(e)," ")}}function tt(l,t){if(l&1&&(i(0,"div",124),o(1),a()),l&2){let e=c().$implicit;r(),_(e.userInfo==null?null:e.userInfo.institution)}}function it(l,t){if(l&1&&(i(0,"div",126),o(1),a()),l&2){let e=c().$implicit;r(),f("Doc: ",e.userInfo==null?null:e.userInfo.documentNumber)}}function nt(l,t){if(l&1&&(i(0,"span",122),s(1,"i",134),o(2),a()),l&2){let e=c().$implicit,n=c(2);r(2),f(" ",n.getDisplayTemplateName(e)," ")}}function at(l,t){if(l&1&&(i(0,"span",123),s(1,"i",134),o(2),a()),l&2){let e=c().$implicit,n=c(2);r(2),f(" ",n.getDisplayTemplateName(e)," ")}}function lt(l,t){l&1&&(i(0,"span",126),o(1,"-"),a())}function ot(l,t){l&1&&(i(0,"span",92),s(1,"i",135),i(2,"span",23),o(3,"Generado"),a()())}function rt(l,t){l&1&&(i(0,"span",130),s(1,"i",136),i(2,"span",23),o(3,"Pendiente"),a()())}function dt(l,t){if(l&1){let e=E();i(0,"div",131)(1,"button",137),s(2,"i",138),a(),i(3,"ul",139)(4,"li")(5,"h6",140),o(6,"Plantilla Actual:"),a()(),i(7,"li")(8,"span",141),o(9),a()(),i(10,"li"),s(11,"hr",142),a(),i(12,"li")(13,"button",143),S("click",function(){C(e);let d=c().$implicit,m=c(2);return b(m.updateCertificateTemplate(d.existingCertificate,0))}),s(14,"i",144),o(15,"Cambiar Plantilla "),a()()()()}if(l&2){let e=c().$implicit,n=c(2);r(),x("id","dropdown-"+e.id),r(2),Z("aria-labelledby","dropdown-"+e.id),r(6),f(" ",n.getTemplateName(e.existingCertificate.templateId)," ")}}function st(l,t){l&1&&(i(0,"span",55),s(1,"i",145),a())}function ct(l,t){if(l&1&&(i(0,"tr")(1,"td",114),p(2,Xe,4,3,"div",105)(3,Ye,1,0,"i",115),a(),i(4,"td",114)(5,"div",28)(6,"div",116),s(7,"i",117),a(),i(8,"div",118)(9,"div",119),o(10),a(),i(11,"div",120),o(12),a(),i(13,"div",121),p(14,Ze,3,1,"span",122)(15,et,3,1,"span",123),a(),p(16,tt,2,1,"div",124),a()()(),i(17,"td",125)(18,"div")(19,"div",126),o(20),a(),p(21,it,2,1,"div",126),a()(),i(22,"td",127)(23,"div",128),p(24,nt,3,1,"span",122)(25,at,3,1,"span",123)(26,lt,2,0,"span",126),a()(),i(27,"td",129)(28,"span",32),s(29,"i",60),i(30,"span",23),o(31,"Asistido"),a()()(),i(32,"td",129),p(33,ot,4,0,"span",92)(34,rt,4,0,"span",130),a(),i(35,"td",129),p(36,dt,16,3,"div",131)(37,st,2,0,"span",55),a()()),l&2){let e=t.$implicit,n=c(2);ee("table-active",e.selected)("bg-light",e.hasExistingCertificate),r(2),u(e.hasExistingCertificate?3:2),r(8),_((e.userInfo==null?null:e.userInfo.fullName)||"Usuario sin nombre"),r(2),_((e.userInfo==null?null:e.userInfo.email)||"Sin email"),r(2),u(e.hasExistingCertificate&&(e.existingCertificate!=null&&e.existingCertificate.templateId)?14:n.selectedTemplateId()?15:-1),r(2),u(e.userInfo!=null&&e.userInfo.institution?16:-1),r(4),_((e.userInfo==null?null:e.userInfo.email)||"Sin email"),r(),u(e.userInfo!=null&&e.userInfo.documentNumber?21:-1),r(3),u(e.hasExistingCertificate&&(e.existingCertificate!=null&&e.existingCertificate.templateId)?24:n.selectedTemplateId()?25:26),r(9),u(e.hasExistingCertificate?33:34),r(3),u(e.hasExistingCertificate&&e.existingCertificate?36:37)}}function mt(l,t){if(l&1){let e=E();i(0,"div",48)(1,"div",27)(2,"div",89)(3,"div",90)(4,"div",29),s(5,"i",91),i(6,"h6",31),o(7,"Participantes Asistidos"),a()(),p(8,ze,2,1,"span",92),a(),i(9,"div",93)(10,"div",94)(11,"span",55),o(12," Total: "),i(13,"span",95),o(14),a()(),i(15,"span",96),o(16," Disponibles: "),i(17,"span",97),o(18),a()(),i(19,"span",98),o(20," Con certificado: "),i(21,"span",97),o(22),a()()(),i(23,"div",29)(24,"button",99),S("click",function(){C(e);let d=c();return b(d.generateCertificates())}),p(25,Je,2,0)(26,Ke,2,1),a()()()()(),i(27,"div",100)(28,"div",101)(29,"table",102)(30,"thead",103)(31,"tr")(32,"th",104)(33,"div",105)(34,"input",106),S("change",function(){C(e);let d=c();return b(d.toggleSelectAll())}),a(),i(35,"label",107),o(36," Seleccionar todo "),a()()(),i(37,"th",108),o(38,"Participante"),a(),i(39,"th",109),o(40,"Email"),a(),i(41,"th",110),o(42,"Plantilla"),a(),i(43,"th",111),o(44,"Estado"),a(),i(45,"th",111),o(46,"Certificado"),a(),i(47,"th",112),o(48,"Acciones"),a()()(),i(49,"tbody"),R(50,ct,38,14,"tr",113,U().trackByRegistrationId,!0),a()()()()()}if(l&2){let e=c();r(8),u(e.getTotalAttended()>0?8:-1),r(6),_(e.getTotalAttended()),r(4),_(e.getAvailableCount()),r(4),_(e.getExistingCount()),r(2),x("disabled",!e.canGenerate()||e.processingCertificates()||e.getAvailableCount()===0),r(),u(e.processingCertificates()?25:26),r(9),x("checked",e.allSelected())("indeterminate",e.someSelected()),r(16),M(e.attendedRegistrations())}}function pt(l,t){l&1&&(i(0,"div",48)(1,"div",85)(2,"div",146),s(3,"i",147),a(),i(4,"h5",148),o(5,"No hay participantes asistidos"),a(),i(6,"p",88),o(7,' No se encontraron participantes con estado "asistido" para el evento y rol seleccionados. '),a()()())}function ut(l,t){l&1&&(i(0,"div",48)(1,"div",85)(2,"div",149),s(3,"i",150),a(),i(4,"h5",148),o(5,"Seleccione Evento y Rol"),a(),i(6,"p",88),o(7," Elija un evento y un rol de participante para ver los registros disponibles para certificaci\xF3n. "),a()()())}var gt=9,ft=1,be=class l{fb=y(me);destroyRef=y(k);eventService=y(fe);certificateService=y(q);staticDataService=y(ue);confirmModal=N("confirmModal");changeTemplateModal=N("changeTemplateModal");autocompleteConfig=le.autocomplete;loadingState=v("idle");loading=h(()=>this.loadingState()==="loading");processingState=v("idle");processingCertificates=h(()=>this.processingState()==="processing");error=v(null);success=v(null);loadingRegistrations=v(!1);availableEvents=v([]);availableRoles=v([]);certificateTemplatesMap=v(null);registrations=v([]);selectedEvent=v(null);selectedRole=v(null);selectedTemplateId=v(null);selectedCertificateForChange=v(null);templatesWithId=h(()=>{let t=this.certificateTemplatesMap();return t?Object.entries(t).map(([e,n])=>w({id:parseInt(e)},n)):[]});filtersForm=this.fb.group({eventId:this.fb.control(null),participantRoleId:this.fb.control(null),templateId:this.fb.control(null)});eventAutocompleteControl=this.fb.control(null);roleAutocompleteControl=this.fb.control(null);_attendedRegistrationsCache=h(()=>this.registrations().filter(e=>this.isAttendedState(e.currentStateId)));attendedRegistrations=h(()=>this._attendedRegistrationsCache());selectedRegistrations=h(()=>this.attendedRegistrations().filter(e=>e.selected));allSelected=h(()=>{let t=this.attendedRegistrations();return t.length>0&&t.every(e=>e.selected)});someSelected=h(()=>this.attendedRegistrations().some(t=>t.selected)&&!this.allSelected());canGenerate=h(()=>this.selectedRegistrations().length>0&&this.selectedTemplateId()!==null&&this.availableForGeneration().length>0);defaultTemplateId=h(()=>{let t=this.selectedRole(),e=this.selectedEvent();return t?.templateId?t.templateId:e?ft:null});availableForGeneration=h(()=>this.selectedRegistrations().filter(e=>!e.hasExistingCertificate));existingCertificates=h(()=>this.selectedRegistrations().filter(t=>t.hasExistingCertificate));generationSummary=h(()=>{let t=this.attendedRegistrations().length,e=this.existingCertificates().length,n=this.selectedRegistrations().length,d=this.availableForGeneration().length;return{total:t,eligible:d,existing:e,selected:n}});trackByRegistrationId=(t,e)=>e.id;trackByTemplateId=(t,e)=>e.name||t;displayEvent=t=>{if(!t)return"";let e=t.startDate?new Date(t.startDate).toLocaleDateString("es-CO"):"Sin fecha";return`${t.title} (${e})`};searchEvents=(t,e)=>{let n={query:t.trim(),limit:e};return this.eventService.queryEventsForAutocomplete(n)};preloadEvents=()=>this.eventService.preloadEventsForAutocomplete(this.autocompleteConfig.preloadLimit);displayRole=t=>t?`${t.name} - ${t.description}`:"";ngOnInit(){this.loadInitialData(),this.setupSubscriptions()}setupSubscriptions(){this.filtersForm.valueChanges.pipe(X(300),Y(),T(this.destroyRef)).subscribe(()=>{this.onSelectionChange()})}loadInitialData(){return G(this,null,function*(){this.loadingState.set("loading"),this.error.set(null);try{let t=[this.loadEvents(),this.loadRoles(),this.loadCertificateTemplates()];yield Promise.allSettled(t),this.loadingState.set("success")}catch(t){console.error("Error initializing component:",t),this.error.set("Error cargando datos iniciales. Por favor, recargue la p\xE1gina."),this.loadingState.set("error")}})}loadEvents(){return G(this,null,function*(){try{let t=yield K(this.eventService.getEvents(1,100));this.availableEvents.set(t?.items||[])}catch(t){console.error("Error loading events:",t),this.availableEvents.set([])}})}loadRoles(){return G(this,null,function*(){this.staticDataService.participantRoles$.pipe(T(this.destroyRef)).subscribe(t=>{t&&this.availableRoles.set(Object.values(t))})})}loadCertificateTemplates(){this.staticDataService.certificateTemplates$.pipe(T(this.destroyRef)).subscribe({next:t=>{this.certificateTemplatesMap.set(t)},error:t=>{console.error("Error cargando plantillas:",t)}})}onEventSelected(t){this.selectedEvent.set(t),this.filtersForm.patchValue({eventId:t?t.id.toString():null},{emitEvent:!0})}onRoleSelected(t){let n=t.target.value;if(n){let d=this.availableRoles().find(g=>g.name===n),m=this.getRoleId(n);this.selectedRole.set(d||null),d?.templateId&&(this.selectedTemplateId.set(d.templateId),this.filtersForm.patchValue({templateId:d.templateId.toString()},{emitEvent:!1})),this.filtersForm.patchValue({participantRoleId:m.toString()},{emitEvent:!0})}else this.selectedRole.set(null),this.selectedTemplateId.set(null),this.filtersForm.patchValue({participantRoleId:null,templateId:null},{emitEvent:!0})}onTemplateChange(t){let n=t.target.value,d=n?+n:null;this.selectedTemplateId.set(d),this.filtersForm.patchValue({templateId:n||null},{emitEvent:!1})}onSelectionChange(){let t=this.filtersForm.get("eventId")?.value,e=this.filtersForm.get("participantRoleId")?.value;t&&e?this.loadRegistrations(Number(t),Number(e)):this.registrations.set([])}loadRegistrations(t,e){this.loadingRegistrations.set(!0),this.error.set(null),!this.selectedTemplateId()&&this.defaultTemplateId()&&this.selectedTemplateId.set(this.defaultTemplateId());let n={eventId:t,participantRoleId:e,includeWithCertificates:!0};this.certificateService.getEligibleRegistrationsForCertificates(n).pipe(T(this.destroyRef)).subscribe({next:d=>{let m=d.items.map(g=>({id:g.registrationId,eventId:g.eventId,userId:g.userId,participantRoleId:g.participantRoleId,currentStateId:g.currentStateId,registrationDate:g.registrationDate,selected:g.isCheckable,hasExistingCertificate:g.hasCertificate,existingCertificate:g.certificate?{id:g.certificate.id,userId:g.userId,templateId:g.certificate.templateId}:void 0,userInfo:g.user,eventInfo:g.event}));this.registrations.set(m),this.loadingRegistrations.set(!1)},error:d=>{console.error("Error cargando registros elegibles:",d),this.error.set("Error cargando registros: "+d.message),this.registrations.set([]),this.loadingRegistrations.set(!1)}})}toggleSelectAll(){let t=this.allSelected(),e=this.attendedRegistrations(),n=this.registrations().map(d=>D(w({},d),{selected:e.includes(d)?!t:d.selected}));this.registrations.set(n)}toggleRegistration(t){let e=this.registrations().map(n=>n.id===t?D(w({},n),{selected:!n.selected}):n);this.registrations.set(e)}generateCertificates(){let t=this.availableForGeneration(),e=this.selectedTemplateId(),n=this.selectedEvent(),d=this.selectedRole(),m=this.validateCertificateGeneration(t,e,n,d);if(m){this.error.set(m);return}this.processingState.set("processing"),this.error.set(null);let g={eventId:n.id,userIds:t.map(I=>I.userId),templateId:e,participantRoleId:this.getRoleId(d.name)};this.certificateService.generateBulkCertificates(g).pipe(T(this.destroyRef)).subscribe({next:I=>{let ve=I.totalSuccessful||I.successful?.length||0;this.success.set(`Se generaron ${ve} certificados exitosamente`),this.processingState.set("complete"),this.loadRegistrations(n.id,this.getRoleId(d.name)),setTimeout(()=>this.success.set(null),5e3)},error:I=>{this.error.set("Error generando certificados: "+I.message),this.processingState.set("error")}})}validateCertificateGeneration(t,e,n,d){return t.length?e?n?d?null:"No se ha seleccionado un rol de participante":"No se ha seleccionado un evento":"No se ha seleccionado una plantilla de certificado":"No hay registros seleccionados para generar certificados"}formatEventDate(t){return new Date(t).toLocaleDateString("es-PE",{day:"numeric",month:"short",year:"numeric"})}getTemplateName(t){return this.templatesWithId().find(d=>d.id===t)?.name||`Plantilla ${t}`}getDisplayTemplateName(t){return t.hasExistingCertificate&&t.existingCertificate?.templateId?this.getTemplateName(t.existingCertificate.templateId):this.selectedTemplateId()?this.getTemplateName(this.selectedTemplateId()):"-"}getRoleName(t){let e=this.availableRoles(),n=t-1;return e[n]?.name||`Rol ${t}`}hasAnySelected(){return this.someSelected()}getSelectedCount(){return this.selectedRegistrations().length}getTotalAttended(){return this.attendedRegistrations().length}getExistingCount(){return this.existingCertificates().length}getAvailableCount(){return this.availableForGeneration().length}updateCertificateTemplate(t,e){this.selectedCertificateForChange.set(t);let n=this.changeTemplateModal();n&&n.open()}onTemplateChanged(t){this.success.set(`Plantilla cambiada exitosamente a ${t.templateName}`),this.updateCertificateTemplateInTable(t.certificateId,t.newTemplateId)}updateCertificateTemplateInTable(t,e){let d=this.registrations().map(m=>m.hasExistingCertificate&&m.existingCertificate?.id===t?D(w({},m),{existingCertificate:D(w({},m.existingCertificate),{templateId:e})}):m);this.registrations.set(d)}onModalClosed(){}isAttendedState(t){return t===gt}getRoleId(t){let e=this.availableRoles().findIndex(n=>n.name===t);return e===-1?0:e+1}static \u0275fac=function(e){return new(e||l)};static \u0275cmp=V({type:l,selectors:[["app-certificate-generate"]],viewQuery:function(e,n){e&1&&(F(n.confirmModal,Me,5),F(n.changeTemplateModal,De,5)),e&2&&P(2)},decls:74,vars:15,consts:[["confirmModal",""],["changeTemplateModal",""],[1,"container-fluid","py-3"],["title","Confirmar Generaci\xF3n","message","\xBFEst\xE1 seguro de generar los certificados seleccionados?","confirmText","S\xED, Generar"],["aria-label","breadcrumb",1,"mb-3"],[1,"breadcrumb","mb-0","fs-7"],[1,"breadcrumb-item"],["routerLink","/",1,"text-decoration-none","link-primary"],[1,"bi","bi-house-door","me-1"],[1,"d-none","d-sm-inline"],["routerLink","/certificados",1,"text-decoration-none","link-primary"],["aria-current","page",1,"breadcrumb-item","active"],[1,"d-flex","flex-column","flex-md-row","align-items-start","align-items-md-center","justify-content-between","gap-3","mb-4"],[1,"order-1","order-md-0"],[1,"h5","mb-1","fw-semibold","d-flex","align-items-center"],[1,"bi","bi-award","me-2","text-primary"],[1,"badge","bg-primary-subtle","text-primary","ms-2","fs-7"],[1,"text-muted","small","mb-0"],[1,"d-flex","flex-wrap","gap-2","order-0","order-md-1"],["routerLink","/certificados","title","Ver lista de certificados",1,"btn","btn-outline-secondary","btn-sm","d-flex","align-items-center"],[1,"bi","bi-list-ul","me-1"],["routerLink","/verificar-certificado","title","Verificar certificado",1,"btn","btn-outline-info","btn-sm","d-flex","align-items-center"],[1,"bi","bi-shield-check","me-1"],[1,"d-none","d-lg-inline"],["role","alert",1,"alert","alert-success","alert-dismissible","d-flex","align-items-center","mb-3"],["role","alert",1,"alert","alert-danger","alert-dismissible","d-flex","align-items-center","mb-3"],[1,"card","border-0","shadow-sm","mb-4"],[1,"card-header","bg-light","border-bottom","py-3"],[1,"d-flex","align-items-center","gap-3"],[1,"d-flex","align-items-center","gap-2"],[1,"bi","bi-funnel","text-primary","fs-5"],[1,"mb-0","fw-semibold"],[1,"badge","bg-success-subtle","text-success"],[1,"card-body","py-4"],[1,"row","g-3"],[1,"col-12","col-md-6"],[1,"form-label","fw-semibold","small"],[1,"bi","bi-calendar-event","me-1","text-primary"],[1,"text-danger"],[1,"d-flex","align-items-center"],[1,"input-group"],[1,"form-text","text-warning"],[1,"bi","bi-person-badge","me-1","text-primary"],[1,"form-select","bg-light",3,"change","value","disabled"],["value",""],[3,"value"],[1,"form-text","text-success"],[1,"alert","alert-info","mt-4","py-3"],[1,"card","border-0","shadow-sm"],[3,"templateChanged","modalClosed","certificate","templates"],[1,"bi","bi-check-circle-fill","me-2","text-success"],[1,"flex-grow-1"],["type","button","aria-label","Cerrar",1,"btn-close",3,"click"],[1,"bi","bi-exclamation-triangle-fill","me-2","text-danger"],["role","status","aria-hidden","true",1,"spinner-border","spinner-border-sm","me-2"],[1,"text-muted"],[1,"input-group-text","bg-light","border-end-0"],[1,"bi","bi-search","text-muted"],[3,"valueChange","searchFn","preloadFn","displayFn","placeholder","minChars","searchLimit","debounceMs","maxHeight","noResultsMessage","enablePreload","formControl","inputClass","inInputGroup","enableCaching","cacheSize","highlightSearch","loadingMessage"],[1,"bi","bi-exclamation-triangle","me-1"],[1,"bi","bi-check-circle","me-1"],[1,"row","align-items-center","g-3"],[1,"col-md-8"],[1,"alert-heading","mb-2","fw-bold","d-flex","align-items-center"],[1,"bi","bi-info-circle","me-2"],[1,"d-flex","flex-wrap","gap-4","small"],[1,"bi","bi-calendar-range","me-1","text-primary"],[1,"col-md-4","text-md-end"],[1,"badge","bg-info-subtle","text-info","fs-6"],[1,"bi","bi-calendar-check","me-1"],[1,"bi","bi-geo-alt","me-1","text-success"],[1,"card-header","bg-success-subtle","border-bottom","py-3"],[1,"mb-0","fw-semibold","text-success-emphasis","d-flex","align-items-center"],[1,"bi","bi-palette","me-2"],[1,"row","g-3","align-items-end"],[1,"col-12","col-md-8"],[1,"bi","bi-file-earmark-richtext","me-1","text-primary"],[1,"form-select","bg-light",3,"change","value"],[1,"form-text"],[1,"col-12","col-md-4"],[1,"d-flex","flex-column","gap-2"],[1,"bi","bi-person","me-1"],[1,"badge","bg-primary-subtle","text-primary","fs-6"],[1,"bi","bi-award","me-1"],[1,"bi","bi-info-circle","me-1"],[1,"card-body","text-center","py-5"],["role","status",1,"spinner-border","text-primary","mb-3",2,"width","3rem","height","3rem"],[1,"visually-hidden"],[1,"text-muted","mb-0"],[1,"d-flex","flex-column","flex-lg-row","align-items-start","align-items-lg-center","gap-3"],[1,"d-flex","align-items-center","gap-3","flex-grow-1"],[1,"bi","bi-people","text-primary","fs-5"],[1,"badge","bg-info-subtle","text-info"],[1,"d-flex","flex-wrap","align-items-center","gap-3"],[1,"d-flex","align-items-center","gap-3","small"],[1,"fw-medium","text-dark"],[1,"text-success"],[1,"fw-medium"],[1,"text-info"],["type","button",1,"btn","btn-primary",3,"click","disabled"],[1,"card-body","p-0"],[1,"table-responsive"],[1,"table","table-hover","align-middle","mb-0"],[1,"table-light"],["scope","col",1,"border-0",2,"width","50px"],[1,"form-check"],["type","checkbox","id","selectAllTable",1,"form-check-input",3,"change","checked","indeterminate"],["for","selectAllTable",1,"form-check-label","visually-hidden"],["scope","col",1,"fw-semibold","border-0"],["scope","col",1,"fw-semibold","border-0","d-none","d-md-table-cell"],["scope","col",1,"fw-semibold","border-0","d-none","d-lg-table-cell"],["scope","col",1,"fw-semibold","border-0","text-center"],["scope","col",1,"fw-semibold","border-0","text-center",2,"width","120px"],[3,"table-active","bg-light"],[1,"border-0"],[1,"bi","bi-check-circle-fill","text-success"],[1,"avatar","bg-primary-subtle","text-primary","rounded-circle","d-flex","align-items-center","justify-content-center","flex-shrink-0",2,"width","40px","height","40px"],[1,"bi","bi-person-fill"],[1,"overflow-hidden"],[1,"fw-medium","text-truncate"],[1,"text-muted","small","text-truncate","d-md-none"],[1,"d-flex","flex-wrap","gap-1","mt-1","d-lg-none"],[1,"badge","bg-primary-subtle","text-primary","small"],[1,"badge","bg-secondary-subtle","text-secondary","small"],[1,"text-muted","small","text-truncate"],[1,"border-0","d-none","d-md-table-cell"],[1,"text-muted","small"],[1,"border-0","d-none","d-lg-table-cell"],[1,"text-center"],[1,"border-0","text-center"],[1,"badge","bg-warning-subtle","text-warning"],[1,"dropdown"],["type","checkbox",1,"form-check-input",3,"change","id","checked"],[1,"form-check-label","visually-hidden",3,"for"],[1,"bi","bi-file-earmark-text","me-1"],[1,"bi","bi-award-fill","me-1"],[1,"bi","bi-clock","me-1"],["type","button","data-bs-toggle","dropdown","aria-expanded","false","title","Opciones de certificado",1,"btn","btn-outline-secondary","btn-sm","dropdown-toggle",3,"id"],[1,"bi","bi-gear"],[1,"dropdown-menu","dropdown-menu-end"],[1,"dropdown-header","small"],[1,"dropdown-item-text","small","text-muted"],[1,"dropdown-divider"],["type","button","title","Cambiar plantilla del certificado",1,"dropdown-item","small",3,"click"],[1,"bi","bi-pencil","me-2"],[1,"bi","bi-dash"],[1,"text-muted","mb-4"],[1,"bi","bi-person-x","display-1","opacity-25"],[1,"text-muted","mb-2"],[1,"text-primary","mb-4"],[1,"bi","bi-award","display-1","opacity-25"]],template:function(e,n){if(e&1){let d=E();i(0,"div",2),s(1,"app-confirm-modal",3,0),i(3,"nav",4)(4,"ol",5)(5,"li",6)(6,"a",7),s(7,"i",8),i(8,"span",9),o(9,"Inicio"),a()()(),i(10,"li",6)(11,"a",10),o(12,"Certificados"),a()(),i(13,"li",11),o(14,"Generar"),a()()(),i(15,"div",12)(16,"div",13)(17,"h1",14),s(18,"i",15),i(19,"span"),o(20,"Generaci\xF3n de Certificados"),a(),p(21,Ne,2,1,"span",16),a(),i(22,"p",17),o(23,"Generar certificados masivos para participantes que asistieron a eventos"),a()(),i(24,"div",18)(25,"button",19),s(26,"i",20),i(27,"span",9),o(28,"Ver Certificados"),a()(),i(29,"button",21),s(30,"i",22),i(31,"span",23),o(32,"Verificar"),a()()()(),p(33,Ge,5,1,"div",24),p(34,ke,5,1,"div",25),i(35,"div",26)(36,"div",27)(37,"div",28)(38,"div",29),s(39,"i",30),i(40,"h6",31),o(41,"Selecci\xF3n de Evento y Rol"),a()(),p(42,Ve,2,0,"span",32),a()(),i(43,"div",33)(44,"div",34)(45,"div",35)(46,"label",36),s(47,"i",37),o(48," Evento "),i(49,"span",38),o(50,"*"),a()(),p(51,Pe,4,0,"div",39)(52,Ae,4,17,"div",40),p(53,Le,3,0,"div",41),a(),i(54,"div",35)(55,"label",36),s(56,"i",42),o(57," Rol de Participante "),i(58,"span",38),o(59,"*"),a()(),i(60,"select",43),S("change",function(g){return C(d),b(n.onRoleSelected(g))}),i(61,"option",44),o(62,"Seleccionar rol..."),a(),R(63,$e,2,3,"option",45,Fe),a(),p(65,Qe,3,1,"div",46),a()(),p(66,Oe,16,4,"div",47),a(),p(67,He,25,4,"div",26),p(68,Ue,7,0,"div",48)(69,mt,52,8,"div",48)(70,pt,8,0,"div",48),p(71,ut,8,0,"div",48),a(),i(72,"app-change-template-modal",49,1),S("templateChanged",function(g){return C(d),b(n.onTemplateChanged(g))})("modalClosed",function(){return C(d),b(n.onModalClosed())}),a()()}if(e&2){let d;r(21),u(n.getTotalAttended()>0?21:-1),r(12),u(n.success()?33:-1),r(),u(n.error()?34:-1),r(8),u(n.selectedEvent()&&n.selectedRole()?42:-1),r(9),u(n.loading()?51:52),r(2),u(n.availableEvents().length===0&&!n.loading()?53:-1),r(7),x("value",((d=n.selectedRole())==null?null:d.name)||"")("disabled",!n.selectedEvent()||n.loading()),r(3),M(n.availableRoles()),r(2),u(n.selectedRole()?65:-1),r(),u(n.selectedEvent()?66:-1),r(),u(n.selectedEvent()&&n.selectedRole()?67:-1),r(),u(n.loadingRegistrations()?68:n.attendedRegistrations().length>0?69:n.selectedEvent()&&n.selectedRole()&&!n.loadingRegistrations()?70:-1),r(3),u(!n.selectedEvent()||!n.selectedRole()?71:-1),r(),x("certificate",n.selectedCertificateForChange())("templates",n.templatesWithId())}},dependencies:[Q,pe,W,O,B,se,j,ae,ne,Ce,ge,H],encapsulation:2,changeDetection:0})};export{be as CertificateGenerateComponent};
