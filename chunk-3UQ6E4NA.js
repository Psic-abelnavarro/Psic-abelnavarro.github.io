import{a as D,b as A}from"./chunk-VF5TSERA.js";import{d as v}from"./chunk-YUNYRAF7.js";import{b as S}from"./chunk-TO7S5C7C.js";import{$b as u,V as g,_ as h,ma as P,o as m}from"./chunk-6O7NOF42.js";import{a as p,f as y,h as c}from"./chunk-FK42CRUA.js";var R=y(A());var o={PDF:{FORMAT:"a4",ORIENTATION:"landscape",DIMENSIONS:{width:297,height:210},QUALITY:.9,MULTIPLIER:2},CANVAS:{DEFAULT_SIZE:{width:800,height:600},BACKGROUND_COLOR:"#ffffff"},QR_CODE:{SIZE:150,MARGIN:2,COLORS:{dark:"#000000",light:"#ffffff"}},PROCESSING:{FORMATS:{output:"jpeg"},TIMEOUT:1e4,RETRY_ATTEMPTS:3}};var C=class l{_generationProgress=P({status:"idle",step:"Ready",progress:0});generationProgress=this._generationProgress.asReadonly();isGenerating=u(()=>this._generationProgress().status==="processing");isSuccess=u(()=>this._generationProgress().status==="success");hasError=u(()=>this._generationProgress().status==="error");certificateService=h(S);generarPDFDesdeTemplate(n,a){return c(this,arguments,function*(e,r,t={}){try{this.updateProgress("processing","Initializing PDF generation...",10);let i=this.buildPDFConfiguration(t);this.updateProgress("processing","Processing template variables...",25);let s=yield this.processTemplateVariables(e,r);this.updateProgress("processing","Creating canvas...",50);let d=yield this.createTemporaryCanvas(s);this.updateProgress("processing","Generating PDF...",75);let f=yield this.generatePDFBlob(d,i);return this.updateProgress("processing","Preparing download...",90),this.downloadFile(f,`${i.nombreArchivo}.pdf`),d.dispose(),this.updateProgress("success","PDF generated successfully",100,`${i.nombreArchivo}.pdf`),this.createSuccessResult(`${i.nombreArchivo}.pdf`)}catch(i){return this.updateProgress("error","PDF generation failed",0,void 0,String(i)),this.createErrorResult("PDF generation failed",i)}})}generarCertificadoPDFConDTO(n,a){return c(this,arguments,function*(e,r,t={}){let i=p({},r);return this.generarPDFDesdeTemplate(e,i,t)})}generarCertificadoPDFPorCodigo(n,a){return c(this,arguments,function*(e,r,t={}){try{this.updateProgress("processing","Fetching certificate data...",5);let i=yield m(this.certificateService.getCertificateTemplateData(r));if(!i)return this.updateProgress("error","Certificate not found",0,void 0,`No certificate found for code: ${r}`),this.createErrorResult("Certificate data not found",new Error(`No certificate found for code: ${r}`));this.updateProgress("processing","Processing certificate data...",15);let s=this.transformarDatosParaTemplate(i);return this.generarCertificadoPDFConDTO(e,s,t)}catch(i){return this.updateProgress("error","Certificate data retrieval failed",0,void 0,String(i)),this.createErrorResult("Certificate data retrieval failed",i)}})}transformarDatosParaTemplate(e){let r=this.extractCertificateInfo(e),t=this.extractParticipantInfo(e),n=this.extractEventInfo(e),a=this.extractRoleInfo(e),i=this.buildVerificationInfo(r.shortCode);return{certificateNumber:r.number,shortCode:r.shortCode,issueDate:r.issueDate,eventTitle:n.title,participantName:t.fullName,participantDocument:t.documentInfo,participantEmail:t.email,participantInstitution:t.institution,eventStartDate:n.startDate,eventEndDate:n.endDate,eventDuration:n.durationText,eventLocation:n.location,eventCity:n.city,roleName:a.name,certificateTitle:a.certificateTitle,roleDescription:a.description,attendancePercentage:t.attendancePercentage,attendanceInfo:t.attendanceInfo,approvalStatus:t.approvalStatus,attendanceStatus:t.attendanceStatus,minimumAttendanceRequired:n.minimumAttendance,verificationUrl:i.url,qrCodeData:i.qrData,qrurl:i.url,qrcode:i.qrData,"qr-code":i.qrData,currentDate:this.formatDateForDisplay(new Date().toISOString()),validUntil:r.expirationDate||void 0,organizationName:"Organizaci\xF3n Emisora",signatoryName:void 0,signatoryTitle:void 0}}extractCertificateInfo(e){return{number:e.certificate_number||"",shortCode:e.short_code||"",issueDate:this.formatDateForDisplay(e.issue_date),expirationDate:e.expires_date?this.formatDateForDisplay(e.expires_date):null,isValid:e.is_valid||!1}}extractParticipantInfo(e){return{fullName:e.participant_name||"",email:e.participant_email||"",documentInfo:this.formatParticipantDocumentInfo(e.document_type,e.document_number),institution:e.participant_institution||"",attendancePercentage:e.attendance_percentage||0,attendanceVerified:e.attendance_verified||!1,attendanceInfo:this.formatAttendanceInfo(e.attendance_percentage||0,e.minimum_attendance_percentage||80,e.attendance_verified||!1),approvalStatus:this.formatApprovalStatus(e.attendance_percentage||0,e.minimum_attendance_percentage||80,e.registration_state||""),attendanceStatus:this.calculateAttendanceStatus(e.attendance_percentage||0,e.minimum_attendance_percentage||80)}}extractEventInfo(e){return{title:e.event_title||"",startDate:this.formatDateForDisplay(e.event_start_date),endDate:this.formatDateForDisplay(e.event_end_date),durationText:this.formatDurationText(e.duration_hours),location:this.formatVenueLocation(e.venue_name,e.venue_city),city:e.venue_city||"",minimumAttendance:e.minimum_attendance_percentage||80}}extractRoleInfo(e){return{name:e.role_name||"Participante",certificateTitle:e.role_certificate_title||"Certificado de Participaci\xF3n",description:e.role_description||"",textTemplate:e.role_certificate_text_template||"Por su participaci\xF3n en el evento"}}buildVerificationInfo(e){return{url:`${window.location.origin}/verificar/${e}`,qrData:e}}formatDateForDisplay(e){return e?new Date(e).toLocaleDateString("es-ES",{day:"2-digit",month:"long",year:"numeric"}):""}formatDurationText(e){return e?e===1?"1 hora acad\xE9mica":`${e} horas acad\xE9micas`:""}formatVenueLocation(e,r){let t=e||"",n=r||"";return t&&n?`${t}, ${n}`:t||n||""}formatParticipantDocumentInfo(e,r){return r?`${e}: ${r}`:""}formatAttendanceInfo(e,r,t){if(e===0)return"Pendiente de verificaci\xF3n";let n=e>=r?"Aprobado":"No aprobado";return`${e}% (${n}, ${t?"verificado":"pendiente"})`}formatApprovalStatus(e,r,t){return t.toLowerCase().includes("asisti\xF3")||t.toLowerCase().includes("attended")?e>=r?"APROBADO":"PENDIENTE DE APROBACI\xD3N":t.toUpperCase()}calculateAttendanceStatus(e,r){return e===0?"pending":e>=r?"approved":"failed"}buildPDFConfiguration(e){return{formato:e.formato||"A4",orientacion:e.orientacion||"landscape",calidad:e.calidad||o.PDF.QUALITY,nombreArchivo:e.nombreArchivo||`certificado-${Date.now()}`}}processTemplateVariables(e,r){return c(this,null,function*(){let t=JSON.stringify(e);return t=yield this.processQRVariables(t,r),Object.entries(r).forEach(([n,a])=>{let i=new RegExp(`{{\\s*${n}\\s*}}`,"g"),s=this.formatValue(a);t=t.replace(i,s)}),JSON.parse(t)})}formatValue(e){return e==null?"":e instanceof Date?e.toLocaleDateString("es-ES"):typeof e=="boolean"?e?"S\xED":"No":typeof e=="number"?e.toString():String(e)}processQRVariables(e,r){return c(this,null,function*(){let t=JSON.parse(e),n=a=>c(this,null,function*(){if(Array.isArray(a))for(let i=0;i<a.length;i++)a[i]=yield n(a[i]);else if(a&&typeof a=="object"){a.type==="Group"&&a.objects&&Array.isArray(a.objects)&&this.groupContainsQRCode(a.objects)&&(yield this.processQRGroupObjects(a.objects,r));for(let i in a)a.hasOwnProperty(i)&&(a[i]=yield n(a[i]))}return a});return t=yield n(t),JSON.stringify(t)})}groupContainsQRCode(e){return e.some(r=>r.type==="IText"&&typeof r.text=="string"&&r.text.includes("{{qr-code}}"))}processQRGroupObjects(e,r){return c(this,null,function*(){for(let t of e){if(t.type==="Image"&&r.qrurl)try{let n=yield this.generateQRBase64(String(r.qrurl));t.src=n}catch(n){console.error("Error generating QR image",n)}t.type==="IText"&&typeof t.text=="string"&&t.text.includes("{{qr-code}}")&&r.qrcode&&(t.text=t.text.replace(/\{\{qr-code\}\}/g,String(r.qrcode)))}})}generateQRBase64(e){return c(this,null,function*(){try{return yield R.toDataURL(e,{width:o.QR_CODE.SIZE,margin:o.QR_CODE.MARGIN,color:o.QR_CODE.COLORS})}catch{return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="}})}createTemporaryCanvas(e){return c(this,null,function*(){let{canvasData:r,dimensions:t}=this.extractCanvasData(e),n=document.createElement("canvas");n.width=t.width,n.height=t.height;let a=new v(n,{width:t.width,height:t.height,backgroundColor:r.backgroundColor||o.CANVAS.BACKGROUND_COLOR});return new Promise((i,s)=>{let d=setTimeout(()=>{s(new Error(`Canvas loadFromJSON timeout after ${o.PROCESSING.TIMEOUT/1e3} seconds`))},o.PROCESSING.TIMEOUT);a.loadFromJSON(r).then(()=>{clearTimeout(d),a.renderAll(),i(a)}).catch(f=>{clearTimeout(d),s(new Error(`Canvas loading failed: ${f.message}`))})})})}extractCanvasData(e){let r=e,t={width:o.CANVAS.DEFAULT_SIZE.width,height:o.CANVAS.DEFAULT_SIZE.height};return e.canvasData?(r=e.canvasData,e.dimensionesVisuales?t=e.dimensionesVisuales:e.canvasProperties&&(t={width:e.canvasProperties.width,height:e.canvasProperties.height})):e.dimensions&&(t=e.dimensions),{canvasData:r,dimensions:t}}generatePDFBlob(e,r){return c(this,null,function*(){let t=e.width||o.CANVAS.DEFAULT_SIZE.width,n=e.height||o.CANVAS.DEFAULT_SIZE.height,a=new D({orientation:r.orientacion,unit:"mm",format:r.formato.toLowerCase()}),i=e.toDataURL({format:o.PROCESSING.FORMATS.output,quality:r.calidad,multiplier:o.PDF.MULTIPLIER}),s=o.PDF.DIMENSIONS;return a.addImage(i,"JPEG",0,0,s.width,s.height),a.output("blob")})}downloadFile(e,r){let t=URL.createObjectURL(e),n=document.createElement("a");try{n.href=t,n.download=r,n.style.display="none",document.body.appendChild(n),n.click()}finally{document.body.removeChild(n),URL.revokeObjectURL(t)}}createSuccessResult(e){return{success:!0,message:"Operation completed successfully",fileName:e}}createErrorResult(e,r){return{success:!1,message:e,error:r}}updateProgress(e,r,t,n,a){this._generationProgress.set({status:e,step:r,progress:t,fileName:n,error:a})}static \u0275fac=function(r){return new(r||l)};static \u0275prov=g({token:l,factory:l.\u0275fac,providedIn:"root"})};export{C as a};
