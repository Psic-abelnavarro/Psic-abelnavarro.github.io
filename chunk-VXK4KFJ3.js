import{d as v,n as D,o as A}from"./chunk-PLLGRK62.js";import{b as S}from"./chunk-BWDGGP5N.js";import{V as g,_ as h,ac as u,ma as P,o as m}from"./chunk-DCXCOY7M.js";import{a as f,f as y,h as c}from"./chunk-FK42CRUA.js";var R=y(A());var o={PDF:{FORMAT:"a4",ORIENTATION:"landscape",DIMENSIONS:{width:297,height:210},QUALITY:.9,MULTIPLIER:2},CANVAS:{DEFAULT_SIZE:{width:800,height:600},BACKGROUND_COLOR:"#ffffff"},QR_CODE:{SIZE:150,MARGIN:2,COLORS:{dark:"#000000",light:"#ffffff"}},PROCESSING:{FORMATS:{output:"jpeg"},TIMEOUT:1e4,RETRY_ATTEMPTS:3}};var C=class l{_generationProgress=P({status:"idle",step:"Ready",progress:0});generationProgress=this._generationProgress.asReadonly();isGenerating=u(()=>this._generationProgress().status==="processing");isSuccess=u(()=>this._generationProgress().status==="success");hasError=u(()=>this._generationProgress().status==="error");certificateService=h(S);generarPDFDesdeTemplate(n,a){return c(this,arguments,function*(e,t,r={}){try{this.updateProgress("processing","Initializing PDF generation...",10);let i=this.buildPDFConfiguration(r);this.updateProgress("processing","Processing template variables...",25);let s=yield this.processTemplateVariables(e,t);this.updateProgress("processing","Creating canvas...",50);let d=yield this.createTemporaryCanvas(s);this.updateProgress("processing","Generating PDF...",75);let p=yield this.generatePDFBlob(d,i);return this.updateProgress("processing","Preparing download...",90),this.downloadFile(p,`${i.nombreArchivo}.pdf`),d.dispose(),this.updateProgress("success","PDF generated successfully",100,`${i.nombreArchivo}.pdf`),this.createSuccessResult(`${i.nombreArchivo}.pdf`)}catch(i){return this.updateProgress("error","PDF generation failed",0,void 0,String(i)),this.createErrorResult("PDF generation failed",i)}})}generarCertificadoPDFConDTO(n,a){return c(this,arguments,function*(e,t,r={}){let i=f({},t);return this.generarPDFDesdeTemplate(e,i,r)})}generarCertificadoPDFPorCodigo(n,a){return c(this,arguments,function*(e,t,r={}){try{this.updateProgress("processing","Fetching certificate data...",5);let i=yield m(this.certificateService.getCertificateTemplateData(t));if(!i)return this.updateProgress("error","Certificate not found",0,void 0,`No certificate found for code: ${t}`),this.createErrorResult("Certificate data not found",new Error(`No certificate found for code: ${t}`));this.updateProgress("processing","Processing certificate data...",15);let s=this.transformarDatosParaTemplate(i);return this.generarCertificadoPDFConDTO(e,s,r)}catch(i){return this.updateProgress("error","Certificate data retrieval failed",0,void 0,String(i)),this.createErrorResult("Certificate data retrieval failed",i)}})}transformarDatosParaTemplate(e){let t=this.extractCertificateInfo(e),r=this.extractParticipantInfo(e),n=this.extractEventInfo(e),a=this.extractRoleInfo(e),i=this.buildVerificationInfo(t.shortCode);return{certificateNumber:t.number,shortCode:t.shortCode,issueDate:t.issueDate,eventTitle:n.title,participantName:r.fullName,participantDocument:r.documentInfo,participantEmail:r.email,participantInstitution:r.institution,eventStartDate:n.startDate,eventEndDate:n.endDate,eventDuration:n.durationText,eventLocation:n.location,eventCity:n.city,eventDescription:n.shortDescription,roleName:a.name,certificateTitle:a.certificateTitle,roleDescription:a.textTemplate,attendancePercentage:r.attendancePercentage,attendanceInfo:r.attendanceInfo,approvalStatus:r.approvalStatus,attendanceStatus:r.attendanceStatus,minimumAttendanceRequired:n.minimumAttendance,verificationUrl:i.url,qrCodeData:i.qrData,qrUrl:i.url,qrCode:t.number,currentDate:this.formatDateForDisplay(new Date().toISOString()),validUntil:t.expirationDate||void 0,organizationName:"Organizaci\xF3n Emisora",signatoryName:void 0,signatoryTitle:void 0}}extractCertificateInfo(e){return{number:e.certificate_number||"",shortCode:e.short_code||"",issueDate:this.formatDateForDisplay(e.issue_date),expirationDate:e.expires_date?this.formatDateForDisplay(e.expires_date):null,isValid:e.is_valid||!1}}extractParticipantInfo(e){return{fullName:e.participant_name||"",email:e.participant_email||"",documentInfo:this.formatParticipantDocumentInfo(e.document_type,e.document_number),institution:e.participant_institution||"",attendancePercentage:e.attendance_percentage||0,attendanceVerified:e.attendance_verified||!1,attendanceInfo:this.formatAttendanceInfo(e.attendance_percentage||0,e.minimum_attendance_percentage||80,e.attendance_verified||!1),approvalStatus:this.formatApprovalStatus(e.attendance_percentage||0,e.minimum_attendance_percentage||80,e.registration_state||""),attendanceStatus:this.calculateAttendanceStatus(e.attendance_percentage||0,e.minimum_attendance_percentage||80)}}extractEventInfo(e){return console.log(e),{title:e.event_title||"",shortDescription:e.short_description||"",startDate:this.formatDateForDisplay(e.event_start_date),endDate:this.formatDateForDisplay(e.event_end_date),durationText:this.formatDurationText(e.duration_hours),location:this.formatVenueLocation(e.venue_name,e.venue_city),city:e.venue_city||"",minimumAttendance:e.minimum_attendance_percentage||80}}extractRoleInfo(e){return{name:e.role_name||"Participante",certificateTitle:e.role_certificate_title||"Certificado de Participaci\xF3n",description:e.role_description||"",textTemplate:e.role_certificate_text_template||"Por su participaci\xF3n en el evento"}}buildVerificationInfo(e){return{url:`${window.location.origin}/verificar/${e}`,qrData:e}}formatDateForDisplay(e){return e?new Date(e).toLocaleDateString("es-ES",{day:"2-digit",month:"long",year:"numeric"}):""}formatDurationText(e){return e?e===1?"1 hora acad\xE9mica":`${e} horas acad\xE9micas`:""}formatVenueLocation(e,t){let r=e||"",n=t||"";return r&&n?`${r}, ${n}`:r||n||""}formatParticipantDocumentInfo(e,t){return t?`${e}: ${t}`:""}formatAttendanceInfo(e,t,r){if(e===0)return"Pendiente de verificaci\xF3n";let n=e>=t?"Aprobado":"No aprobado";return`${e}% (${n}, ${r?"verificado":"pendiente"})`}formatApprovalStatus(e,t,r){return r.toLowerCase().includes("asisti\xF3")||r.toLowerCase().includes("attended")?e>=t?"APROBADO":"PENDIENTE DE APROBACI\xD3N":r.toUpperCase()}calculateAttendanceStatus(e,t){return e===0?"pending":e>=t?"approved":"failed"}buildPDFConfiguration(e){return{formato:e.formato||"A4",orientacion:e.orientacion||"landscape",calidad:e.calidad||o.PDF.QUALITY,nombreArchivo:e.nombreArchivo||`certificado-${Date.now()}`}}processTemplateVariables(e,t){return c(this,null,function*(){let r=JSON.stringify(e);return r=yield this.processQRVariables(r,t),Object.entries(t).forEach(([n,a])=>{let i=new RegExp(`{{\\s*${n}\\s*}}`,"g"),s=this.formatValue(a);r=r.replace(i,s)}),JSON.parse(r)})}formatValue(e){return e==null?"":e instanceof Date?e.toLocaleDateString("es-ES"):typeof e=="boolean"?e?"S\xED":"No":typeof e=="number"?e.toString():String(e)}processQRVariables(e,t){return c(this,null,function*(){let r=JSON.parse(e),n=a=>c(this,null,function*(){if(Array.isArray(a))for(let i=0;i<a.length;i++)a[i]=yield n(a[i]);else if(a&&typeof a=="object"){a.type==="Group"&&a.objects&&Array.isArray(a.objects)&&this.groupContainsQRCode(a.objects)&&(yield this.processQRGroupObjects(a.objects,t));for(let i in a)a.hasOwnProperty(i)&&(a[i]=yield n(a[i]))}return a});return r=yield n(r),JSON.stringify(r)})}groupContainsQRCode(e){return e.some(t=>t.type==="IText"&&typeof t.text=="string"&&t.text.includes("{{qrCode}}"))}processQRGroupObjects(e,t){return c(this,null,function*(){for(let r of e)if(r.type==="Image"&&t.qrUrl)try{let n=yield this.generateQRBase64(String(t.qrUrl));r.src=n}catch(n){console.error("Error generating QR image",n)}})}generateQRBase64(e){return c(this,null,function*(){try{return yield R.toDataURL(e,{width:o.QR_CODE.SIZE,margin:o.QR_CODE.MARGIN,color:o.QR_CODE.COLORS})}catch{return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="}})}createTemporaryCanvas(e){return c(this,null,function*(){let{canvasData:t,dimensions:r}=this.extractCanvasData(e),n=document.createElement("canvas");n.width=r.width,n.height=r.height;let a=new v(n,{width:r.width,height:r.height,backgroundColor:t.backgroundColor||o.CANVAS.BACKGROUND_COLOR});return new Promise((i,s)=>{let d=setTimeout(()=>{s(new Error(`Canvas loadFromJSON timeout after ${o.PROCESSING.TIMEOUT/1e3} seconds`))},o.PROCESSING.TIMEOUT);a.loadFromJSON(t).then(()=>{clearTimeout(d),a.renderAll(),i(a)}).catch(p=>{clearTimeout(d),s(new Error(`Canvas loading failed: ${p.message}`))})})})}extractCanvasData(e){let t=e,r={width:o.CANVAS.DEFAULT_SIZE.width,height:o.CANVAS.DEFAULT_SIZE.height};return e.canvasData?(t=e.canvasData,e.dimensionesVisuales?r=e.dimensionesVisuales:e.canvasProperties&&(r={width:e.canvasProperties.width,height:e.canvasProperties.height})):e.dimensions&&(r=e.dimensions),{canvasData:t,dimensions:r}}generatePDFBlob(e,t){return c(this,null,function*(){let r=e.width||o.CANVAS.DEFAULT_SIZE.width,n=e.height||o.CANVAS.DEFAULT_SIZE.height,a=new D({orientation:t.orientacion,unit:"mm",format:t.formato.toLowerCase()}),i=e.toDataURL({format:o.PROCESSING.FORMATS.output,quality:t.calidad,multiplier:o.PDF.MULTIPLIER}),s=o.PDF.DIMENSIONS;return a.addImage(i,"JPEG",0,0,s.width,s.height),a.output("blob")})}downloadFile(e,t){let r=URL.createObjectURL(e),n=document.createElement("a");try{n.href=r,n.download=t,n.style.display="none",document.body.appendChild(n),n.click()}finally{document.body.removeChild(n),URL.revokeObjectURL(r)}}createSuccessResult(e){return{success:!0,message:"Operation completed successfully",fileName:e}}createErrorResult(e,t){return{success:!1,message:e,error:t}}updateProgress(e,t,r,n,a){this._generationProgress.set({status:e,step:t,progress:r,fileName:n,error:a})}static \u0275fac=function(t){return new(t||l)};static \u0275prov=g({token:l,factory:l.\u0275fac,providedIn:"root"})};export{C as a};
